


<!DOCTYPE html>
<html id="htmlId">
<head>
  <meta http-equiv="Content-Type" content="text/html;charset=UTF-8"> 
  <title>Coverage Report > JStyleGetNumCitationMarker</title>
  <style type="text/css">
    @import "../../css/coverage.css";
    @import "../../css/idea.min.css";
  </style>
  <script type="text/javascript" src="../../js/highlight.min.js"></script>
  <script type="text/javascript" src="../../js/highlightjs-line-numbers.min.js"></script>
</head>

<body>
<div class="content">
<div class="breadCrumbs">
Current scope:     <a href="../../index.html">all classes</a>
    <span class="separator">|</span>
    <a href="../index.html">org.jabref.logic.openoffice.style</a>
</div>

<h1>Coverage Summary for Class: JStyleGetNumCitationMarker (org.jabref.logic.openoffice.style)</h1>

<table class="coverageStats">
<tr>
  <th class="name">Class</th>
<th class="coverageStat 
">
  Class, %
</th>
<th class="coverageStat 
">
  Method, %
</th>
<th class="coverageStat 
">
  Branch, %
</th>
<th class="coverageStat 
">
  Line, %
</th>
</tr>
<tr>
  <td class="name">JStyleGetNumCitationMarker</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/4)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/64)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/93)
  </span>
</td>
</tr>

</table>

<br/>
<br/>


<pre>
<code class="sourceCode" id="sourceCode">&nbsp;package org.jabref.logic.openoffice.style;
&nbsp;
&nbsp;import java.util.ArrayList;
&nbsp;import java.util.List;
&nbsp;import java.util.Optional;
&nbsp;
&nbsp;import org.jabref.model.openoffice.ootext.OOText;
&nbsp;import org.jabref.model.openoffice.style.CitationMarkerNumericBibEntry;
&nbsp;import org.jabref.model.openoffice.style.CitationMarkerNumericEntry;
&nbsp;import org.jabref.model.openoffice.style.PageInfo;
&nbsp;import org.jabref.model.openoffice.util.OOListUtil;
&nbsp;
&nbsp;class JStyleGetNumCitationMarker {
&nbsp;
&nbsp;    // The number encoding &quot;this entry is unresolved&quot;
&nbsp;    public final static int UNRESOLVED_ENTRY_NUMBER = 0;
&nbsp;
&nbsp;    private JStyleGetNumCitationMarker() {
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * Defines sort order for CitationMarkerNumericEntry.
&nbsp;     */
&nbsp;    private static int compareCitationMarkerNumericEntry(CitationMarkerNumericEntry a,
&nbsp;                                                         CitationMarkerNumericEntry b) {
<b class="nc">&nbsp;        int na = a.getNumber().orElse(UNRESOLVED_ENTRY_NUMBER);</b>
<b class="nc">&nbsp;        int nb = b.getNumber().orElse(UNRESOLVED_ENTRY_NUMBER);</b>
<b class="nc">&nbsp;        int res = Integer.compare(na, nb);</b>
<b class="nc">&nbsp;        if (res == 0) {</b>
<b class="nc">&nbsp;            res = PageInfo.comparePageInfo(a.getPageInfo(), b.getPageInfo());</b>
&nbsp;        }
<b class="nc">&nbsp;        return res;</b>
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * Create a numeric marker for use in the bibliography as label for the entry.
&nbsp;     * &lt;p&gt;
&nbsp;     * To support for example numbers in superscript without brackets for the text,
&nbsp;     * but &quot;[1]&quot; form for the bibliography, the style can provide
&nbsp;     * the optional &quot;BracketBeforeInList&quot; and &quot;BracketAfterInList&quot; strings
&nbsp;     * to be used in the bibliography instead of &quot;BracketBefore&quot; and &quot;BracketAfter&quot;
&nbsp;     *
&nbsp;     * @return &quot;[${number}]&quot; where
&nbsp;     * &quot;[&quot; stands for BRACKET_BEFORE_IN_LIST (with fallback BRACKET_BEFORE)
&nbsp;     * &quot;]&quot; stands for BRACKET_AFTER_IN_LIST (with fallback BRACKET_AFTER)
&nbsp;     * &quot;${number}&quot; stands for the formatted number.
&nbsp;     */
&nbsp;    public static OOText getNumCitationMarkerForBibliography(JStyle style,
&nbsp;                                                             CitationMarkerNumericBibEntry entry) {
&nbsp;        // prefer BRACKET_BEFORE_IN_LIST and BRACKET_AFTER_IN_LIST
<b class="nc">&nbsp;        String bracketBefore = style.getBracketBeforeInListWithFallBack();</b>
<b class="nc">&nbsp;        String bracketAfter = style.getBracketAfterInListWithFallBack();</b>
<b class="nc">&nbsp;        StringBuilder stringBuilder = new StringBuilder();</b>
<b class="nc">&nbsp;        stringBuilder.append(style.getCitationGroupMarkupBefore());</b>
<b class="nc">&nbsp;        stringBuilder.append(bracketBefore);</b>
<b class="nc">&nbsp;        final Optional&lt;Integer&gt; current = entry.getNumber();</b>
<b class="nc">&nbsp;        stringBuilder.append(current.isPresent()</b>
<b class="nc">&nbsp;                             ? String.valueOf(current.get())</b>
<b class="nc">&nbsp;                             : (JStyle.UNDEFINED_CITATION_MARKER + entry.getCitationKey()));</b>
<b class="nc">&nbsp;        stringBuilder.append(bracketAfter);</b>
<b class="nc">&nbsp;        stringBuilder.append(style.getCitationGroupMarkupAfter());</b>
<b class="nc">&nbsp;        return OOText.fromString(stringBuilder.toString());</b>
&nbsp;    }
&nbsp;
&nbsp;    /*
&nbsp;     * emitBlock : a helper for getNumCitationMarker2
&nbsp;     *
&nbsp;     * Given a block containing either a single entry or two or more
&nbsp;     * entries that are joinable into an &quot;i-j&quot; form, append to {@code stringBuilder} the
&nbsp;     * formatted text.
&nbsp;     *
&nbsp;     * Assumes:
&nbsp;     *
&nbsp;     * - block is not empty
&nbsp;     *
&nbsp;     * - For a block with a single element the element may have
&nbsp;     *    pageInfo and its num part may be Optional.empty()
&nbsp;     *
&nbsp;     * - For a block with two or more elements
&nbsp;     *
&nbsp;     *   - The elements do not have pageInfo and their number part is
&nbsp;     *     not empty.
&nbsp;     *
&nbsp;     *   - The elements number parts are consecutive positive integers,
&nbsp;     *     without repetition.
&nbsp;     *
&nbsp;     */
&nbsp;    private static void emitBlock(List&lt;CitationMarkerNumericEntry&gt; block,
&nbsp;                                  JStyle style,
&nbsp;                                  int minGroupingCount,
&nbsp;                                  StringBuilder stringBuilder) {
&nbsp;
<b class="nc">&nbsp;        final int blockSize = block.size();</b>
<b class="nc">&nbsp;        if (blockSize == 0) {</b>
<b class="nc">&nbsp;            throw new IllegalArgumentException(&quot;The block is empty&quot;);</b>
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        if (blockSize == 1) {</b>
&nbsp;            // Add single entry:
<b class="nc">&nbsp;            CitationMarkerNumericEntry entry = block.getFirst();</b>
<b class="nc">&nbsp;            final Optional&lt;Integer&gt; num = entry.getNumber();</b>
<b class="nc">&nbsp;            stringBuilder.append(num.isEmpty()</b>
<b class="nc">&nbsp;                                 ? (JStyle.UNDEFINED_CITATION_MARKER + entry.getCitationKey())</b>
<b class="nc">&nbsp;                                 : String.valueOf(num.get()));</b>
&nbsp;            // Emit pageInfo
<b class="nc">&nbsp;            Optional&lt;OOText&gt; pageInfo = entry.getPageInfo();</b>
<b class="nc">&nbsp;            if (pageInfo.isPresent()) {</b>
<b class="nc">&nbsp;                stringBuilder.append(style.getPageInfoSeparator());</b>
<b class="nc">&nbsp;                stringBuilder.append(OOText.toString(pageInfo.get()));</b>
&nbsp;            }
&nbsp;            return;
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        if (blockSize &gt;= 2) {</b>
&nbsp;            /*
&nbsp;             * Check assumptions
&nbsp;             */
&nbsp;
<b class="nc">&nbsp;            if (block.stream().anyMatch(x -&gt; x.getPageInfo().isPresent())) {</b>
<b class="nc">&nbsp;                throw new IllegalArgumentException(&quot;Found pageInfo in a block with more than one elements&quot;);</b>
&nbsp;            }
&nbsp;
<b class="nc">&nbsp;            if (block.stream().anyMatch(x -&gt; x.getNumber().isEmpty())) {</b>
<b class="nc">&nbsp;                throw new IllegalArgumentException(&quot;Found unresolved entry in a block with more than one elements&quot;);</b>
&nbsp;            }
&nbsp;
<b class="nc">&nbsp;            for (int j = 1; j &lt; blockSize; j++) {</b>
<b class="nc">&nbsp;                if ((block.get(j).getNumber().get() - block.get(j - 1).getNumber().get()) != 1) {</b>
<b class="nc">&nbsp;                    throw new IllegalArgumentException(&quot;Numbers are not consecutive&quot;);</b>
&nbsp;                }
&nbsp;            }
&nbsp;
&nbsp;            /*
&nbsp;             * Do the actual work
&nbsp;             */
&nbsp;
<b class="nc">&nbsp;            if (blockSize &gt;= minGroupingCount) {</b>
<b class="nc">&nbsp;                int first = block.getFirst().getNumber().get();</b>
<b class="nc">&nbsp;                int last = block.get(blockSize - 1).getNumber().get();</b>
<b class="nc">&nbsp;                if (last != (first + blockSize - 1)) {</b>
<b class="nc">&nbsp;                    throw new IllegalArgumentException(&quot;blockSize and length of num range differ&quot;);</b>
&nbsp;                }
&nbsp;
&nbsp;                // Emit: &quot;first-last&quot;
<b class="nc">&nbsp;                stringBuilder.append(first);</b>
<b class="nc">&nbsp;                stringBuilder.append(style.getGroupedNumbersSeparator());</b>
<b class="nc">&nbsp;                stringBuilder.append(last);</b>
&nbsp;            } else {
&nbsp;                // Emit: first, first+1,..., last
<b class="nc">&nbsp;                for (int j = 0; j &lt; blockSize; j++) {</b>
<b class="nc">&nbsp;                    if (j &gt; 0) {</b>
<b class="nc">&nbsp;                        stringBuilder.append(style.getCitationSeparator());</b>
&nbsp;                    }
<b class="nc">&nbsp;                    stringBuilder.append(block.get(j).getNumber().get());</b>
&nbsp;                }
&nbsp;            }
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * Format a number-based citation marker for the given number or numbers.
&nbsp;     *
&nbsp;     * @param entries          Provide the citation numbers.
&nbsp;     *                         &lt;p&gt;
&nbsp;     *                         An Optional.empty() number means: could not look this up
&nbsp;     *                         in the databases. Positive integers are the valid numbers.
&nbsp;     *                         &lt;p&gt;
&nbsp;     *                         Duplicate citation numbers are allowed:
&nbsp;     *                         &lt;p&gt;
&nbsp;     *                         - If their pageInfos are identical, only a
&nbsp;     *                         single instance is emitted.
&nbsp;     *                         &lt;p&gt;
&nbsp;     *                         - If their pageInfos differ, the number is emitted with each
&nbsp;     *                         distinct pageInfo.
&nbsp;     *                         &lt;p&gt;
&nbsp;     *                         pageInfos are expected to be normalized
&nbsp;     * @param minGroupingCount Zero and negative means never group.
&nbsp;     *                         Only used by tests to override the value in style.
&nbsp;     * @return The text for the citation.
&nbsp;     *
&nbsp;     */
&nbsp;    public static OOText getNumCitationMarker2(JStyle style,
&nbsp;                                               List&lt;CitationMarkerNumericEntry&gt; entries,
&nbsp;                                               int minGroupingCount) {
&nbsp;
<b class="nc">&nbsp;        final boolean joinIsDisabled = minGroupingCount &lt;= 0;</b>
<b class="nc">&nbsp;        final int nCitations = entries.size();</b>
&nbsp;
<b class="nc">&nbsp;        final String bracketBefore = style.getBracketBefore();</b>
<b class="nc">&nbsp;        final String bracketAfter = style.getBracketAfter();</b>
&nbsp;
&nbsp;        // Sort a copy of entries
<b class="nc">&nbsp;        List&lt;CitationMarkerNumericEntry&gt; sorted = OOListUtil.map(entries, e -&gt; e);</b>
<b class="nc">&nbsp;        sorted.sort(JStyleGetNumCitationMarker::compareCitationMarkerNumericEntry);</b>
&nbsp;
&nbsp;        // &quot;[&quot;
<b class="nc">&nbsp;        StringBuilder stringBuilder = new StringBuilder(bracketBefore);</b>
&nbsp;
&nbsp;        /*
&nbsp;         *  Original:
&nbsp;         *  [2,3,4]   -&gt; [2-4]
&nbsp;         *  [0,1,2]   -&gt; [??,1,2]
&nbsp;         *  [0,1,2,3] -&gt; [??,1-3]
&nbsp;         *
&nbsp;         *  Now we have to consider: duplicate numbers and pageInfos
&nbsp;         *  [1,1] -&gt; [1]
&nbsp;         *  [1,1 &quot;pp nn&quot;] -&gt; keep separate if pageInfo differs
&nbsp;         *  [1 &quot;pp nn&quot;,1 &quot;pp nn&quot;] -&gt; [1 &quot;pp nn&quot;]
&nbsp;         */
&nbsp;
<b class="nc">&nbsp;        boolean blocksEmitted = false;</b>
<b class="nc">&nbsp;        List&lt;CitationMarkerNumericEntry&gt; currentBlock = new ArrayList&lt;&gt;();</b>
<b class="nc">&nbsp;        List&lt;CitationMarkerNumericEntry&gt; nextBlock = new ArrayList&lt;&gt;();</b>
&nbsp;
<b class="nc">&nbsp;        for (int i = 0; i &lt; nCitations; i++) {</b>
<b class="nc">&nbsp;            final CitationMarkerNumericEntry current = sorted.get(i);</b>
<b class="nc">&nbsp;            if (current.getNumber().isPresent() &amp;&amp; current.getNumber().get() &lt; 0) {</b>
<b class="nc">&nbsp;                throw new IllegalArgumentException(&quot;getNumCitationMarker2: found negative number&quot;);</b>
&nbsp;            }
&nbsp;
<b class="nc">&nbsp;            if (currentBlock.isEmpty()) {</b>
<b class="nc">&nbsp;                currentBlock.add(current);</b>
&nbsp;            } else {
<b class="nc">&nbsp;                CitationMarkerNumericEntry prev = currentBlock.getLast();</b>
<b class="nc">&nbsp;                if (current.getNumber().isEmpty() || prev.getNumber().isEmpty()) {</b>
<b class="nc">&nbsp;                    nextBlock.add(current); // do not join if not found</b>
<b class="nc">&nbsp;                } else if (joinIsDisabled) {</b>
<b class="nc">&nbsp;                    nextBlock.add(current); // join disabled</b>
<b class="nc">&nbsp;                } else if (compareCitationMarkerNumericEntry(current, prev) == 0) {</b>
&nbsp;                    // Same as prev, just forget it.
<b class="nc">&nbsp;                } else if ((current.getNumber().get() == (prev.getNumber().get() + 1))</b>
<b class="nc">&nbsp;                        &amp;&amp; (prev.getPageInfo().isEmpty())</b>
<b class="nc">&nbsp;                        &amp;&amp; (current.getPageInfo().isEmpty())) {</b>
&nbsp;                    // Just two consecutive numbers without pageInfo: join
<b class="nc">&nbsp;                    currentBlock.add(current);</b>
&nbsp;                } else {
&nbsp;                    // do not join
<b class="nc">&nbsp;                    nextBlock.add(current);</b>
&nbsp;                }
&nbsp;            }
&nbsp;
<b class="nc">&nbsp;            if (!nextBlock.isEmpty()) {</b>
&nbsp;                // emit current block
<b class="nc">&nbsp;                if (blocksEmitted) {</b>
<b class="nc">&nbsp;                    stringBuilder.append(style.getCitationSeparator());</b>
&nbsp;                }
<b class="nc">&nbsp;                emitBlock(currentBlock, style, minGroupingCount, stringBuilder);</b>
<b class="nc">&nbsp;                blocksEmitted = true;</b>
<b class="nc">&nbsp;                currentBlock = nextBlock;</b>
<b class="nc">&nbsp;                nextBlock = new ArrayList&lt;&gt;();</b>
&nbsp;            }
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        if (!nextBlock.isEmpty()) {</b>
<b class="nc">&nbsp;            throw new IllegalStateException(&quot;impossible: (nextBlock.size() != 0) after loop&quot;);</b>
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        if (!currentBlock.isEmpty()) {</b>
&nbsp;            // We are emitting a block
<b class="nc">&nbsp;            if (blocksEmitted) {</b>
<b class="nc">&nbsp;                stringBuilder.append(style.getCitationSeparator());</b>
&nbsp;            }
<b class="nc">&nbsp;            emitBlock(currentBlock, style, minGroupingCount, stringBuilder);</b>
&nbsp;        }
&nbsp;
&nbsp;        // Emit: &quot;]&quot;
<b class="nc">&nbsp;        stringBuilder.append(bracketAfter);</b>
<b class="nc">&nbsp;        return OOText.fromString(stringBuilder.toString());</b>
&nbsp;    }
&nbsp;}
</code>
</pre>
</div>

<script type="text/javascript">
(function() {
    var msie = false, msie9 = false;
    /*@cc_on
      msie = true;
      @if (@_jscript_version >= 9)
        msie9 = true;
      @end
    @*/

    if (!msie || msie && msie9) {
      hljs.highlightAll()
      hljs.initLineNumbersOnLoad();
    }
})();
</script>

<div class="footer">
    
    <div style="float:right;">generated on 2025-09-29 22:51</div>
</div>
</body>
</html>
