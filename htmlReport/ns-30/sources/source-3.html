


<!DOCTYPE html>
<html id="htmlId">
<head>
  <meta http-equiv="Content-Type" content="text/html;charset=UTF-8"> 
  <title>Coverage Report > FileAnnotationTabViewModel</title>
  <style type="text/css">
    @import "../../css/coverage.css";
    @import "../../css/idea.min.css";
  </style>
  <script type="text/javascript" src="../../js/highlight.min.js"></script>
  <script type="text/javascript" src="../../js/highlightjs-line-numbers.min.js"></script>
</head>

<body>
<div class="content">
<div class="breadCrumbs">
Current scope:     <a href="../../index.html">all classes</a>
    <span class="separator">|</span>
    <a href="../index.html">org.jabref.gui.entryeditor.fileannotationtab</a>
</div>

<h1>Coverage Summary for Class: FileAnnotationTabViewModel (org.jabref.gui.entryeditor.fileannotationtab)</h1>

<table class="coverageStats">
<tr>
  <th class="name">Class</th>
<th class="coverageStat 
">
  Class, %
</th>
<th class="coverageStat 
">
  Method, %
</th>
<th class="coverageStat 
">
  Branch, %
</th>
<th class="coverageStat 
">
  Line, %
</th>
</tr>
<tr>
  <td class="name">FileAnnotationTabViewModel</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/12)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/4)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/45)
  </span>
</td>
</tr>

</table>

<br/>
<br/>


<pre>
<code class="sourceCode" id="sourceCode">&nbsp;package org.jabref.gui.entryeditor.fileannotationtab;
&nbsp;
&nbsp;import java.io.IOException;
&nbsp;import java.nio.file.Path;
&nbsp;import java.util.ArrayList;
&nbsp;import java.util.Comparator;
&nbsp;import java.util.List;
&nbsp;import java.util.Map;
&nbsp;import java.util.StringJoiner;
&nbsp;import java.util.stream.Collectors;
&nbsp;
&nbsp;import javafx.beans.property.ListProperty;
&nbsp;import javafx.beans.property.ObjectProperty;
&nbsp;import javafx.beans.property.ReadOnlyBooleanProperty;
&nbsp;import javafx.beans.property.SimpleListProperty;
&nbsp;import javafx.beans.property.SimpleObjectProperty;
&nbsp;import javafx.collections.FXCollections;
&nbsp;
&nbsp;import org.jabref.gui.AbstractViewModel;
&nbsp;import org.jabref.gui.ClipBoardManager;
&nbsp;import org.jabref.gui.util.UiTaskExecutor;
&nbsp;import org.jabref.logic.l10n.Localization;
&nbsp;import org.jabref.logic.os.OS;
&nbsp;import org.jabref.logic.pdf.FileAnnotationCache;
&nbsp;import org.jabref.model.entry.BibEntry;
&nbsp;import org.jabref.model.pdf.FileAnnotation;
&nbsp;import org.jabref.model.util.FileUpdateListener;
&nbsp;import org.jabref.model.util.FileUpdateMonitor;
&nbsp;
&nbsp;import org.slf4j.Logger;
&nbsp;import org.slf4j.LoggerFactory;
&nbsp;
&nbsp;public class FileAnnotationTabViewModel extends AbstractViewModel {
<b class="nc">&nbsp;    private static final Logger LOGGER = LoggerFactory.getLogger(FileAnnotationTabViewModel.class);</b>
&nbsp;
<b class="nc">&nbsp;    private final ListProperty&lt;FileAnnotationViewModel&gt; annotations = new SimpleListProperty&lt;&gt;(FXCollections.observableArrayList());</b>
<b class="nc">&nbsp;    private final ListProperty&lt;Path&gt; files = new SimpleListProperty&lt;&gt;(FXCollections.observableArrayList());</b>
<b class="nc">&nbsp;    private final ObjectProperty&lt;FileAnnotationViewModel&gt; currentAnnotation = new SimpleObjectProperty&lt;&gt;();</b>
<b class="nc">&nbsp;    private final ReadOnlyBooleanProperty annotationEmpty = annotations.emptyProperty();</b>
&nbsp;
&nbsp;    private final FileAnnotationCache cache;
&nbsp;    private final BibEntry entry;
&nbsp;    private Map&lt;Path, List&lt;FileAnnotation&gt;&gt; fileAnnotations;
&nbsp;    private Path currentFile;
&nbsp;    private final FileUpdateMonitor fileMonitor;
&nbsp;    private final ClipBoardManager clipBoardManager;
<b class="nc">&nbsp;    private final FileUpdateListener fileListener = this::reloadAnnotations;</b>
&nbsp;
&nbsp;    public FileAnnotationTabViewModel(FileAnnotationCache cache,
&nbsp;                                      BibEntry entry,
&nbsp;                                      FileUpdateMonitor fileMonitor,
<b class="nc">&nbsp;                                      ClipBoardManager clipBoardManager) {</b>
<b class="nc">&nbsp;        this.cache = cache;</b>
<b class="nc">&nbsp;        this.entry = entry;</b>
<b class="nc">&nbsp;        this.fileMonitor = fileMonitor;</b>
<b class="nc">&nbsp;        this.clipBoardManager = clipBoardManager;</b>
&nbsp;
<b class="nc">&nbsp;        fileAnnotations = this.cache.getFromCache(this.entry);</b>
<b class="nc">&nbsp;        files.setAll(fileAnnotations.keySet());</b>
&nbsp;    }
&nbsp;
&nbsp;    public ObjectProperty&lt;FileAnnotationViewModel&gt; currentAnnotationProperty() {
<b class="nc">&nbsp;        return currentAnnotation;</b>
&nbsp;    }
&nbsp;
&nbsp;    public ReadOnlyBooleanProperty isAnnotationsEmpty() {
<b class="nc">&nbsp;        return annotationEmpty;</b>
&nbsp;    }
&nbsp;
&nbsp;    public ListProperty&lt;FileAnnotationViewModel&gt; annotationsProperty() {
<b class="nc">&nbsp;        return annotations;</b>
&nbsp;    }
&nbsp;
&nbsp;    public ListProperty&lt;Path&gt; filesProperty() {
<b class="nc">&nbsp;        return files;</b>
&nbsp;    }
&nbsp;
&nbsp;    public void notifyNewSelectedAnnotation(FileAnnotationViewModel newAnnotation) {
<b class="nc">&nbsp;        currentAnnotation.set(newAnnotation);</b>
&nbsp;    }
&nbsp;
&nbsp;    public void notifyNewSelectedFile(Path newFile) {
<b class="nc">&nbsp;        fileMonitor.removeListener(currentFile, fileListener);</b>
<b class="nc">&nbsp;        currentFile = newFile;</b>
&nbsp;
<b class="nc">&nbsp;        Comparator&lt;FileAnnotation&gt; byPage = Comparator.comparingInt(FileAnnotation::getPage);</b>
&nbsp;
<b class="nc">&nbsp;        List&lt;FileAnnotationViewModel&gt; newAnnotations = fileAnnotations</b>
<b class="nc">&nbsp;                .getOrDefault(currentFile, new ArrayList&lt;&gt;())</b>
<b class="nc">&nbsp;                .stream()</b>
<b class="nc">&nbsp;                .filter(annotation -&gt; (null != annotation.getContent()))</b>
<b class="nc">&nbsp;                .sorted(byPage)</b>
<b class="nc">&nbsp;                .map(FileAnnotationViewModel::new)</b>
<b class="nc">&nbsp;                .collect(Collectors.toList());</b>
<b class="nc">&nbsp;        annotations.setAll(newAnnotations);</b>
&nbsp;
&nbsp;        try {
<b class="nc">&nbsp;            fileMonitor.addListenerForFile(currentFile, fileListener);</b>
&nbsp;        } catch (IOException e) {
<b class="nc">&nbsp;            LOGGER.error(&quot;Problem while watching file for changes {}&quot;, currentFile, e);</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    private void reloadAnnotations() {
&nbsp;        // Make sure to always run this in the JavaFX thread as the file monitor (and its notifications) live in a different thread
<b class="nc">&nbsp;        UiTaskExecutor.runInJavaFXThread(() -&gt; {</b>
&nbsp;            // Remove annotations for the current entry and reinitialize annotation/cache
<b class="nc">&nbsp;            cache.remove(entry);</b>
<b class="nc">&nbsp;            fileAnnotations = cache.getFromCache(entry);</b>
<b class="nc">&nbsp;            files.setAll(fileAnnotations.keySet());</b>
&nbsp;
&nbsp;            // Pretend that we just switched to the current file in order to refresh the display
<b class="nc">&nbsp;            notifyNewSelectedFile(currentFile);</b>
&nbsp;        });
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * Copies the meta and content information of the pdf annotation to the clipboard
&nbsp;     */
&nbsp;    public void copyCurrentAnnotation() {
<b class="nc">&nbsp;        if (null == getCurrentAnnotation()) {</b>
&nbsp;            return;
&nbsp;        }
<b class="nc">&nbsp;        StringJoiner sj = new StringJoiner(&quot;,&quot; + OS.NEWLINE);</b>
<b class="nc">&nbsp;        sj.add(Localization.lang(&quot;Author&quot;) + &quot;: &quot; + getCurrentAnnotation().getAuthor());</b>
<b class="nc">&nbsp;        sj.add(Localization.lang(&quot;Date&quot;) + &quot;: &quot; + getCurrentAnnotation().getDate());</b>
<b class="nc">&nbsp;        sj.add(Localization.lang(&quot;Page&quot;) + &quot;: &quot; + getCurrentAnnotation().getPage());</b>
<b class="nc">&nbsp;        sj.add(Localization.lang(&quot;Content&quot;) + &quot;: &quot; + getCurrentAnnotation().getContent());</b>
<b class="nc">&nbsp;        sj.add(Localization.lang(&quot;Marking&quot;) + &quot;: &quot; + getCurrentAnnotation().markingProperty().get());</b>
&nbsp;
<b class="nc">&nbsp;        clipBoardManager.setContent(sj.toString());</b>
&nbsp;    }
&nbsp;
&nbsp;    private FileAnnotationViewModel getCurrentAnnotation() {
<b class="nc">&nbsp;        return currentAnnotation.get();</b>
&nbsp;    }
&nbsp;}
</code>
</pre>
</div>

<script type="text/javascript">
(function() {
    var msie = false, msie9 = false;
    /*@cc_on
      msie = true;
      @if (@_jscript_version >= 9)
        msie9 = true;
      @end
    @*/

    if (!msie || msie && msie9) {
      hljs.highlightAll()
      hljs.initLineNumbersOnLoad();
    }
})();
</script>

<div class="footer">
    
    <div style="float:right;">generated on 2025-09-29 22:51</div>
</div>
</body>
</html>
