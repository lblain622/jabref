


<!DOCTYPE html>
<html id="htmlId">
<head>
  <meta http-equiv="Content-Type" content="text/html;charset=UTF-8"> 
  <title>Coverage Report > ImportCommand</title>
  <style type="text/css">
    @import "../../css/coverage.css";
    @import "../../css/idea.min.css";
  </style>
  <script type="text/javascript" src="../../js/highlight.min.js"></script>
  <script type="text/javascript" src="../../js/highlightjs-line-numbers.min.js"></script>
</head>

<body>
<div class="content">
<div class="breadCrumbs">
Current scope:     <a href="../../index.html">all classes</a>
    <span class="separator">|</span>
    <a href="../index.html">org.jabref.gui.importer</a>
</div>

<h1>Coverage Summary for Class: ImportCommand (org.jabref.gui.importer)</h1>

<table class="coverageStats">

<tr>
  <th class="name">Class</th>
<th class="coverageStat 
">
  Method, %
</th>
<th class="coverageStat 
">
  Branch, %
</th>
<th class="coverageStat 
">
  Line, %
</th>
</tr>
<tr>
  <td class="name">ImportCommand</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/12)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/40)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/96)
  </span>
</td>
</tr>
  <tr>
    <td class="name">ImportCommand$ImportMethod</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
  </tr>
<tr>
  <td class="name"><strong>Total</strong></td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/13)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/40)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/97)
  </span>
</td>
</tr>
</table>

<br/>
<br/>


<pre>
<code class="sourceCode" id="sourceCode">&nbsp;package org.jabref.gui.importer;
&nbsp;
&nbsp;import java.io.IOException;
&nbsp;import java.nio.file.Files;
&nbsp;import java.nio.file.Path;
&nbsp;import java.util.ArrayList;
&nbsp;import java.util.List;
&nbsp;import java.util.Optional;
&nbsp;import java.util.SortedSet;
&nbsp;
&nbsp;import javafx.stage.FileChooser;
&nbsp;
&nbsp;import org.jabref.gui.DialogService;
&nbsp;import org.jabref.gui.LibraryTab;
&nbsp;import org.jabref.gui.LibraryTabContainer;
&nbsp;import org.jabref.gui.StateManager;
&nbsp;import org.jabref.gui.actions.SimpleCommand;
&nbsp;import org.jabref.gui.util.FileDialogConfiguration;
&nbsp;import org.jabref.gui.util.FileFilterConverter;
&nbsp;import org.jabref.gui.util.UiTaskExecutor;
&nbsp;import org.jabref.logic.database.DatabaseMerger;
&nbsp;import org.jabref.logic.importer.ImportException;
&nbsp;import org.jabref.logic.importer.ImportFormatReader;
&nbsp;import org.jabref.logic.importer.Importer;
&nbsp;import org.jabref.logic.importer.ParserResult;
&nbsp;import org.jabref.logic.importer.fileformat.PdfMergeMetadataImporter;
&nbsp;import org.jabref.logic.importer.fileformat.pdf.PdfGrobidImporter;
&nbsp;import org.jabref.logic.l10n.Localization;
&nbsp;import org.jabref.logic.preferences.CliPreferences;
&nbsp;import org.jabref.logic.util.BackgroundTask;
&nbsp;import org.jabref.logic.util.TaskExecutor;
&nbsp;import org.jabref.logic.util.UpdateField;
&nbsp;import org.jabref.logic.util.io.FileUtil;
&nbsp;import org.jabref.model.database.BibDatabase;
&nbsp;import org.jabref.model.util.FileUpdateMonitor;
&nbsp;
&nbsp;import org.slf4j.Logger;
&nbsp;import org.slf4j.LoggerFactory;
&nbsp;
&nbsp;import static org.jabref.gui.actions.ActionHelper.needsDatabase;
&nbsp;
&nbsp;/**
&nbsp; * Perform an import action
&nbsp; */
&nbsp;public class ImportCommand extends SimpleCommand {
<b class="nc">&nbsp;    private static final Logger LOGGER = LoggerFactory.getLogger(ImportCommand.class);</b>
&nbsp;
<b class="nc">&nbsp;    public enum ImportMethod { AS_NEW, TO_EXISTING }</b>
&nbsp;
&nbsp;    private final LibraryTabContainer tabContainer;
&nbsp;    private final ImportMethod importMethod;
&nbsp;
&nbsp;    private final DialogService dialogService;
&nbsp;    private final CliPreferences preferences;
&nbsp;    private final FileUpdateMonitor fileUpdateMonitor;
&nbsp;    private final TaskExecutor taskExecutor;
&nbsp;
&nbsp;    public ImportCommand(LibraryTabContainer tabContainer,
&nbsp;                         ImportMethod importMethod,
&nbsp;                         CliPreferences preferences,
&nbsp;                         StateManager stateManager,
&nbsp;                         FileUpdateMonitor fileUpdateMonitor,
&nbsp;                         TaskExecutor taskExecutor,
<b class="nc">&nbsp;                         DialogService dialogService) {</b>
<b class="nc">&nbsp;        this.tabContainer = tabContainer;</b>
<b class="nc">&nbsp;        this.importMethod = importMethod;</b>
<b class="nc">&nbsp;        this.preferences = preferences;</b>
<b class="nc">&nbsp;        this.fileUpdateMonitor = fileUpdateMonitor;</b>
<b class="nc">&nbsp;        this.taskExecutor = taskExecutor;</b>
<b class="nc">&nbsp;        this.dialogService = dialogService;</b>
&nbsp;
<b class="nc">&nbsp;        if (importMethod == ImportMethod.TO_EXISTING) {</b>
<b class="nc">&nbsp;            this.executable.bind(needsDatabase(stateManager));</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public void execute() {
<b class="nc">&nbsp;        ImportFormatReader importFormatReader = new ImportFormatReader(</b>
<b class="nc">&nbsp;                preferences.getImporterPreferences(),</b>
<b class="nc">&nbsp;                preferences.getImportFormatPreferences(),</b>
<b class="nc">&nbsp;                preferences.getCitationKeyPatternPreferences(),</b>
&nbsp;                fileUpdateMonitor
&nbsp;        );
<b class="nc">&nbsp;        SortedSet&lt;Importer&gt; importers = importFormatReader.getImportFormats();</b>
&nbsp;
<b class="nc">&nbsp;        FileDialogConfiguration fileDialogConfiguration = new FileDialogConfiguration.Builder()</b>
<b class="nc">&nbsp;                .addExtensionFilter(FileFilterConverter.ANY_FILE)</b>
<b class="nc">&nbsp;                .addExtensionFilter(FileFilterConverter.forAllImporters(importers))</b>
<b class="nc">&nbsp;                .addExtensionFilter(FileFilterConverter.importerToExtensionFilter(importers))</b>
<b class="nc">&nbsp;                .withInitialDirectory(preferences.getImporterPreferences().getImportWorkingDirectory())</b>
<b class="nc">&nbsp;                .build();</b>
&nbsp;
<b class="nc">&nbsp;        List&lt;Path&gt; selectedFiles = dialogService.showFileOpenDialogAndGetMultipleFiles(fileDialogConfiguration);</b>
&nbsp;
<b class="nc">&nbsp;        if (selectedFiles.isEmpty()) {</b>
&nbsp;            return; // User cancelled or no files selected
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        importMultipleFiles(selectedFiles, importers, fileDialogConfiguration.getSelectedExtensionFilter());</b>
&nbsp;    }
&nbsp;
&nbsp;    private void importMultipleFiles(List&lt;Path&gt; files, SortedSet&lt;Importer&gt; importers, FileChooser.ExtensionFilter selectedExtensionFilter) {
<b class="nc">&nbsp;        for (Path file : files) {</b>
<b class="nc">&nbsp;            if (!Files.exists(file)) {</b>
<b class="nc">&nbsp;                dialogService.showErrorDialogAndWait(Localization.lang(&quot;Import&quot;),</b>
<b class="nc">&nbsp;                        Localization.lang(&quot;File not found&quot;) + &quot;: &#39;&quot; + file.getFileName() + &quot;&#39;.&quot;);</b>
&nbsp;                return;
&nbsp;            }
&nbsp;        }
&nbsp;
&nbsp;        BackgroundTask&lt;ParserResult&gt; task;
&nbsp;        Optional&lt;Importer&gt; format;
&nbsp;
<b class="nc">&nbsp;        boolean isGeneralFilter = selectedExtensionFilter == FileFilterConverter.ANY_FILE</b>
<b class="nc">&nbsp;                || &quot;Available import formats&quot;.equals(selectedExtensionFilter.getDescription());</b>
&nbsp;
<b class="nc">&nbsp;        if (!isGeneralFilter) {</b>
&nbsp;            // User picked a specific format
<b class="nc">&nbsp;            format = FileFilterConverter.getImporter(selectedExtensionFilter, importers);</b>
<b class="nc">&nbsp;        } else if (files.size() == 1) {</b>
&nbsp;            // Infer if only one file and no specific filter
<b class="nc">&nbsp;            selectedExtensionFilter = FileFilterConverter.determineExtensionFilter(files.getFirst());</b>
<b class="nc">&nbsp;            format = FileFilterConverter.getImporter(selectedExtensionFilter, importers);</b>
&nbsp;        } else {
<b class="nc">&nbsp;            format = Optional.empty();</b>
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        task = BackgroundTask.wrap(() -&gt; doImport(files, format.orElse(null)));</b>
&nbsp;
<b class="nc">&nbsp;        LibraryTab tab = tabContainer.getCurrentLibraryTab();</b>
&nbsp;
&nbsp;        // If there is no open library tab, we fall back to importing as new
&nbsp;        // This prevents a crash in case the user selects &quot;Import into current library&quot;
&nbsp;        // while no library is currently open.
<b class="nc">&nbsp;        if (importMethod == ImportMethod.AS_NEW || tab == null) {</b>
<b class="nc">&nbsp;            task.onSuccess(parserResult -&gt; {</b>
<b class="nc">&nbsp;                    tabContainer.addTab(parserResult.getDatabaseContext(), true);</b>
<b class="nc">&nbsp;                    dialogService.notify(Localization.lang(&quot;%0 entry(s) imported&quot;, parserResult.getDatabase().getEntries().size()));</b>
&nbsp;                })
<b class="nc">&nbsp;                .onFailure(ex -&gt; {</b>
<b class="nc">&nbsp;                    LOGGER.error(&quot;Error importing&quot;, ex);</b>
<b class="nc">&nbsp;                    dialogService.notify(Localization.lang(&quot;Error importing. See the error log for details.&quot;));</b>
&nbsp;                })
<b class="nc">&nbsp;                .executeWith(taskExecutor);</b>
&nbsp;        } else {
<b class="nc">&nbsp;            ImportEntriesDialog dialog = new ImportEntriesDialog(tab.getBibDatabaseContext(), task);</b>
<b class="nc">&nbsp;            dialog.setTitle(Localization.lang(&quot;Import&quot;));</b>
<b class="nc">&nbsp;            dialogService.showCustomDialogAndWait(dialog);</b>
&nbsp;        }
&nbsp;
&nbsp;        // Set last working dir for import
<b class="nc">&nbsp;        preferences.getImporterPreferences().setImportWorkingDirectory(files.getLast().getParent());</b>
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * @throws IOException of a specified importer
&nbsp;     */
&nbsp;    private ParserResult doImport(List&lt;Path&gt; files, Importer importFormat) throws IOException {
<b class="nc">&nbsp;        Optional&lt;Importer&gt; importer = Optional.ofNullable(importFormat);</b>
&nbsp;        // We import all files and collect their results
<b class="nc">&nbsp;        List&lt;ImportFormatReader.UnknownFormatImport&gt; imports = new ArrayList&lt;&gt;();</b>
<b class="nc">&nbsp;        ImportFormatReader importFormatReader = new ImportFormatReader(</b>
<b class="nc">&nbsp;                preferences.getImporterPreferences(),</b>
<b class="nc">&nbsp;                preferences.getImportFormatPreferences(),</b>
<b class="nc">&nbsp;                preferences.getCitationKeyPatternPreferences(),</b>
&nbsp;                fileUpdateMonitor
&nbsp;        );
<b class="nc">&nbsp;        for (Path filename : files) {</b>
&nbsp;            try {
<b class="nc">&nbsp;                if (importer.isEmpty()) {</b>
&nbsp;                    // Unknown format
<b class="nc">&nbsp;                    UiTaskExecutor.runAndWaitInJavaFXThread(() -&gt; {</b>
<b class="nc">&nbsp;                        if (FileUtil.isPDFFile(filename) &amp;&amp; GrobidUseDialogHelper.showAndWaitIfUserIsUndecided(dialogService, preferences.getGrobidPreferences())) {</b>
<b class="nc">&nbsp;                            importFormatReader.reset();</b>
&nbsp;                        }
<b class="nc">&nbsp;                        dialogService.notify(Localization.lang(&quot;Importing file %0 as unknown format&quot;, filename.getFileName().toString()));</b>
&nbsp;                    });
&nbsp;                    // This import method never throws an IOException
<b class="nc">&nbsp;                    imports.add(importFormatReader.importUnknownFormat(filename, fileUpdateMonitor));</b>
&nbsp;                } else {
<b class="nc">&nbsp;                    UiTaskExecutor.runAndWaitInJavaFXThread(() -&gt; {</b>
<b class="nc">&nbsp;                        if (((importer.get() instanceof PdfGrobidImporter) || (importer.get() instanceof PdfMergeMetadataImporter))</b>
<b class="nc">&nbsp;                                &amp;&amp; GrobidUseDialogHelper.showAndWaitIfUserIsUndecided(dialogService, preferences.getGrobidPreferences())) {</b>
<b class="nc">&nbsp;                            importFormatReader.reset();</b>
&nbsp;                        }
<b class="nc">&nbsp;                        dialogService.notify(Localization.lang(&quot;Importing in %0 format&quot;, importer.get().getName()) + &quot;...&quot;);</b>
&nbsp;                    });
&nbsp;                    // Specific importer
<b class="nc">&nbsp;                    ParserResult pr = importer.get().importDatabase(filename);</b>
<b class="nc">&nbsp;                    imports.add(new ImportFormatReader.UnknownFormatImport(importer.get().getName(), pr));</b>
&nbsp;                }
&nbsp;            } catch (ImportException ex) {
<b class="nc">&nbsp;                UiTaskExecutor.runAndWaitInJavaFXThread(</b>
<b class="nc">&nbsp;                        () -&gt; dialogService.showWarningDialogAndWait(</b>
<b class="nc">&nbsp;                                Localization.lang(&quot;Import error&quot;),</b>
<b class="nc">&nbsp;                                Localization.lang(&quot;Please check your library file for wrong syntax.&quot;)</b>
&nbsp;                                        + &quot;\n\n&quot;
<b class="nc">&nbsp;                                        + ex.getLocalizedMessage()));</b>
&nbsp;            }
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        if (imports.isEmpty()) {</b>
<b class="nc">&nbsp;            UiTaskExecutor.runAndWaitInJavaFXThread(</b>
<b class="nc">&nbsp;                    () -&gt; dialogService.showWarningDialogAndWait(</b>
<b class="nc">&nbsp;                            Localization.lang(&quot;Import error&quot;),</b>
<b class="nc">&nbsp;                            Localization.lang(&quot;No entries found. Please make sure you are using the correct import filter.&quot;)));</b>
&nbsp;
<b class="nc">&nbsp;            return new ParserResult();</b>
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        return mergeImportResults(imports);</b>
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * TODO: Move this to logic package. Blocked by undo functionality.
&nbsp;     */
&nbsp;    public ParserResult mergeImportResults(List&lt;ImportFormatReader.UnknownFormatImport&gt; imports) {
<b class="nc">&nbsp;        BibDatabase resultDatabase = new BibDatabase();</b>
<b class="nc">&nbsp;        ParserResult result = new ParserResult(resultDatabase);</b>
&nbsp;
<b class="nc">&nbsp;        for (ImportFormatReader.UnknownFormatImport importResult : imports) {</b>
<b class="nc">&nbsp;            if (importResult == null) {</b>
&nbsp;                continue;
&nbsp;            }
<b class="nc">&nbsp;            ParserResult parserResult = importResult.parserResult();</b>
<b class="nc">&nbsp;            resultDatabase.insertEntries(parserResult.getDatabase().getEntries());</b>
&nbsp;
<b class="nc">&nbsp;            if (ImportFormatReader.BIBTEX_FORMAT.equals(importResult.format())) {</b>
&nbsp;                // additional treatment of BibTeX
<b class="nc">&nbsp;                new DatabaseMerger(preferences.getBibEntryPreferences().getKeywordSeparator()).mergeMetaData(</b>
<b class="nc">&nbsp;                        result.getMetaData(),</b>
<b class="nc">&nbsp;                        parserResult.getMetaData(),</b>
<b class="nc">&nbsp;                        importResult.parserResult().getPath().map(path -&gt; path.getFileName().toString()).orElse(&quot;unknown&quot;),</b>
<b class="nc">&nbsp;                        parserResult.getDatabase().getEntries());</b>
&nbsp;            }
&nbsp;            // TODO: collect errors into ParserResult, because they are currently ignored (see caller of this method)
&nbsp;        }
&nbsp;
&nbsp;        // set timestamp and owner
<b class="nc">&nbsp;        UpdateField.setAutomaticFields(resultDatabase.getEntries(), preferences.getOwnerPreferences(), preferences.getTimestampPreferences()); // set timestamp and owner</b>
&nbsp;
<b class="nc">&nbsp;        return result;</b>
&nbsp;    }
&nbsp;}
</code>
</pre>
</div>

<script type="text/javascript">
(function() {
    var msie = false, msie9 = false;
    /*@cc_on
      msie = true;
      @if (@_jscript_version >= 9)
        msie9 = true;
      @end
    @*/

    if (!msie || msie && msie9) {
      hljs.highlightAll()
      hljs.initLineNumbersOnLoad();
    }
})();
</script>

<div class="footer">
    
    <div style="float:right;">generated on 2025-09-29 22:51</div>
</div>
</body>
</html>
