


<!DOCTYPE html>
<html id="htmlId">
<head>
  <meta http-equiv="Content-Type" content="text/html;charset=UTF-8"> 
  <title>Coverage Report > CitationRelationsTab</title>
  <style type="text/css">
    @import "../../css/coverage.css";
    @import "../../css/idea.min.css";
  </style>
  <script type="text/javascript" src="../../js/highlight.min.js"></script>
  <script type="text/javascript" src="../../js/highlightjs-line-numbers.min.js"></script>
</head>

<body>
<div class="content">
<div class="breadCrumbs">
Current scope:     <a href="../../index.html">all classes</a>
    <span class="separator">|</span>
    <a href="../index.html">org.jabref.gui.entryeditor.citationrelationtab</a>
</div>

<h1>Coverage Summary for Class: CitationRelationsTab (org.jabref.gui.entryeditor.citationrelationtab)</h1>

<table class="coverageStats">

<tr>
  <th class="name">Class</th>
<th class="coverageStat 
">
  Method, %
</th>
<th class="coverageStat 
">
  Branch, %
</th>
<th class="coverageStat 
">
  Line, %
</th>
</tr>
<tr>
  <td class="name">CitationRelationsTab</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/38)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/40)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/287)
  </span>
</td>
</tr>
  <tr>
    <td class="name">CitationRelationsTab$1</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
  </tr>
<tr>
  <td class="name"><strong>Total</strong></td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/39)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/40)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/288)
  </span>
</td>
</tr>
</table>

<br/>
<br/>


<pre>
<code class="sourceCode" id="sourceCode">&nbsp;package org.jabref.gui.entryeditor.citationrelationtab;
&nbsp;
&nbsp;import java.io.IOException;
&nbsp;import java.io.StringWriter;
&nbsp;import java.net.URI;
&nbsp;import java.util.Arrays;
&nbsp;import java.util.List;
&nbsp;import java.util.Optional;
&nbsp;
&nbsp;import javax.swing.undo.UndoManager;
&nbsp;
&nbsp;import javafx.beans.binding.Bindings;
&nbsp;import javafx.beans.binding.BooleanBinding;
&nbsp;import javafx.collections.FXCollections;
&nbsp;import javafx.collections.ObservableList;
&nbsp;import javafx.css.PseudoClass;
&nbsp;import javafx.geometry.Insets;
&nbsp;import javafx.geometry.Pos;
&nbsp;import javafx.scene.Node;
&nbsp;import javafx.scene.control.Button;
&nbsp;import javafx.scene.control.ButtonType;
&nbsp;import javafx.scene.control.DialogPane;
&nbsp;import javafx.scene.control.Hyperlink;
&nbsp;import javafx.scene.control.Label;
&nbsp;import javafx.scene.control.ProgressIndicator;
&nbsp;import javafx.scene.control.ScrollPane;
&nbsp;import javafx.scene.control.SplitPane;
&nbsp;import javafx.scene.control.ToggleButton;
&nbsp;import javafx.scene.control.Tooltip;
&nbsp;import javafx.scene.layout.AnchorPane;
&nbsp;import javafx.scene.layout.HBox;
&nbsp;import javafx.scene.layout.Priority;
&nbsp;import javafx.scene.layout.VBox;
&nbsp;
&nbsp;import org.jabref.gui.DialogService;
&nbsp;import org.jabref.gui.LibraryTab;
&nbsp;import org.jabref.gui.StateManager;
&nbsp;import org.jabref.gui.collab.entrychange.PreviewWithSourceTab;
&nbsp;import org.jabref.gui.desktop.os.NativeDesktop;
&nbsp;import org.jabref.gui.entryeditor.EntryEditorTab;
&nbsp;import org.jabref.gui.icon.IconTheme;
&nbsp;import org.jabref.gui.mergeentries.threewaymerge.EntriesMergeResult;
&nbsp;import org.jabref.gui.mergeentries.threewaymerge.MergeEntriesDialog;
&nbsp;import org.jabref.gui.preferences.GuiPreferences;
&nbsp;import org.jabref.gui.undo.NamedCompoundEdit;
&nbsp;import org.jabref.gui.undo.UndoableInsertEntries;
&nbsp;import org.jabref.gui.undo.UndoableRemoveEntries;
&nbsp;import org.jabref.gui.util.NoSelectionModel;
&nbsp;import org.jabref.gui.util.ViewModelListCellFactory;
&nbsp;import org.jabref.logic.bibtex.BibEntryWriter;
&nbsp;import org.jabref.logic.bibtex.FieldPreferences;
&nbsp;import org.jabref.logic.bibtex.FieldWriter;
&nbsp;import org.jabref.logic.citation.SearchCitationsRelationsService;
&nbsp;import org.jabref.logic.database.DuplicateCheck;
&nbsp;import org.jabref.logic.exporter.BibWriter;
&nbsp;import org.jabref.logic.importer.fetcher.CrossRef;
&nbsp;import org.jabref.logic.importer.fetcher.citation.CitationFetcher;
&nbsp;import org.jabref.logic.l10n.Localization;
&nbsp;import org.jabref.logic.os.OS;
&nbsp;import org.jabref.logic.util.BackgroundTask;
&nbsp;import org.jabref.logic.util.TaskExecutor;
&nbsp;import org.jabref.model.database.BibDatabase;
&nbsp;import org.jabref.model.database.BibDatabaseContext;
&nbsp;import org.jabref.model.database.BibDatabaseMode;
&nbsp;import org.jabref.model.database.BibDatabaseModeDetection;
&nbsp;import org.jabref.model.entry.BibEntry;
&nbsp;import org.jabref.model.entry.BibEntryTypesManager;
&nbsp;import org.jabref.model.entry.field.StandardField;
&nbsp;import org.jabref.model.entry.identifier.DOI;
&nbsp;import org.jabref.model.strings.StringUtil;
&nbsp;import org.jabref.model.util.FileUpdateMonitor;
&nbsp;
&nbsp;import com.tobiasdiez.easybind.EasyBind;
&nbsp;import org.controlsfx.control.CheckListView;
&nbsp;import org.fxmisc.flowless.VirtualizedScrollPane;
&nbsp;import org.fxmisc.richtext.CodeArea;
&nbsp;import org.slf4j.Logger;
&nbsp;import org.slf4j.LoggerFactory;
&nbsp;
&nbsp;/**
&nbsp; * GUI for tab displaying an articles citation relations in two lists based on the currently selected BibEntry
&nbsp; */
&nbsp;public class CitationRelationsTab extends EntryEditorTab {
&nbsp;
&nbsp;    public static final String NAME = &quot;Citation relations&quot;;
&nbsp;
<b class="nc">&nbsp;    private static final Logger LOGGER = LoggerFactory.getLogger(CitationRelationsTab.class);</b>
&nbsp;
&nbsp;    // Tasks used to implement asynchronous fetching of related articles
&nbsp;    private static BackgroundTask&lt;List&lt;BibEntry&gt;&gt; citingTask;
&nbsp;    private static BackgroundTask&lt;List&lt;BibEntry&gt;&gt; citedByTask;
&nbsp;    private final DialogService dialogService;
&nbsp;    private final GuiPreferences preferences;
&nbsp;    private final TaskExecutor taskExecutor;
&nbsp;    private final SearchCitationsRelationsService searchCitationsRelationsService;
&nbsp;    private final CitationsRelationsTabViewModel citationsRelationsTabViewModel;
&nbsp;    private final DuplicateCheck duplicateCheck;
&nbsp;    private final BibEntryTypesManager entryTypesManager;
&nbsp;    private final StateManager stateManager;
&nbsp;    private final UndoManager undoManager;
&nbsp;
&nbsp;    public CitationRelationsTab(DialogService dialogService,
&nbsp;                                UndoManager undoManager,
&nbsp;                                StateManager stateManager,
&nbsp;                                FileUpdateMonitor fileUpdateMonitor,
&nbsp;                                GuiPreferences preferences,
&nbsp;                                TaskExecutor taskExecutor,
&nbsp;                                BibEntryTypesManager bibEntryTypesManager,
<b class="nc">&nbsp;                                SearchCitationsRelationsService searchCitationsRelationsService) {</b>
<b class="nc">&nbsp;        this.dialogService = dialogService;</b>
<b class="nc">&nbsp;        this.preferences = preferences;</b>
<b class="nc">&nbsp;        this.taskExecutor = taskExecutor;</b>
<b class="nc">&nbsp;        this.undoManager = undoManager;</b>
<b class="nc">&nbsp;        this.stateManager = stateManager;</b>
<b class="nc">&nbsp;        setText(Localization.lang(&quot;Citation relations&quot;));</b>
<b class="nc">&nbsp;        setTooltip(new Tooltip(Localization.lang(&quot;Show articles related by citation&quot;)));</b>
<b class="nc">&nbsp;        setId(&quot;citationRelationsTab&quot;);</b>
&nbsp;
<b class="nc">&nbsp;        this.entryTypesManager = bibEntryTypesManager;</b>
<b class="nc">&nbsp;        this.duplicateCheck = new DuplicateCheck(entryTypesManager);</b>
<b class="nc">&nbsp;        this.searchCitationsRelationsService = searchCitationsRelationsService;</b>
&nbsp;
<b class="nc">&nbsp;        this.citationsRelationsTabViewModel = new CitationsRelationsTabViewModel(</b>
&nbsp;                preferences,
&nbsp;                undoManager,
&nbsp;                stateManager,
&nbsp;                dialogService,
&nbsp;                fileUpdateMonitor,
&nbsp;                taskExecutor
&nbsp;        );
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * Method to create main SplitPane holding all lists, buttons and labels for tab and starts search
&nbsp;     *
&nbsp;     * @param entry BibEntry which is currently selected in JabRef Database
&nbsp;     * @return SplitPane to display
&nbsp;     */
&nbsp;    private SplitPane getPaneAndStartSearch(BibEntry entry) {
&nbsp;        // Create Layout Containers
<b class="nc">&nbsp;        VBox citingVBox = new VBox();</b>
<b class="nc">&nbsp;        VBox citedByVBox = new VBox();</b>
<b class="nc">&nbsp;        citingVBox.setFillWidth(true);</b>
<b class="nc">&nbsp;        citedByVBox.setFillWidth(true);</b>
<b class="nc">&nbsp;        citingVBox.setAlignment(Pos.TOP_CENTER);</b>
<b class="nc">&nbsp;        citedByVBox.setAlignment(Pos.TOP_CENTER);</b>
<b class="nc">&nbsp;        AnchorPane citingHBox = new AnchorPane();</b>
<b class="nc">&nbsp;        citingHBox.setPrefHeight(40);</b>
<b class="nc">&nbsp;        AnchorPane citedByHBox = new AnchorPane();</b>
<b class="nc">&nbsp;        citedByHBox.setPrefHeight(40);</b>
&nbsp;
&nbsp;        // Create Headings
&nbsp;        // See ADR-0047
<b class="nc">&nbsp;        String citationKey = entry.getCitationKey().orElse(&quot;this entry&quot;);</b>
&nbsp;
<b class="nc">&nbsp;        Label citingLabel = new Label(Localization.lang(&quot;References cited in %0&quot;, citationKey));</b>
<b class="nc">&nbsp;        styleLabel(citingLabel, Localization.lang(&quot;Also called \&quot;backward citations\&quot;&quot;));</b>
<b class="nc">&nbsp;        Label citedByLabel = new Label(Localization.lang(&quot;References that cite %0&quot;, citationKey));</b>
<b class="nc">&nbsp;        styleLabel(citedByLabel, Localization.lang(&quot;Also called \&quot;forward citations\&quot;&quot;));</b>
&nbsp;
&nbsp;        // Create ListViews
<b class="nc">&nbsp;        CheckListView&lt;CitationRelationItem&gt; citingListView = new CheckListView&lt;&gt;();</b>
<b class="nc">&nbsp;        CheckListView&lt;CitationRelationItem&gt; citedByListView = new CheckListView&lt;&gt;();</b>
&nbsp;
&nbsp;        // Create refresh Buttons for both sides
<b class="nc">&nbsp;        Button refreshCitingButton = IconTheme.JabRefIcons.REFRESH.asButton();</b>
<b class="nc">&nbsp;        refreshCitingButton.setTooltip(new Tooltip(Localization.lang(&quot;Restart search&quot;)));</b>
<b class="nc">&nbsp;        styleTopBarNode(refreshCitingButton, 15.0);</b>
<b class="nc">&nbsp;        Button refreshCitedByButton = IconTheme.JabRefIcons.REFRESH.asButton();</b>
<b class="nc">&nbsp;        refreshCitedByButton.setTooltip(new Tooltip(Localization.lang(&quot;Restart search&quot;)));</b>
<b class="nc">&nbsp;        styleTopBarNode(refreshCitedByButton, 15.0);</b>
&nbsp;
&nbsp;        // Create abort buttons for both sides
<b class="nc">&nbsp;        Button abortCitingButton = IconTheme.JabRefIcons.CLOSE.asButton();</b>
<b class="nc">&nbsp;        abortCitingButton.getGraphic().resize(30, 30);</b>
<b class="nc">&nbsp;        abortCitingButton.setTooltip(new Tooltip(Localization.lang(&quot;Cancel search&quot;)));</b>
<b class="nc">&nbsp;        styleTopBarNode(abortCitingButton, 15.0);</b>
<b class="nc">&nbsp;        Button abortCitedButton = IconTheme.JabRefIcons.CLOSE.asButton();</b>
<b class="nc">&nbsp;        abortCitedButton.getGraphic().resize(30, 30);</b>
<b class="nc">&nbsp;        abortCitedButton.setTooltip(new Tooltip(Localization.lang(&quot;Cancel search&quot;)));</b>
<b class="nc">&nbsp;        styleTopBarNode(abortCitedButton, 15.0);</b>
&nbsp;
<b class="nc">&nbsp;        ProgressIndicator citingProgress = new ProgressIndicator();</b>
<b class="nc">&nbsp;        citingProgress.setMaxSize(25, 25);</b>
<b class="nc">&nbsp;        styleTopBarNode(citingProgress, 50.0);</b>
<b class="nc">&nbsp;        ProgressIndicator citedByProgress = new ProgressIndicator();</b>
<b class="nc">&nbsp;        citedByProgress.setMaxSize(25, 25);</b>
<b class="nc">&nbsp;        styleTopBarNode(citedByProgress, 50.0);</b>
&nbsp;
&nbsp;        // Create import buttons for both sides
<b class="nc">&nbsp;        Button importCitingButton = IconTheme.JabRefIcons.ADD_ENTRY.asButton();</b>
<b class="nc">&nbsp;        importCitingButton.setTooltip(new Tooltip(Localization.lang(&quot;Add selected entry(s) to library&quot;)));</b>
<b class="nc">&nbsp;        styleTopBarNode(importCitingButton, 50.0);</b>
<b class="nc">&nbsp;        Button importCitedByButton = IconTheme.JabRefIcons.ADD_ENTRY.asButton();</b>
<b class="nc">&nbsp;        importCitedByButton.setTooltip(new Tooltip(Localization.lang(&quot;Add selected entry(s) to library&quot;)));</b>
<b class="nc">&nbsp;        styleTopBarNode(importCitedByButton, 50.0);</b>
<b class="nc">&nbsp;        hideNodes(importCitingButton, importCitedByButton);</b>
&nbsp;
<b class="nc">&nbsp;        citingHBox.getChildren().addAll(citingLabel, refreshCitingButton, importCitingButton, citingProgress, abortCitingButton);</b>
<b class="nc">&nbsp;        citedByHBox.getChildren().addAll(citedByLabel, refreshCitedByButton, importCitedByButton, citedByProgress, abortCitedButton);</b>
&nbsp;
<b class="nc">&nbsp;        VBox.setVgrow(citingListView, Priority.ALWAYS);</b>
<b class="nc">&nbsp;        VBox.setVgrow(citedByListView, Priority.ALWAYS);</b>
<b class="nc">&nbsp;        citingVBox.getChildren().addAll(citingHBox, citingListView);</b>
<b class="nc">&nbsp;        citedByVBox.getChildren().addAll(citedByHBox, citedByListView);</b>
&nbsp;
<b class="nc">&nbsp;        CitationComponents citingComponents = new CitationComponents(</b>
&nbsp;                entry,
&nbsp;                citingListView,
&nbsp;                abortCitingButton,
&nbsp;                refreshCitingButton,
&nbsp;                CitationFetcher.SearchType.CITES,
&nbsp;                importCitingButton,
&nbsp;                citingProgress);
&nbsp;
<b class="nc">&nbsp;        CitationComponents citedByComponents = new CitationComponents(</b>
&nbsp;                entry,
&nbsp;                citedByListView,
&nbsp;                abortCitedButton,
&nbsp;                refreshCitedByButton,
&nbsp;                CitationFetcher.SearchType.CITED_BY,
&nbsp;                importCitedByButton,
&nbsp;                citedByProgress);
&nbsp;
<b class="nc">&nbsp;        refreshCitingButton.setOnMouseClicked(_ -&gt; searchForRelations(citingComponents, citedByComponents));</b>
<b class="nc">&nbsp;        refreshCitedByButton.setOnMouseClicked(_ -&gt; searchForRelations(citedByComponents, citingComponents));</b>
&nbsp;
&nbsp;        // Create SplitPane to hold all nodes above
<b class="nc">&nbsp;        SplitPane container = new SplitPane(citingVBox, citedByVBox);</b>
<b class="nc">&nbsp;        styleFetchedListView(citedByListView);</b>
<b class="nc">&nbsp;        styleFetchedListView(citingListView);</b>
&nbsp;
<b class="nc">&nbsp;        searchForRelations(citingComponents, citedByComponents);</b>
<b class="nc">&nbsp;        searchForRelations(citedByComponents, citingComponents);</b>
&nbsp;
<b class="nc">&nbsp;        return container;</b>
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * Styles a given CheckListView to display BibEntries either with a hyperlink or an add button
&nbsp;     *
&nbsp;     * @param listView CheckListView to style
&nbsp;     */
&nbsp;    private void styleFetchedListView(CheckListView&lt;CitationRelationItem&gt; listView) {
<b class="nc">&nbsp;        PseudoClass entrySelected = PseudoClass.getPseudoClass(&quot;selected&quot;);</b>
<b class="nc">&nbsp;        new ViewModelListCellFactory&lt;CitationRelationItem&gt;()</b>
<b class="nc">&nbsp;                .withGraphic(entry -&gt; {</b>
&nbsp;
<b class="nc">&nbsp;                    HBox separator = new HBox();</b>
<b class="nc">&nbsp;                    HBox.setHgrow(separator, Priority.SOMETIMES);</b>
<b class="nc">&nbsp;                    Node entryNode = BibEntryView.getEntryNode(entry.entry());</b>
<b class="nc">&nbsp;                    HBox.setHgrow(entryNode, Priority.ALWAYS);</b>
<b class="nc">&nbsp;                    HBox hContainer = new HBox();</b>
<b class="nc">&nbsp;                    hContainer.prefWidthProperty().bind(listView.widthProperty().subtract(25));</b>
&nbsp;
<b class="nc">&nbsp;                    VBox vContainer = new VBox();</b>
&nbsp;
<b class="nc">&nbsp;                    if (entry.isLocal()) {</b>
<b class="nc">&nbsp;                        hContainer.getStyleClass().add(&quot;duplicate-entry&quot;);</b>
<b class="nc">&nbsp;                        Button jumpTo = IconTheme.JabRefIcons.LINK.asButton();</b>
<b class="nc">&nbsp;                        jumpTo.setTooltip(new Tooltip(Localization.lang(&quot;Jump to entry in library&quot;)));</b>
<b class="nc">&nbsp;                        jumpTo.getStyleClass().add(&quot;addEntryButton&quot;);</b>
<b class="nc">&nbsp;                        jumpTo.setOnMouseClicked(_ -&gt; jumpToEntry(entry));</b>
<b class="nc">&nbsp;                        hContainer.setOnMouseClicked(event -&gt; {</b>
<b class="nc">&nbsp;                            if (event.getClickCount() == 2) {</b>
<b class="nc">&nbsp;                                jumpToEntry(entry);</b>
&nbsp;                            }
&nbsp;                        });
<b class="nc">&nbsp;                        vContainer.getChildren().add(jumpTo);</b>
&nbsp;
<b class="nc">&nbsp;                        Button compareButton = IconTheme.JabRefIcons.MERGE_ENTRIES.asButton();</b>
<b class="nc">&nbsp;                        compareButton.setTooltip(new Tooltip(Localization.lang(&quot;Compare with existing entry&quot;)));</b>
<b class="nc">&nbsp;                        compareButton.setOnMouseClicked(_ -&gt; openPossibleDuplicateEntriesWindow(entry, listView));</b>
<b class="nc">&nbsp;                        vContainer.getChildren().add(compareButton);</b>
&nbsp;                    } else {
<b class="nc">&nbsp;                        ToggleButton addToggle = IconTheme.JabRefIcons.ADD.asToggleButton();</b>
<b class="nc">&nbsp;                        addToggle.setTooltip(new Tooltip(Localization.lang(&quot;Select entry&quot;)));</b>
<b class="nc">&nbsp;                        EasyBind.subscribe(addToggle.selectedProperty(), selected -&gt; {</b>
<b class="nc">&nbsp;                            if (selected) {</b>
<b class="nc">&nbsp;                                addToggle.setGraphic(IconTheme.JabRefIcons.ADD_FILLED.withColor(IconTheme.SELECTED_COLOR).getGraphicNode());</b>
&nbsp;                            } else {
<b class="nc">&nbsp;                                addToggle.setGraphic(IconTheme.JabRefIcons.ADD.getGraphicNode());</b>
&nbsp;                            }
&nbsp;                        });
<b class="nc">&nbsp;                        addToggle.getStyleClass().add(&quot;addEntryButton&quot;);</b>
<b class="nc">&nbsp;                        addToggle.selectedProperty().bindBidirectional(listView.getItemBooleanProperty(entry));</b>
<b class="nc">&nbsp;                        vContainer.getChildren().add(addToggle);</b>
&nbsp;                    }
&nbsp;
<b class="nc">&nbsp;                    if (entry.entry().getDOI().isPresent() || entry.entry().getField(StandardField.URL).isPresent()) {</b>
<b class="nc">&nbsp;                        Button openWeb = IconTheme.JabRefIcons.OPEN_LINK.asButton();</b>
<b class="nc">&nbsp;                        openWeb.setTooltip(new Tooltip(Localization.lang(&quot;Open URL or DOI&quot;)));</b>
<b class="nc">&nbsp;                        openWeb.setOnMouseClicked(_ -&gt; {</b>
<b class="nc">&nbsp;                            String url = entry.entry().getDOI().flatMap(DOI::getExternalURI).map(URI::toString)</b>
<b class="nc">&nbsp;                                              .or(() -&gt; entry.entry().getField(StandardField.URL)).orElse(&quot;&quot;);</b>
<b class="nc">&nbsp;                            if (StringUtil.isNullOrEmpty(url)) {</b>
&nbsp;                                return;
&nbsp;                            }
&nbsp;                            try {
<b class="nc">&nbsp;                                NativeDesktop.openBrowser(url, preferences.getExternalApplicationsPreferences());</b>
&nbsp;                            } catch (IOException ex) {
<b class="nc">&nbsp;                                dialogService.notify(Localization.lang(&quot;Unable to open link.&quot;));</b>
&nbsp;                            }
&nbsp;                        });
<b class="nc">&nbsp;                        vContainer.getChildren().addLast(openWeb);</b>
&nbsp;                    }
&nbsp;
<b class="nc">&nbsp;                    Button showEntrySource = IconTheme.JabRefIcons.SOURCE.asButton();</b>
<b class="nc">&nbsp;                    showEntrySource.setTooltip(new Tooltip(Localization.lang(&quot;%0 source&quot;, &quot;BibTeX&quot;)));</b>
<b class="nc">&nbsp;                    showEntrySource.setOnMouseClicked(_ -&gt; showEntrySourceDialog(entry.entry()));</b>
&nbsp;
<b class="nc">&nbsp;                    vContainer.getChildren().addLast(showEntrySource);</b>
&nbsp;
<b class="nc">&nbsp;                    hContainer.getChildren().addAll(entryNode, separator, vContainer);</b>
<b class="nc">&nbsp;                    hContainer.getStyleClass().add(&quot;entry-container&quot;);</b>
&nbsp;
<b class="nc">&nbsp;                    return hContainer;</b>
&nbsp;                })
<b class="nc">&nbsp;                .withOnMouseClickedEvent((citationRelationItem, _) -&gt; {</b>
<b class="nc">&nbsp;                    if (!citationRelationItem.isLocal()) {</b>
<b class="nc">&nbsp;                        listView.getCheckModel().toggleCheckState(citationRelationItem);</b>
&nbsp;                    }
&nbsp;                })
<b class="nc">&nbsp;                .withPseudoClass(entrySelected, listView::getItemBooleanProperty)</b>
<b class="nc">&nbsp;                .install(listView);</b>
&nbsp;
<b class="nc">&nbsp;        listView.setSelectionModel(new NoSelectionModel&lt;&gt;());</b>
&nbsp;    }
&nbsp;
&nbsp;    private void jumpToEntry(CitationRelationItem entry) {
<b class="nc">&nbsp;        citingTask.cancel();</b>
<b class="nc">&nbsp;        citedByTask.cancel();</b>
<b class="nc">&nbsp;        stateManager.activeTabProperty().get().ifPresent(tab -&gt; tab.showAndEdit(entry.localEntry()));</b>
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * @implNote This code is similar to {@link PreviewWithSourceTab#getSourceString(BibEntry, BibDatabaseMode, FieldPreferences, BibEntryTypesManager)}.
&nbsp;     */
&nbsp;    private String getSourceString(BibEntry entry, BibDatabaseMode type, FieldPreferences fieldPreferences, BibEntryTypesManager entryTypesManager) throws IOException {
<b class="nc">&nbsp;        StringWriter writer = new StringWriter();</b>
<b class="nc">&nbsp;        BibWriter bibWriter = new BibWriter(writer, OS.NEWLINE);</b>
<b class="nc">&nbsp;        FieldWriter fieldWriter = FieldWriter.buildIgnoreHashes(fieldPreferences);</b>
<b class="nc">&nbsp;        new BibEntryWriter(fieldWriter, entryTypesManager).write(entry, bibWriter, type);</b>
<b class="nc">&nbsp;        return writer.toString();</b>
&nbsp;    }
&nbsp;
&nbsp;    private void showEntrySourceDialog(BibEntry entry) {
<b class="nc">&nbsp;        CodeArea ca = new CodeArea();</b>
&nbsp;        try {
<b class="nc">&nbsp;            BibDatabaseMode mode = stateManager.getActiveDatabase().map(BibDatabaseContext::getMode)</b>
<b class="nc">&nbsp;                                               .orElse(BibDatabaseMode.BIBLATEX);</b>
<b class="nc">&nbsp;            ca.appendText(getSourceString(entry, mode, preferences.getFieldPreferences(), this.entryTypesManager));</b>
&nbsp;        } catch (IOException e) {
<b class="nc">&nbsp;            LOGGER.warn(&quot;Incorrect entry, could not load source:&quot;, e);</b>
&nbsp;            return;
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        ca.setWrapText(true);</b>
<b class="nc">&nbsp;        ca.setPadding(new Insets(0, 10, 0, 10));</b>
<b class="nc">&nbsp;        ca.showParagraphAtTop(0);</b>
&nbsp;
<b class="nc">&nbsp;        ScrollPane scrollPane = new ScrollPane();</b>
<b class="nc">&nbsp;        scrollPane.setFitToWidth(true);</b>
<b class="nc">&nbsp;        scrollPane.setFitToHeight(true);</b>
<b class="nc">&nbsp;        scrollPane.setContent(new VirtualizedScrollPane&lt;&gt;(ca));</b>
&nbsp;
<b class="nc">&nbsp;        DialogPane dialogPane = new DialogPane();</b>
<b class="nc">&nbsp;        dialogPane.setPrefSize(800, 400);</b>
<b class="nc">&nbsp;        dialogPane.setContent(scrollPane);</b>
<b class="nc">&nbsp;        String title = Localization.lang(&quot;Show BibTeX source&quot;);</b>
&nbsp;
<b class="nc">&nbsp;        dialogService.showCustomDialogAndWait(title, dialogPane, ButtonType.OK);</b>
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * Method to style heading labels
&nbsp;     *
&nbsp;     * @param label       label to style
&nbsp;     * @param tooltipText tooltip text
&nbsp;     */
&nbsp;    private void styleLabel(Label label, String tooltipText) {
<b class="nc">&nbsp;        label.setStyle(&quot;-fx-padding: 5px&quot;);</b>
<b class="nc">&nbsp;        label.setAlignment(Pos.CENTER);</b>
<b class="nc">&nbsp;        label.setTooltip(new Tooltip(tooltipText));</b>
<b class="nc">&nbsp;        AnchorPane.setTopAnchor(label, 0.0);</b>
<b class="nc">&nbsp;        AnchorPane.setLeftAnchor(label, 0.0);</b>
<b class="nc">&nbsp;        AnchorPane.setBottomAnchor(label, 0.0);</b>
<b class="nc">&nbsp;        AnchorPane.setRightAnchor(label, 0.0);</b>
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * Method to style refresh buttons
&nbsp;     *
&nbsp;     * @param node node to style
&nbsp;     */
&nbsp;    private void styleTopBarNode(Node node, double offset) {
<b class="nc">&nbsp;        AnchorPane.setTopAnchor(node, 0.0);</b>
<b class="nc">&nbsp;        AnchorPane.setBottomAnchor(node, 0.0);</b>
<b class="nc">&nbsp;        AnchorPane.setRightAnchor(node, offset);</b>
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * Determines if tab should be shown according to preferences
&nbsp;     *
&nbsp;     * @param entry Currently selected BibEntry
&nbsp;     * @return whether tab should be shown
&nbsp;     */
&nbsp;    @Override
&nbsp;    public boolean shouldShow(BibEntry entry) {
&nbsp;        // TODO: Create a preference and show tab only if preference is enabled
<b class="nc">&nbsp;        return true;</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    protected void bindToEntry(BibEntry entry) {
<b class="nc">&nbsp;        setContent(getPaneAndStartSearch(entry));</b>
&nbsp;    }
&nbsp;
&nbsp;    private void searchForRelations(CitationComponents citationComponents,
&nbsp;                                    CitationComponents otherCitationComponents) {
<b class="nc">&nbsp;        if (citationComponents.entry().getDOI().isEmpty()) {</b>
<b class="nc">&nbsp;            setUpEmptyPanel(citationComponents, otherCitationComponents);</b>
&nbsp;            return;
&nbsp;        }
<b class="nc">&nbsp;        executeSearch(citationComponents);</b>
&nbsp;    }
&nbsp;
&nbsp;    private void setUpEmptyPanel(CitationComponents citationComponents,
&nbsp;                                 CitationComponents otherCitationComponents) {
<b class="nc">&nbsp;        hideNodes(citationComponents.abortButton(), citationComponents.progress());</b>
<b class="nc">&nbsp;        showNodes(citationComponents.refreshButton());</b>
&nbsp;
<b class="nc">&nbsp;        HBox hBox = new HBox();</b>
<b class="nc">&nbsp;        Label label = new Label(Localization.lang(&quot;The selected entry doesn&#39;t have a DOI linked to it.&quot;));</b>
<b class="nc">&nbsp;        Hyperlink link = new Hyperlink(Localization.lang(&quot;Look up a DOI and try again.&quot;));</b>
&nbsp;
<b class="nc">&nbsp;        link.setOnAction(e -&gt; {</b>
<b class="nc">&nbsp;            CrossRef doiFetcher = new CrossRef();</b>
&nbsp;
<b class="nc">&nbsp;            BackgroundTask.wrap(() -&gt; doiFetcher.findIdentifier(citationComponents.entry()))</b>
<b class="nc">&nbsp;                          .onRunning(() -&gt; {</b>
<b class="nc">&nbsp;                              showNodes(citationComponents.progress(), otherCitationComponents.progress());</b>
<b class="nc">&nbsp;                              setLabelOn(citationComponents.listView(), Localization.lang(&quot;Looking up DOI...&quot;));</b>
<b class="nc">&nbsp;                              setLabelOn(otherCitationComponents.listView(), Localization.lang(&quot;Looking up DOI...&quot;));</b>
&nbsp;                          })
<b class="nc">&nbsp;                          .onSuccess(identifier -&gt; {</b>
<b class="nc">&nbsp;                              if (identifier.isPresent()) {</b>
<b class="nc">&nbsp;                                  citationComponents.entry().setField(StandardField.DOI, identifier.get().asString());</b>
<b class="nc">&nbsp;                                  executeSearch(citationComponents);</b>
<b class="nc">&nbsp;                                  executeSearch(otherCitationComponents);</b>
&nbsp;                              } else {
<b class="nc">&nbsp;                                  dialogService.notify(Localization.lang(&quot;No DOI found.&quot;));</b>
<b class="nc">&nbsp;                                  setUpEmptyPanel(citationComponents, otherCitationComponents);</b>
<b class="nc">&nbsp;                                  setUpEmptyPanel(otherCitationComponents, citationComponents);</b>
&nbsp;                              }
<b class="nc">&nbsp;                          }).onFailure(ex -&gt; {</b>
<b class="nc">&nbsp;                              hideNodes(citationComponents.progress(), otherCitationComponents.progress());</b>
<b class="nc">&nbsp;                              setLabelOn(citationComponents.listView(), &quot;Error &quot; + ex.getMessage());</b>
<b class="nc">&nbsp;                              setLabelOn(otherCitationComponents.listView(), &quot;Error &quot; + ex.getMessage());</b>
<b class="nc">&nbsp;                          }).executeWith(taskExecutor);</b>
&nbsp;        });
&nbsp;
<b class="nc">&nbsp;        hBox.getChildren().add(label);</b>
<b class="nc">&nbsp;        hBox.getChildren().add(link);</b>
<b class="nc">&nbsp;        hBox.setSpacing(2d);</b>
<b class="nc">&nbsp;        hBox.setStyle(&quot;-fx-alignment: center;&quot;);</b>
<b class="nc">&nbsp;        hBox.setFillHeight(true);</b>
&nbsp;
<b class="nc">&nbsp;        citationComponents.listView().getItems().clear();</b>
<b class="nc">&nbsp;        citationComponents.listView().setPlaceholder(hBox);</b>
&nbsp;    }
&nbsp;
&nbsp;    private static void setLabelOn(CheckListView&lt;CitationRelationItem&gt; listView, String message) {
<b class="nc">&nbsp;        Label lookingUpDoiLabel = new Label(message);</b>
<b class="nc">&nbsp;        listView.getItems().clear();</b>
<b class="nc">&nbsp;        listView.setPlaceholder(lookingUpDoiLabel);</b>
&nbsp;    }
&nbsp;
&nbsp;    private void executeSearch(CitationComponents citationComponents) {
<b class="nc">&nbsp;        ObservableList&lt;CitationRelationItem&gt; observableList = FXCollections.observableArrayList();</b>
<b class="nc">&nbsp;        citationComponents.listView().setItems(observableList);</b>
&nbsp;
&nbsp;        // TODO: It should not be possible to cancel a search task that is already running for same tab
<b class="nc">&nbsp;        if (citationComponents.searchType() == CitationFetcher.SearchType.CITES &amp;&amp; citingTask != null &amp;&amp; !citingTask.isCancelled()) {</b>
<b class="nc">&nbsp;            citingTask.cancel();</b>
<b class="nc">&nbsp;        } else if (citationComponents.searchType() == CitationFetcher.SearchType.CITED_BY &amp;&amp; citedByTask != null &amp;&amp; !citedByTask.isCancelled()) {</b>
<b class="nc">&nbsp;            citedByTask.cancel();</b>
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        this.createBackgroundTask(citationComponents.entry(), citationComponents.searchType())</b>
<b class="nc">&nbsp;            .consumeOnRunning(task -&gt; prepareToSearchForRelations(citationComponents, task))</b>
<b class="nc">&nbsp;            .onSuccess(fetchedList -&gt; onSearchForRelationsSucceed(citationComponents,</b>
&nbsp;                    fetchedList,
&nbsp;                    observableList
&nbsp;            ))
<b class="nc">&nbsp;            .onFailure(exception -&gt; {</b>
<b class="nc">&nbsp;                LOGGER.error(&quot;Error while fetching {} papers&quot;, citationComponents.searchType() == CitationFetcher.SearchType.CITES ? &quot;cited&quot; : &quot;citing&quot;, exception);</b>
<b class="nc">&nbsp;                hideNodes(citationComponents.abortButton(), citationComponents.progress(), citationComponents.importButton());</b>
&nbsp;                String labelText;
<b class="nc">&nbsp;                if (citationComponents.searchType() == CitationFetcher.SearchType.CITES) {</b>
<b class="nc">&nbsp;                    labelText = Localization.lang(&quot;Error while fetching cited entries: %0&quot;, exception.getMessage());</b>
&nbsp;                } else {
<b class="nc">&nbsp;                    labelText = Localization.lang(&quot;Error while fetching citing entries: %0&quot;, exception.getMessage());</b>
&nbsp;                }
<b class="nc">&nbsp;                Label placeholder = new Label(labelText);</b>
<b class="nc">&nbsp;                placeholder.setWrapText(true);</b>
<b class="nc">&nbsp;                citationComponents.listView().setPlaceholder(placeholder);</b>
<b class="nc">&nbsp;                citationComponents.refreshButton().setVisible(true);</b>
<b class="nc">&nbsp;                dialogService.notify(exception.getMessage());</b>
&nbsp;            })
<b class="nc">&nbsp;            .executeWith(taskExecutor);</b>
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * TODO: Make the method return a callable and let the calling method create the background task.
&nbsp;     */
&nbsp;    private BackgroundTask&lt;List&lt;BibEntry&gt;&gt; createBackgroundTask(
&nbsp;            BibEntry entry, CitationFetcher.SearchType searchType
&nbsp;    ) {
<b class="nc">&nbsp;        return switch (searchType) {</b>
&nbsp;            case CitationFetcher.SearchType.CITES -&gt; {
<b class="nc">&nbsp;                citingTask = BackgroundTask.wrap(</b>
<b class="nc">&nbsp;                        () -&gt; this.searchCitationsRelationsService.searchCites(entry)</b>
&nbsp;                );
<b class="nc">&nbsp;                yield citingTask;</b>
&nbsp;            }
&nbsp;            case CitationFetcher.SearchType.CITED_BY -&gt; {
<b class="nc">&nbsp;                citedByTask = BackgroundTask.wrap(</b>
<b class="nc">&nbsp;                        () -&gt; this.searchCitationsRelationsService.searchCitedBy(entry)</b>
&nbsp;                );
<b class="nc">&nbsp;                yield citedByTask;</b>
&nbsp;            }
&nbsp;        };
&nbsp;    }
&nbsp;
&nbsp;    private void onSearchForRelationsSucceed(CitationComponents citationComponents,
&nbsp;                                             List&lt;BibEntry&gt; fetchedList,
&nbsp;                                             ObservableList&lt;CitationRelationItem&gt; observableList) {
&nbsp;
<b class="nc">&nbsp;        hideNodes(citationComponents.abortButton(), citationComponents.progress());</b>
&nbsp;
&nbsp;        // TODO: This could be a wrong database, because the user might have switched to another library
&nbsp;        //       If we were on fixing this, we would need to a) associate a BibEntry with a database or b) pass the database at &quot;bindToEntry&quot;
<b class="nc">&nbsp;        BibDatabase database = stateManager.getActiveDatabase().map(BibDatabaseContext::getDatabase).orElse(new BibDatabase());</b>
<b class="nc">&nbsp;        observableList.setAll(</b>
<b class="nc">&nbsp;                fetchedList.stream().map(entr -&gt;</b>
<b class="nc">&nbsp;                                   duplicateCheck.containsDuplicate(</b>
&nbsp;                                                         database,
&nbsp;                                                         entr,
<b class="nc">&nbsp;                                                         BibDatabaseModeDetection.inferMode(database))</b>
<b class="nc">&nbsp;                                                 .map(localEntry -&gt; new CitationRelationItem(entr, localEntry, true))</b>
<b class="nc">&nbsp;                                                 .orElseGet(() -&gt; new CitationRelationItem(entr, false)))</b>
<b class="nc">&nbsp;                           .toList()</b>
&nbsp;        );
&nbsp;
<b class="nc">&nbsp;        if (observableList.isEmpty()) {</b>
<b class="nc">&nbsp;            Label placeholder = new Label(Localization.lang(&quot;No articles found&quot;));</b>
<b class="nc">&nbsp;            citationComponents.listView().setPlaceholder(placeholder);</b>
&nbsp;        } else {
<b class="nc">&nbsp;            citationComponents.listView().refresh();</b>
&nbsp;        }
<b class="nc">&nbsp;        BooleanBinding booleanBind = Bindings.isEmpty(citationComponents.listView().getCheckModel().getCheckedItems());</b>
<b class="nc">&nbsp;        citationComponents.importButton().disableProperty().bind(booleanBind);</b>
<b class="nc">&nbsp;        citationComponents.importButton().setOnMouseClicked(event -&gt; importEntries(citationComponents.listView().getCheckModel().getCheckedItems(), citationComponents.searchType(), citationComponents.entry()));</b>
<b class="nc">&nbsp;        showNodes(citationComponents.refreshButton(), citationComponents.importButton());</b>
&nbsp;    }
&nbsp;
&nbsp;    private void prepareToSearchForRelations(CitationComponents citationComponents, BackgroundTask&lt;List&lt;BibEntry&gt;&gt; task) {
<b class="nc">&nbsp;        showNodes(citationComponents.abortButton(), citationComponents.progress());</b>
<b class="nc">&nbsp;        hideNodes(citationComponents.refreshButton(), citationComponents.importButton());</b>
&nbsp;
<b class="nc">&nbsp;        citationComponents.abortButton().setOnAction(event -&gt; {</b>
<b class="nc">&nbsp;            hideNodes(citationComponents.abortButton(), citationComponents.progress(), citationComponents.importButton());</b>
<b class="nc">&nbsp;            showNodes(citationComponents.refreshButton());</b>
<b class="nc">&nbsp;            task.cancel();</b>
<b class="nc">&nbsp;            dialogService.notify(Localization.lang(&quot;Search aborted.&quot;));</b>
&nbsp;        });
&nbsp;    }
&nbsp;
&nbsp;    private void hideNodes(Node... nodes) {
<b class="nc">&nbsp;        Arrays.stream(nodes).forEach(node -&gt; node.setVisible(false));</b>
&nbsp;    }
&nbsp;
&nbsp;    private void showNodes(Node... nodes) {
<b class="nc">&nbsp;        Arrays.stream(nodes).forEach(node -&gt; node.setVisible(true));</b>
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * Function to import selected entries to the database. Also writes the entries to import to the CITING/CITED field
&nbsp;     *
&nbsp;     * @param entriesToImport entries to import
&nbsp;     */
&nbsp;    private void importEntries(List&lt;CitationRelationItem&gt; entriesToImport, CitationFetcher.SearchType searchType, BibEntry existingEntry) {
<b class="nc">&nbsp;        citingTask.cancel();</b>
<b class="nc">&nbsp;        citedByTask.cancel();</b>
&nbsp;
<b class="nc">&nbsp;        citationsRelationsTabViewModel.importEntries(entriesToImport, searchType, existingEntry);</b>
&nbsp;
<b class="nc">&nbsp;        dialogService.notify(Localization.lang(&quot;%0 entry(s) imported&quot;, entriesToImport.size()));</b>
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * Function to open possible duplicate entries window to compare duplicate entries
&nbsp;     *
&nbsp;     * @param citationRelationItem duplicate in the citation relations tab
&nbsp;     * @param listView             CheckListView to display citations
&nbsp;     */
&nbsp;    private void openPossibleDuplicateEntriesWindow(CitationRelationItem citationRelationItem, CheckListView&lt;CitationRelationItem&gt; listView) {
<b class="nc">&nbsp;        BibEntry libraryEntry = citationRelationItem.localEntry();</b>
<b class="nc">&nbsp;        BibEntry citationEntry = citationRelationItem.entry();</b>
<b class="nc">&nbsp;        String leftHeader = Localization.lang(&quot;Library Entry&quot;);</b>
<b class="nc">&nbsp;        String rightHeader = Localization.lang(&quot;Citation Entry&quot;);</b>
&nbsp;
<b class="nc">&nbsp;        MergeEntriesDialog dialog = new MergeEntriesDialog(libraryEntry, citationEntry, leftHeader, rightHeader, preferences);</b>
<b class="nc">&nbsp;        dialog.setTitle(Localization.lang(&quot;Possible duplicate entries&quot;));</b>
&nbsp;
<b class="nc">&nbsp;        Optional&lt;EntriesMergeResult&gt; entriesMergeResult = dialogService.showCustomDialogAndWait(dialog);</b>
<b class="nc">&nbsp;        entriesMergeResult.ifPresentOrElse(mergeResult -&gt; {</b>
&nbsp;
<b class="nc">&nbsp;            BibEntry mergedEntry = mergeResult.mergedEntry();</b>
&nbsp;            // update local entry of selected citation relation item
<b class="nc">&nbsp;            listView.getItems().set(listView.getItems().indexOf(citationRelationItem), new CitationRelationItem(citationRelationItem.entry(), mergedEntry, true));</b>
&nbsp;
&nbsp;            // Merge method is similar to MergeTwoEntriesAction#execute
<b class="nc">&nbsp;            Optional&lt;LibraryTab&gt; libraryTab = stateManager.activeTabProperty().get();</b>
<b class="nc">&nbsp;            if (libraryTab.isEmpty()) {</b>
<b class="nc">&nbsp;                dialogService.notify(Localization.lang(&quot;No library present&quot;));</b>
&nbsp;                return;
&nbsp;            }
&nbsp;
<b class="nc">&nbsp;            BibDatabase database = libraryTab.get().getDatabase();</b>
<b class="nc">&nbsp;            database.removeEntry(mergeResult.originalLeftEntry());</b>
<b class="nc">&nbsp;            libraryTab.get().getMainTable().setCitationMergeMode(true);</b>
<b class="nc">&nbsp;            database.insertEntry(mergedEntry);</b>
&nbsp;
<b class="nc">&nbsp;            NamedCompoundEdit compoundEdit = new NamedCompoundEdit(Localization.lang(&quot;Merge entries&quot;));</b>
<b class="nc">&nbsp;            compoundEdit.addEdit(new UndoableRemoveEntries(database, mergeResult.originalLeftEntry()));</b>
<b class="nc">&nbsp;            compoundEdit.addEdit(new UndoableInsertEntries(database, mergedEntry));</b>
<b class="nc">&nbsp;            compoundEdit.end();</b>
&nbsp;
<b class="nc">&nbsp;            undoManager.addEdit(compoundEdit);</b>
&nbsp;
<b class="nc">&nbsp;            dialogService.notify(Localization.lang(&quot;Merged entries&quot;));</b>
<b class="nc">&nbsp;        }, () -&gt; dialogService.notify(Localization.lang(&quot;Canceled merging entries&quot;)));</b>
&nbsp;    }
&nbsp;}
</code>
</pre>
</div>

<script type="text/javascript">
(function() {
    var msie = false, msie9 = false;
    /*@cc_on
      msie = true;
      @if (@_jscript_version >= 9)
        msie9 = true;
      @end
    @*/

    if (!msie || msie && msie9) {
      hljs.highlightAll()
      hljs.initLineNumbersOnLoad();
    }
})();
</script>

<div class="footer">
    
    <div style="float:right;">generated on 2025-09-29 22:51</div>
</div>
</body>
</html>
