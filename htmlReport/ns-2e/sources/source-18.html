


<!DOCTYPE html>
<html id="htmlId">
<head>
  <meta http-equiv="Content-Type" content="text/html;charset=UTF-8"> 
  <title>Coverage Report > SourceTab</title>
  <style type="text/css">
    @import "../../css/coverage.css";
    @import "../../css/idea.min.css";
  </style>
  <script type="text/javascript" src="../../js/highlight.min.js"></script>
  <script type="text/javascript" src="../../js/highlightjs-line-numbers.min.js"></script>
</head>

<body>
<div class="content">
<div class="breadCrumbs">
Current scope:     <a href="../../index.html">all classes</a>
    <span class="separator">|</span>
    <a href="../index.html">org.jabref.gui.entryeditor</a>
</div>

<h1>Coverage Summary for Class: SourceTab (org.jabref.gui.entryeditor)</h1>

<table class="coverageStats">

<tr>
  <th class="name">Class</th>
<th class="coverageStat 
">
  Method, %
</th>
<th class="coverageStat 
">
  Branch, %
</th>
<th class="coverageStat 
">
  Line, %
</th>
</tr>
<tr>
  <td class="name">SourceTab</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/19)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/55)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/144)
  </span>
</td>
</tr>
  <tr>
    <td class="name">SourceTab$1</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/2)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">SourceTab$EditAction</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/2)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/4)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/8)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">SourceTab$InputMethodRequestsObject</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/5)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/5)
  </span>
</td>
  </tr>
<tr>
  <td class="name"><strong>Total</strong></td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/27)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/59)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/159)
  </span>
</td>
</tr>
</table>

<br/>
<br/>


<pre>
<code class="sourceCode" id="sourceCode">&nbsp;package org.jabref.gui.entryeditor;
&nbsp;
&nbsp;import java.io.IOException;
&nbsp;import java.io.Reader;
&nbsp;import java.io.StringWriter;
&nbsp;import java.util.List;
&nbsp;import java.util.Map;
&nbsp;import java.util.Objects;
&nbsp;import java.util.Optional;
&nbsp;
&nbsp;import javax.swing.undo.UndoManager;
&nbsp;
&nbsp;import javafx.application.Platform;
&nbsp;import javafx.beans.InvalidationListener;
&nbsp;import javafx.beans.property.ObjectProperty;
&nbsp;import javafx.beans.property.SimpleObjectProperty;
&nbsp;import javafx.geometry.Point2D;
&nbsp;import javafx.scene.control.ContextMenu;
&nbsp;import javafx.scene.control.Tooltip;
&nbsp;import javafx.scene.input.InputMethodRequests;
&nbsp;import javafx.scene.input.KeyEvent;
&nbsp;
&nbsp;import org.jabref.gui.DialogService;
&nbsp;import org.jabref.gui.StateManager;
&nbsp;import org.jabref.gui.actions.ActionFactory;
&nbsp;import org.jabref.gui.actions.SimpleCommand;
&nbsp;import org.jabref.gui.actions.StandardActions;
&nbsp;import org.jabref.gui.icon.IconTheme;
&nbsp;import org.jabref.gui.keyboard.CodeAreaKeyBindings;
&nbsp;import org.jabref.gui.keyboard.KeyBindingRepository;
&nbsp;import org.jabref.gui.search.Highlighter;
&nbsp;import org.jabref.gui.undo.CountingUndoManager;
&nbsp;import org.jabref.gui.undo.NamedCompoundEdit;
&nbsp;import org.jabref.gui.undo.UndoableChangeType;
&nbsp;import org.jabref.gui.undo.UndoableFieldChange;
&nbsp;import org.jabref.gui.util.UiTaskExecutor;
&nbsp;import org.jabref.logic.bibtex.BibEntryWriter;
&nbsp;import org.jabref.logic.bibtex.FieldPreferences;
&nbsp;import org.jabref.logic.bibtex.FieldWriter;
&nbsp;import org.jabref.logic.bibtex.InvalidFieldValueException;
&nbsp;import org.jabref.logic.exporter.BibWriter;
&nbsp;import org.jabref.logic.importer.ImportFormatPreferences;
&nbsp;import org.jabref.logic.importer.ParserResult;
&nbsp;import org.jabref.logic.importer.fileformat.BibtexParser;
&nbsp;import org.jabref.logic.l10n.Localization;
&nbsp;import org.jabref.model.database.BibDatabase;
&nbsp;import org.jabref.model.database.BibDatabaseContext;
&nbsp;import org.jabref.model.database.BibDatabaseMode;
&nbsp;import org.jabref.model.entry.BibEntry;
&nbsp;import org.jabref.model.entry.BibEntryTypesManager;
&nbsp;import org.jabref.model.entry.field.Field;
&nbsp;import org.jabref.model.search.query.SearchQuery;
&nbsp;import org.jabref.model.strings.StringUtil;
&nbsp;import org.jabref.model.util.FileUpdateMonitor;
&nbsp;import org.jabref.model.util.Range;
&nbsp;
&nbsp;import com.tobiasdiez.easybind.EasyBind;
&nbsp;import de.saxsys.mvvmfx.utils.validation.ObservableRuleBasedValidator;
&nbsp;import de.saxsys.mvvmfx.utils.validation.ValidationMessage;
&nbsp;import de.saxsys.mvvmfx.utils.validation.ValidationStatus;
&nbsp;import org.fxmisc.flowless.VirtualizedScrollPane;
&nbsp;import org.fxmisc.richtext.CodeArea;
&nbsp;import org.slf4j.Logger;
&nbsp;import org.slf4j.LoggerFactory;
&nbsp;
&nbsp;public class SourceTab extends EntryEditorTab {
&nbsp;
<b class="nc">&nbsp;    private static final Logger LOGGER = LoggerFactory.getLogger(SourceTab.class);</b>
&nbsp;    private static final String TEXT_STYLE = &quot;text&quot;;
&nbsp;    private static final String SEARCH_STYLE = &quot;search&quot;;
&nbsp;    private final FieldPreferences fieldPreferences;
&nbsp;    private final UndoManager undoManager;
<b class="nc">&nbsp;    private final ObjectProperty&lt;ValidationMessage&gt; sourceIsValid = new SimpleObjectProperty&lt;&gt;();</b>
<b class="nc">&nbsp;    private final ObservableRuleBasedValidator sourceValidator = new ObservableRuleBasedValidator();</b>
&nbsp;    private final ImportFormatPreferences importFormatPreferences;
&nbsp;    private final FileUpdateMonitor fileMonitor;
&nbsp;    private final DialogService dialogService;
&nbsp;    private final BibEntryTypesManager entryTypesManager;
&nbsp;    private final KeyBindingRepository keyBindingRepository;
&nbsp;    private final StateManager stateManager;
&nbsp;    private Map&lt;Field, Range&gt; fieldPositions;
&nbsp;    private CodeArea codeArea;
&nbsp;    private BibEntry previousEntry;
&nbsp;
&nbsp;    public SourceTab(CountingUndoManager undoManager,
&nbsp;                     FieldPreferences fieldPreferences,
&nbsp;                     ImportFormatPreferences importFormatPreferences,
&nbsp;                     FileUpdateMonitor fileMonitor,
&nbsp;                     DialogService dialogService,
&nbsp;                     BibEntryTypesManager entryTypesManager,
&nbsp;                     KeyBindingRepository keyBindingRepository,
<b class="nc">&nbsp;                     StateManager stateManager) {</b>
<b class="nc">&nbsp;        this.stateManager = stateManager;</b>
<b class="nc">&nbsp;        this.setGraphic(IconTheme.JabRefIcons.SOURCE.getGraphicNode());</b>
<b class="nc">&nbsp;        this.undoManager = undoManager;</b>
<b class="nc">&nbsp;        this.fieldPreferences = fieldPreferences;</b>
<b class="nc">&nbsp;        this.importFormatPreferences = importFormatPreferences;</b>
<b class="nc">&nbsp;        this.fileMonitor = fileMonitor;</b>
<b class="nc">&nbsp;        this.dialogService = dialogService;</b>
<b class="nc">&nbsp;        this.entryTypesManager = entryTypesManager;</b>
<b class="nc">&nbsp;        this.keyBindingRepository = keyBindingRepository;</b>
&nbsp;
<b class="nc">&nbsp;        EasyBind.subscribe(stateManager.activeTabProperty(), library -&gt; {</b>
<b class="nc">&nbsp;            if (library.isEmpty()) {</b>
<b class="nc">&nbsp;                this.setText(Localization.lang(&quot;Source&quot;));</b>
<b class="nc">&nbsp;                this.setTooltip(new Tooltip(Localization.lang(&quot;Show/edit source&quot;)));</b>
&nbsp;            } else {
<b class="nc">&nbsp;                BibDatabaseMode mode = stateManager.getActiveDatabase().map(BibDatabaseContext::getMode)</b>
<b class="nc">&nbsp;                                                   .orElse(BibDatabaseMode.BIBLATEX);</b>
<b class="nc">&nbsp;                this.setText(Localization.lang(&quot;%0 source&quot;, mode.getFormattedName()));</b>
<b class="nc">&nbsp;                this.setTooltip(new Tooltip(Localization.lang(&quot;Show/edit %0 source&quot;, mode.getFormattedName())));</b>
&nbsp;            }
&nbsp;        });
<b class="nc">&nbsp;        stateManager.searchQueryProperty().addListener((_, _, _) -&gt; Platform.runLater(this::highlightSearchPattern));</b>
&nbsp;    }
&nbsp;
&nbsp;    private void highlightSearchPattern() {
<b class="nc">&nbsp;        if (codeArea == null) {</b>
&nbsp;            return;
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        codeArea.setStyleClass(0, codeArea.getLength(), TEXT_STYLE);</b>
<b class="nc">&nbsp;        if (StringUtil.isBlank(stateManager.searchQueryProperty().get())) {</b>
&nbsp;            return;
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        SearchQuery searchQuery = new SearchQuery(stateManager.searchQueryProperty().get());</b>
<b class="nc">&nbsp;        Map&lt;Optional&lt;Field&gt;, List&lt;String&gt;&gt; searchTermsMap = Highlighter.groupTermsByField(searchQuery);</b>
<b class="nc">&nbsp;        searchTermsMap.forEach((optionalField, terms) -&gt; {</b>
<b class="nc">&nbsp;            Optional&lt;String&gt; searchPattern = Highlighter.buildSearchPattern(terms);</b>
<b class="nc">&nbsp;            if (searchPattern.isEmpty()) {</b>
&nbsp;                return;
&nbsp;            }
&nbsp;
<b class="nc">&nbsp;            if (optionalField.isPresent()) {</b>
<b class="nc">&nbsp;                highlightField(optionalField.get(), searchPattern.get());</b>
&nbsp;            } else {
<b class="nc">&nbsp;                fieldPositions.keySet().forEach(field -&gt; highlightField(field, searchPattern.get()));</b>
&nbsp;            }
&nbsp;        });
&nbsp;    }
&nbsp;
&nbsp;    private void highlightField(Field field, String searchPattern) {
<b class="nc">&nbsp;        Range fieldPosition = fieldPositions.get(field);</b>
<b class="nc">&nbsp;        if (fieldPosition == null) {</b>
&nbsp;            return;
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        int start = fieldPosition.start();</b>
<b class="nc">&nbsp;        int end = fieldPosition.end();</b>
<b class="nc">&nbsp;        List&lt;Range&gt; matchedPositions = Highlighter.findMatchPositions(codeArea.getText(start, end), searchPattern);</b>
&nbsp;
<b class="nc">&nbsp;        for (Range range : matchedPositions) {</b>
<b class="nc">&nbsp;            codeArea.setStyleClass(start + range.start() - 1, start + range.end(), SEARCH_STYLE);</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    private String getSourceString(BibEntry entry, BibDatabaseMode type, FieldPreferences fieldPreferences) throws IOException {
<b class="nc">&nbsp;        StringWriter writer = new StringWriter();</b>
<b class="nc">&nbsp;        BibWriter bibWriter = new BibWriter(writer, &quot;\n&quot;); // JavaFX works with LF only</b>
<b class="nc">&nbsp;        FieldWriter fieldWriter = FieldWriter.buildIgnoreHashes(fieldPreferences);</b>
<b class="nc">&nbsp;        BibEntryWriter bibEntryWriter = new BibEntryWriter(fieldWriter, entryTypesManager);</b>
<b class="nc">&nbsp;        bibEntryWriter.write(entry, bibWriter, type, true);</b>
<b class="nc">&nbsp;        fieldPositions = bibEntryWriter.getFieldPositions();</b>
<b class="nc">&nbsp;        String sourceString = writer.toString();</b>
&nbsp;        writer.close();
<b class="nc">&nbsp;        return sourceString;</b>
&nbsp;    }
&nbsp;
&nbsp;    /* Work around for different input methods.
&nbsp;     * https://github.com/FXMisc/RichTextFX/issues/146
&nbsp;     */
<b class="nc">&nbsp;    private static class InputMethodRequestsObject implements InputMethodRequests {</b>
&nbsp;
&nbsp;        @Override
&nbsp;        public String getSelectedText() {
<b class="nc">&nbsp;            return &quot;&quot;;</b>
&nbsp;        }
&nbsp;
&nbsp;        @Override
&nbsp;        public int getLocationOffset(int x, int y) {
<b class="nc">&nbsp;            return 0;</b>
&nbsp;        }
&nbsp;
&nbsp;        @Override
&nbsp;        public void cancelLatestCommittedText() {
<b class="nc">&nbsp;        }</b>
&nbsp;
&nbsp;        @Override
&nbsp;        public Point2D getTextLocation(int offset) {
<b class="nc">&nbsp;            return new Point2D(0, 0);</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    private void setupSourceEditor() {
<b class="nc">&nbsp;        codeArea = new CodeArea();</b>
<b class="nc">&nbsp;        codeArea.setWrapText(true);</b>
<b class="nc">&nbsp;        codeArea.setInputMethodRequests(new InputMethodRequestsObject());</b>
<b class="nc">&nbsp;        codeArea.setOnInputMethodTextChanged(event -&gt; {</b>
<b class="nc">&nbsp;            String committed = event.getCommitted();</b>
<b class="nc">&nbsp;            if (!committed.isEmpty()) {</b>
<b class="nc">&nbsp;                codeArea.insertText(codeArea.getCaretPosition(), committed);</b>
&nbsp;            }
&nbsp;        });
<b class="nc">&nbsp;        codeArea.setId(&quot;bibtexSourceCodeArea&quot;);</b>
<b class="nc">&nbsp;        codeArea.addEventFilter(KeyEvent.KEY_PRESSED, event -&gt; CodeAreaKeyBindings.call(codeArea, event, keyBindingRepository));</b>
<b class="nc">&nbsp;        codeArea.addEventFilter(KeyEvent.KEY_PRESSED, this::listenForSaveKeybinding);</b>
&nbsp;
<b class="nc">&nbsp;        ActionFactory factory = new ActionFactory();</b>
<b class="nc">&nbsp;        ContextMenu contextMenu = new ContextMenu();</b>
<b class="nc">&nbsp;        contextMenu.getItems().addAll(</b>
<b class="nc">&nbsp;                factory.createMenuItem(StandardActions.CUT, new EditAction(StandardActions.CUT)),</b>
<b class="nc">&nbsp;                factory.createMenuItem(StandardActions.COPY, new EditAction(StandardActions.COPY)),</b>
<b class="nc">&nbsp;                factory.createMenuItem(StandardActions.PASTE, new EditAction(StandardActions.PASTE)),</b>
<b class="nc">&nbsp;                factory.createMenuItem(StandardActions.SELECT_ALL, new EditAction(StandardActions.SELECT_ALL))</b>
&nbsp;        );
&nbsp;
<b class="nc">&nbsp;        contextMenu.getStyleClass().add(&quot;context-menu&quot;);</b>
<b class="nc">&nbsp;        codeArea.setContextMenu(contextMenu);</b>
&nbsp;
<b class="nc">&nbsp;        sourceValidator.addRule(sourceIsValid);</b>
&nbsp;
<b class="nc">&nbsp;        sourceValidator.getValidationStatus().getMessages().addListener((InvalidationListener) c -&gt; {</b>
<b class="nc">&nbsp;            ValidationStatus sourceValidationStatus = sourceValidator.getValidationStatus();</b>
<b class="nc">&nbsp;            if (!sourceValidationStatus.isValid()) {</b>
<b class="nc">&nbsp;                sourceValidationStatus.getHighestMessage().ifPresent(message -&gt; {</b>
<b class="nc">&nbsp;                    String content = Localization.lang(&quot;User input via entry-editor in `{}bibtex source` tab led to failure.&quot;)</b>
<b class="nc">&nbsp;                            + &quot;\n&quot; + Localization.lang(&quot;Please check your library file for wrong syntax.&quot;)</b>
<b class="nc">&nbsp;                            + &quot;\n\n&quot; + message.getMessage();</b>
<b class="nc">&nbsp;                    dialogService.showWarningDialogAndWait(Localization.lang(&quot;SourceTab error&quot;), content);</b>
&nbsp;                });
&nbsp;            }
&nbsp;        });
&nbsp;
<b class="nc">&nbsp;        codeArea.focusedProperty().addListener((obs, oldValue, onFocus) -&gt; {</b>
<b class="nc">&nbsp;            if (!onFocus &amp;&amp; (currentEntry != null)) {</b>
<b class="nc">&nbsp;                storeSource(currentEntry, codeArea.textProperty().getValue());</b>
&nbsp;            }
&nbsp;        });
<b class="nc">&nbsp;        VirtualizedScrollPane&lt;CodeArea&gt; scrollableCodeArea = new VirtualizedScrollPane&lt;&gt;(codeArea);</b>
<b class="nc">&nbsp;        this.setContent(scrollableCodeArea);</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public boolean shouldShow(BibEntry entry) {
<b class="nc">&nbsp;        return true;</b>
&nbsp;    }
&nbsp;
&nbsp;    private void updateCodeArea() {
<b class="nc">&nbsp;        UiTaskExecutor.runAndWaitInJavaFXThread(() -&gt; {</b>
<b class="nc">&nbsp;            if (codeArea == null) {</b>
<b class="nc">&nbsp;                setupSourceEditor();</b>
&nbsp;            }
&nbsp;
<b class="nc">&nbsp;            BibDatabaseMode mode = stateManager.getActiveDatabase().map(BibDatabaseContext::getMode)</b>
<b class="nc">&nbsp;                                               .orElse(BibDatabaseMode.BIBLATEX);</b>
&nbsp;
<b class="nc">&nbsp;            codeArea.clear();</b>
&nbsp;            try {
<b class="nc">&nbsp;                codeArea.appendText(getSourceString(currentEntry, mode, fieldPreferences));</b>
<b class="nc">&nbsp;                codeArea.setEditable(true);</b>
<b class="nc">&nbsp;                Platform.runLater(this::highlightSearchPattern);</b>
&nbsp;            } catch (IOException ex) {
<b class="nc">&nbsp;                codeArea.setEditable(false);</b>
<b class="nc">&nbsp;                codeArea.appendText(ex.getMessage() + &quot;\n\n&quot; +</b>
<b class="nc">&nbsp;                        Localization.lang(&quot;Correct the entry, and reopen editor to display/edit source.&quot;));</b>
<b class="nc">&nbsp;                LOGGER.debug(&quot;Incorrect entry&quot;, ex);</b>
&nbsp;            }
&nbsp;        });
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    protected void bindToEntry(BibEntry entry) {
<b class="nc">&nbsp;        if ((previousEntry != null) &amp;&amp; (codeArea != null)) {</b>
<b class="nc">&nbsp;            storeSource(previousEntry, codeArea.textProperty().getValue());</b>
&nbsp;        }
<b class="nc">&nbsp;        this.previousEntry = entry;</b>
&nbsp;
<b class="nc">&nbsp;        updateCodeArea();</b>
&nbsp;
<b class="nc">&nbsp;        entry.typeProperty().addListener(listener -&gt; updateCodeArea());</b>
<b class="nc">&nbsp;        entry.getFieldsObservable().addListener((InvalidationListener) listener -&gt; updateCodeArea());</b>
&nbsp;    }
&nbsp;
&nbsp;    private void storeSource(BibEntry outOfFocusEntry, String text) {
<b class="nc">&nbsp;        if ((outOfFocusEntry == null) || text.isEmpty()) {</b>
&nbsp;            return;
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        BibtexParser bibtexParser = new BibtexParser(importFormatPreferences, fileMonitor);</b>
&nbsp;        try {
<b class="nc">&nbsp;            ParserResult parserResult = bibtexParser.parse(Reader.of(text));</b>
<b class="nc">&nbsp;            BibDatabase database = parserResult.getDatabase();</b>
&nbsp;
<b class="nc">&nbsp;            if (database.getEntryCount() &gt; 1) {</b>
<b class="nc">&nbsp;                throw new IllegalStateException(&quot;More than one entry found.&quot;);</b>
&nbsp;            }
&nbsp;
<b class="nc">&nbsp;            if (!database.hasEntries()) {</b>
<b class="nc">&nbsp;                if (parserResult.hasWarnings()) {</b>
&nbsp;                    // put the warning into as exception text -&gt; it will be displayed to the user
<b class="nc">&nbsp;                    throw new IllegalStateException(parserResult.warnings().getFirst());</b>
&nbsp;                } else {
<b class="nc">&nbsp;                    throw new IllegalStateException(&quot;No entries found.&quot;);</b>
&nbsp;                }
&nbsp;            }
&nbsp;
<b class="nc">&nbsp;            if (parserResult.hasWarnings()) {</b>
&nbsp;                // put the warning into as exception text -&gt; it will be displayed to the user
<b class="nc">&nbsp;                throw new IllegalStateException(parserResult.getErrorMessage());</b>
&nbsp;            }
&nbsp;
<b class="nc">&nbsp;            NamedCompoundEdit compound = new NamedCompoundEdit(Localization.lang(&quot;source edit&quot;));</b>
<b class="nc">&nbsp;            BibEntry newEntry = database.getEntries().getFirst();</b>
<b class="nc">&nbsp;            String newKey = newEntry.getCitationKey().orElse(null);</b>
&nbsp;
<b class="nc">&nbsp;            if (newKey != null) {</b>
<b class="nc">&nbsp;                outOfFocusEntry.setCitationKey(newKey);</b>
&nbsp;            } else {
<b class="nc">&nbsp;                outOfFocusEntry.clearCiteKey();</b>
&nbsp;            }
&nbsp;
&nbsp;            // First, remove fields that the user has removed.
<b class="nc">&nbsp;            for (Map.Entry&lt;Field, String&gt; field : outOfFocusEntry.getFieldMap().entrySet()) {</b>
<b class="nc">&nbsp;                Field fieldName = field.getKey();</b>
<b class="nc">&nbsp;                String fieldValue = field.getValue();</b>
&nbsp;
<b class="nc">&nbsp;                if (!newEntry.hasField(fieldName)) {</b>
<b class="nc">&nbsp;                    compound.addEdit(new UndoableFieldChange(outOfFocusEntry, fieldName, fieldValue, null));</b>
<b class="nc">&nbsp;                    outOfFocusEntry.clearField(fieldName);</b>
&nbsp;                }
&nbsp;            }
&nbsp;
&nbsp;            // Then set all fields that have been set by the user.
<b class="nc">&nbsp;            for (Map.Entry&lt;Field, String&gt; field : newEntry.getFieldMap().entrySet()) {</b>
<b class="nc">&nbsp;                Field fieldName = field.getKey();</b>
<b class="nc">&nbsp;                String oldValue = outOfFocusEntry.getField(fieldName).orElse(null);</b>
<b class="nc">&nbsp;                String newValue = field.getValue();</b>
<b class="nc">&nbsp;                if (!Objects.equals(oldValue, newValue)) {</b>
&nbsp;                    // Test if the field is legally set.
<b class="nc">&nbsp;                    new FieldWriter(fieldPreferences).write(fieldName, newValue);</b>
&nbsp;
<b class="nc">&nbsp;                    compound.addEdit(new UndoableFieldChange(outOfFocusEntry, fieldName, oldValue, newValue));</b>
<b class="nc">&nbsp;                    outOfFocusEntry.setField(fieldName, newValue);</b>
&nbsp;                }
&nbsp;            }
&nbsp;
&nbsp;            // See if the user has changed the entry type:
<b class="nc">&nbsp;            if (!Objects.equals(newEntry.getType(), outOfFocusEntry.getType())) {</b>
<b class="nc">&nbsp;                compound.addEdit(new UndoableChangeType(outOfFocusEntry, outOfFocusEntry.getType(), newEntry.getType()));</b>
<b class="nc">&nbsp;                outOfFocusEntry.setType(newEntry.getType());</b>
&nbsp;            }
<b class="nc">&nbsp;            compound.end();</b>
<b class="nc">&nbsp;            undoManager.addEdit(compound);</b>
&nbsp;
<b class="nc">&nbsp;            sourceIsValid.setValue(null);</b>
&nbsp;        } catch (InvalidFieldValueException | IllegalStateException | IOException ex) {
<b class="nc">&nbsp;            sourceIsValid.setValue(ValidationMessage.error(Localization.lang(&quot;Problem with parsing entry&quot;) + &quot;: &quot; + ex.getMessage()));</b>
<b class="nc">&nbsp;            LOGGER.debug(&quot;Incorrect source&quot;, ex);</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    private void listenForSaveKeybinding(KeyEvent event) {
<b class="nc">&nbsp;        keyBindingRepository.mapToKeyBinding(event).ifPresent(binding -&gt; {</b>
<b class="nc">&nbsp;            switch (binding) {</b>
&nbsp;                case SAVE_DATABASE,
&nbsp;                     SAVE_ALL,
&nbsp;                     SAVE_DATABASE_AS -&gt;
<b class="nc">&nbsp;                        storeSource(currentEntry, codeArea.textProperty().getValue());</b>
&nbsp;            }
&nbsp;        });
&nbsp;    }
&nbsp;
&nbsp;    private class EditAction extends SimpleCommand {
&nbsp;
&nbsp;        private final StandardActions command;
&nbsp;
<b class="nc">&nbsp;        public EditAction(StandardActions command) {</b>
<b class="nc">&nbsp;            this.command = command;</b>
&nbsp;        }
&nbsp;
&nbsp;        @Override
&nbsp;        public void execute() {
<b class="nc">&nbsp;            switch (command) {</b>
&nbsp;                case COPY -&gt;
<b class="nc">&nbsp;                        codeArea.copy();</b>
&nbsp;                case CUT -&gt;
<b class="nc">&nbsp;                        codeArea.cut();</b>
&nbsp;                case PASTE -&gt;
<b class="nc">&nbsp;                        codeArea.paste();</b>
&nbsp;                case SELECT_ALL -&gt;
<b class="nc">&nbsp;                        codeArea.selectAll();</b>
&nbsp;            }
<b class="nc">&nbsp;            codeArea.requestFocus();</b>
&nbsp;        }
&nbsp;    }
&nbsp;}
</code>
</pre>
</div>

<script type="text/javascript">
(function() {
    var msie = false, msie9 = false;
    /*@cc_on
      msie = true;
      @if (@_jscript_version >= 9)
        msie9 = true;
      @end
    @*/

    if (!msie || msie && msie9) {
      hljs.highlightAll()
      hljs.initLineNumbersOnLoad();
    }
})();
</script>

<div class="footer">
    
    <div style="float:right;">generated on 2025-09-29 22:51</div>
</div>
</body>
</html>
