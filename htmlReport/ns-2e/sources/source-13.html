


<!DOCTYPE html>
<html id="htmlId">
<head>
  <meta http-equiv="Content-Type" content="text/html;charset=UTF-8"> 
  <title>Coverage Report > RelatedArticlesTab</title>
  <style type="text/css">
    @import "../../css/coverage.css";
    @import "../../css/idea.min.css";
  </style>
  <script type="text/javascript" src="../../js/highlight.min.js"></script>
  <script type="text/javascript" src="../../js/highlightjs-line-numbers.min.js"></script>
</head>

<body>
<div class="content">
<div class="breadCrumbs">
Current scope:     <a href="../../index.html">all classes</a>
    <span class="separator">|</span>
    <a href="../index.html">org.jabref.gui.entryeditor</a>
</div>

<h1>Coverage Summary for Class: RelatedArticlesTab (org.jabref.gui.entryeditor)</h1>

<table class="coverageStats">
<tr>
  <th class="name">Class</th>
<th class="coverageStat 
">
  Class, %
</th>
<th class="coverageStat 
">
  Method, %
</th>
<th class="coverageStat 
">
  Branch, %
</th>
<th class="coverageStat 
">
  Line, %
</th>
</tr>
<tr>
  <td class="name">RelatedArticlesTab</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/14)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/6)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/130)
  </span>
</td>
</tr>

</table>

<br/>
<br/>


<pre>
<code class="sourceCode" id="sourceCode">&nbsp;package org.jabref.gui.entryeditor;
&nbsp;
&nbsp;import java.io.IOException;
&nbsp;import java.util.List;
&nbsp;
&nbsp;import javafx.beans.binding.Bindings;
&nbsp;import javafx.beans.binding.DoubleBinding;
&nbsp;import javafx.scene.control.Button;
&nbsp;import javafx.scene.control.CheckBox;
&nbsp;import javafx.scene.control.Hyperlink;
&nbsp;import javafx.scene.control.ProgressIndicator;
&nbsp;import javafx.scene.control.ScrollPane;
&nbsp;import javafx.scene.control.Tooltip;
&nbsp;import javafx.scene.layout.HBox;
&nbsp;import javafx.scene.layout.StackPane;
&nbsp;import javafx.scene.layout.VBox;
&nbsp;import javafx.scene.text.Font;
&nbsp;import javafx.scene.text.FontPosture;
&nbsp;import javafx.scene.text.Text;
&nbsp;
&nbsp;import org.jabref.gui.DialogService;
&nbsp;import org.jabref.gui.StateManager;
&nbsp;import org.jabref.gui.desktop.os.NativeDesktop;
&nbsp;import org.jabref.gui.preferences.GuiPreferences;
&nbsp;import org.jabref.logic.importer.ImportCleanup;
&nbsp;import org.jabref.logic.importer.fetcher.MrDLibFetcher;
&nbsp;import org.jabref.logic.importer.fetcher.MrDlibPreferences;
&nbsp;import org.jabref.logic.l10n.Localization;
&nbsp;import org.jabref.logic.util.BackgroundTask;
&nbsp;import org.jabref.logic.util.BuildInfo;
&nbsp;import org.jabref.logic.util.TaskExecutor;
&nbsp;import org.jabref.model.database.BibDatabaseContext;
&nbsp;import org.jabref.model.database.BibDatabaseMode;
&nbsp;import org.jabref.model.entry.BibEntry;
&nbsp;import org.jabref.model.entry.field.StandardField;
&nbsp;
&nbsp;import org.slf4j.Logger;
&nbsp;import org.slf4j.LoggerFactory;
&nbsp;
&nbsp;/**
&nbsp; * Tab displaying article recommendations based on the currently selected BibEntry
&nbsp; */
&nbsp;public class RelatedArticlesTab extends EntryEditorTab {
&nbsp;
&nbsp;    public static final String NAME = &quot;Related articles&quot;;
<b class="nc">&nbsp;    private static final Logger LOGGER = LoggerFactory.getLogger(RelatedArticlesTab.class);</b>
&nbsp;
&nbsp;    private final DialogService dialogService;
&nbsp;    private final BuildInfo buildInfo;
&nbsp;    private final StateManager stateManager;
&nbsp;    private final TaskExecutor taskExecutor;
&nbsp;
&nbsp;    private final GuiPreferences preferences;
&nbsp;
&nbsp;    public RelatedArticlesTab(BuildInfo buildInfo,
&nbsp;                              GuiPreferences preferences,
&nbsp;                              DialogService dialogService,
&nbsp;                              StateManager stateManager,
<b class="nc">&nbsp;                              TaskExecutor taskExecutor) {</b>
<b class="nc">&nbsp;        this.dialogService = dialogService;</b>
<b class="nc">&nbsp;        this.buildInfo = buildInfo;</b>
<b class="nc">&nbsp;        this.stateManager = stateManager;</b>
<b class="nc">&nbsp;        this.taskExecutor = taskExecutor;</b>
&nbsp;
<b class="nc">&nbsp;        this.preferences = preferences;</b>
&nbsp;
<b class="nc">&nbsp;        setText(Localization.lang(&quot;Related articles&quot;));</b>
<b class="nc">&nbsp;        setTooltip(new Tooltip(Localization.lang(&quot;Related articles&quot;)));</b>
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * Gets a StackPane of related article information to be displayed in the Related Articles tab
&nbsp;     *
&nbsp;     * @param entry The currently selected BibEntry on the JabRef UI.
&nbsp;     * @return A StackPane with related article information to be displayed in the Related Articles tab.
&nbsp;     */
&nbsp;    private StackPane getRelatedArticlesPane(BibEntry entry) {
<b class="nc">&nbsp;        StackPane root = new StackPane();</b>
<b class="nc">&nbsp;        root.setId(&quot;related-articles-tab&quot;);</b>
<b class="nc">&nbsp;        ProgressIndicator progress = new ProgressIndicator();</b>
<b class="nc">&nbsp;        progress.setMaxSize(100, 100);</b>
&nbsp;
<b class="nc">&nbsp;        BibDatabaseMode mode = stateManager.getActiveDatabase().map(BibDatabaseContext::getMode)</b>
<b class="nc">&nbsp;                                           .orElse(BibDatabaseMode.BIBLATEX);</b>
&nbsp;
<b class="nc">&nbsp;        MrDLibFetcher fetcher = new MrDLibFetcher(</b>
<b class="nc">&nbsp;                preferences.getWorkspacePreferences().getLanguage().name(),</b>
&nbsp;                buildInfo.version,
<b class="nc">&nbsp;                preferences.getMrDlibPreferences());</b>
<b class="nc">&nbsp;        BackgroundTask</b>
<b class="nc">&nbsp;                .wrap(() -&gt; fetcher.performSearch(entry))</b>
<b class="nc">&nbsp;                .onRunning(() -&gt; progress.setVisible(true))</b>
<b class="nc">&nbsp;                .onSuccess(relatedArticles -&gt; {</b>
&nbsp;
<b class="nc">&nbsp;                    ImportCleanup cleanup = ImportCleanup.targeting(mode, preferences.getFieldPreferences());</b>
<b class="nc">&nbsp;                    cleanup.doPostCleanup(relatedArticles);</b>
<b class="nc">&nbsp;                    progress.setVisible(false);</b>
<b class="nc">&nbsp;                    root.getChildren().add(getRelatedArticleInfo(relatedArticles, fetcher));</b>
&nbsp;                })
<b class="nc">&nbsp;                .onFailure(exception -&gt; {</b>
<b class="nc">&nbsp;                    LOGGER.error(&quot;Error while fetching from Mr. DLib&quot;, exception);</b>
<b class="nc">&nbsp;                    progress.setVisible(false);</b>
<b class="nc">&nbsp;                    root.getChildren().add(getErrorInfo());</b>
&nbsp;                })
<b class="nc">&nbsp;                .executeWith(taskExecutor);</b>
&nbsp;
<b class="nc">&nbsp;        root.getChildren().add(progress);</b>
&nbsp;
<b class="nc">&nbsp;        return root;</b>
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * Creates a VBox of the related article information to be used in the StackPane displayed in the Related Articles tab
&nbsp;     *
&nbsp;     * @param list List of BibEntries of related articles
&nbsp;     * @return VBox of related article descriptions to be displayed in the Related Articles tab
&nbsp;     */
&nbsp;    private ScrollPane getRelatedArticleInfo(List&lt;BibEntry&gt; list, MrDLibFetcher fetcher) {
<b class="nc">&nbsp;        ScrollPane scrollPane = new ScrollPane();</b>
&nbsp;
<b class="nc">&nbsp;        VBox vBox = new VBox();</b>
<b class="nc">&nbsp;        vBox.setSpacing(20.0);</b>
&nbsp;
<b class="nc">&nbsp;        String heading = fetcher.getHeading();</b>
<b class="nc">&nbsp;        Text headingText = new Text(heading);</b>
<b class="nc">&nbsp;        headingText.getStyleClass().add(&quot;heading&quot;);</b>
<b class="nc">&nbsp;        String description = fetcher.getDescription();</b>
<b class="nc">&nbsp;        Text descriptionText = new Text(description);</b>
<b class="nc">&nbsp;        descriptionText.getStyleClass().add(&quot;description&quot;);</b>
<b class="nc">&nbsp;        vBox.getChildren().add(headingText);</b>
<b class="nc">&nbsp;        vBox.getChildren().add(descriptionText);</b>
&nbsp;
<b class="nc">&nbsp;        for (BibEntry entry : list) {</b>
<b class="nc">&nbsp;            HBox hBox = new HBox();</b>
<b class="nc">&nbsp;            hBox.setSpacing(5.0);</b>
<b class="nc">&nbsp;            hBox.getStyleClass().add(&quot;recommendation-item&quot;);</b>
&nbsp;
<b class="nc">&nbsp;            String title = entry.getTitle().orElse(&quot;&quot;);</b>
<b class="nc">&nbsp;            String journal = entry.getField(StandardField.JOURNAL).orElse(&quot;&quot;);</b>
<b class="nc">&nbsp;            String authors = entry.getField(StandardField.AUTHOR).orElse(&quot;&quot;);</b>
<b class="nc">&nbsp;            String year = entry.getField(StandardField.YEAR).orElse(&quot;&quot;);</b>
&nbsp;
<b class="nc">&nbsp;            Hyperlink titleLink = new Hyperlink(title);</b>
<b class="nc">&nbsp;            Text journalText = new Text(journal);</b>
<b class="nc">&nbsp;            journalText.setFont(Font.font(Font.getDefault().getFamily(), FontPosture.ITALIC, Font.getDefault().getSize()));</b>
<b class="nc">&nbsp;            Text authorsText = new Text(authors);</b>
<b class="nc">&nbsp;            Text yearText = new Text(&quot;(&quot; + year + &quot;)&quot;);</b>
<b class="nc">&nbsp;            titleLink.setOnAction(event -&gt; {</b>
<b class="nc">&nbsp;                if (entry.getField(StandardField.URL).isPresent()) {</b>
&nbsp;                    try {
<b class="nc">&nbsp;                        NativeDesktop.openBrowser(entry.getField(StandardField.URL).get(), preferences.getExternalApplicationsPreferences());</b>
&nbsp;                    } catch (IOException e) {
<b class="nc">&nbsp;                        LOGGER.error(&quot;Error opening the browser to: {}&quot;, entry.getField(StandardField.URL).get(), e);</b>
<b class="nc">&nbsp;                        dialogService.showErrorDialogAndWait(e);</b>
&nbsp;                    }
&nbsp;                }
&nbsp;            });
&nbsp;
<b class="nc">&nbsp;            hBox.getChildren().addAll(titleLink, journalText, authorsText, yearText);</b>
<b class="nc">&nbsp;            vBox.getChildren().add(hBox);</b>
&nbsp;        }
<b class="nc">&nbsp;        scrollPane.setContent(vBox);</b>
<b class="nc">&nbsp;        return scrollPane;</b>
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * Gets a ScrollPane to display error info when recommendations fail.
&nbsp;     *
&nbsp;     * @return ScrollPane to display in place of recommendations
&nbsp;     */
&nbsp;    private ScrollPane getErrorInfo() {
<b class="nc">&nbsp;        ScrollPane scrollPane = new ScrollPane();</b>
&nbsp;
<b class="nc">&nbsp;        VBox vBox = new VBox();</b>
<b class="nc">&nbsp;        vBox.setSpacing(20.0);</b>
&nbsp;
<b class="nc">&nbsp;        Text descriptionText = new Text(Localization.lang(&quot;No recommendations received from Mr. DLib for this entry.&quot;));</b>
<b class="nc">&nbsp;        descriptionText.getStyleClass().add(&quot;description&quot;);</b>
<b class="nc">&nbsp;        vBox.getChildren().add(descriptionText);</b>
<b class="nc">&nbsp;        scrollPane.setContent(vBox);</b>
&nbsp;
<b class="nc">&nbsp;        return scrollPane;</b>
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * Returns a consent dialog used to ask permission to send data to Mr. DLib.
&nbsp;     *
&nbsp;     * @param entry Currently selected BibEntry. (required to allow reloading of pane if accepted)
&nbsp;     * @return StackPane returned to be placed into Related Articles tab.
&nbsp;     */
&nbsp;    private ScrollPane getPrivacyDialog(BibEntry entry) {
<b class="nc">&nbsp;        ScrollPane root = new ScrollPane();</b>
<b class="nc">&nbsp;        root.setId(&quot;related-articles-tab&quot;);</b>
<b class="nc">&nbsp;        VBox vbox = new VBox();</b>
<b class="nc">&nbsp;        vbox.getStyleClass().add(&quot;gdpr-notice&quot;);</b>
<b class="nc">&nbsp;        vbox.setSpacing(20.0);</b>
&nbsp;
<b class="nc">&nbsp;        HBox hbox = new HBox();</b>
<b class="nc">&nbsp;        hbox.setSpacing(10.0);</b>
&nbsp;
<b class="nc">&nbsp;        Text title = new Text(Localization.lang(&quot;Mr. DLib Privacy settings&quot;));</b>
<b class="nc">&nbsp;        title.getStyleClass().add(&quot;heading&quot;);</b>
&nbsp;
<b class="nc">&nbsp;        Button button = new Button(Localization.lang(&quot;I Agree&quot;));</b>
<b class="nc">&nbsp;        button.setDefaultButton(true);</b>
&nbsp;
<b class="nc">&nbsp;        Button hideTab = new Button(Localization.lang(&quot;Hide &#39;Related articles&#39; tab&quot;));</b>
&nbsp;
<b class="nc">&nbsp;        DoubleBinding rootWidth = Bindings.subtract(root.widthProperty(), 88d);</b>
&nbsp;
<b class="nc">&nbsp;        Text line1 = new Text(Localization.lang(&quot;JabRef requests recommendations from Mr. DLib, which is an external service. To enable Mr. DLib to calculate recommendations, some of your data must be shared with Mr. DLib. Generally, the more data is shared the better recommendations can be calculated. However, we understand that some of your data in JabRef is sensitive, and you may not want to share it. Therefore, Mr. DLib offers a choice of which data you would like to share.&quot;));</b>
<b class="nc">&nbsp;        line1.wrappingWidthProperty().bind(rootWidth);</b>
<b class="nc">&nbsp;        Text line2 = new Text(Localization.lang(&quot;Whatever option you choose, Mr. DLib may share its data with research partners to further improve recommendation quality as part of a &#39;living lab&#39;. Mr. DLib may also release public datasets that may contain anonymized information about you and the recommendations (sensitive information such as metadata of your articles will be anonymised through e.g. hashing). Research partners are obliged to adhere to the same strict data protection policy as Mr. DLib.&quot;));</b>
<b class="nc">&nbsp;        line2.wrappingWidthProperty().bind(rootWidth);</b>
<b class="nc">&nbsp;        Text line3 = new Text(Localization.lang(&quot;This setting may be changed in preferences at any time.&quot;));</b>
<b class="nc">&nbsp;        line3.wrappingWidthProperty().bind(rootWidth);</b>
<b class="nc">&nbsp;        Hyperlink mdlLink = new Hyperlink(Localization.lang(&quot;Further information about Mr. DLib for JabRef users.&quot;));</b>
<b class="nc">&nbsp;        mdlLink.setOnAction(event -&gt; {</b>
&nbsp;            try {
<b class="nc">&nbsp;                NativeDesktop.openBrowser(&quot;http://mr-dlib.org/information-for-users/information-about-mr-dlib-for-jabref-users/&quot;, preferences.getExternalApplicationsPreferences());</b>
&nbsp;            } catch (IOException e) {
<b class="nc">&nbsp;                LOGGER.error(&quot;Error opening the browser to Mr. DLib information page.&quot;, e);</b>
<b class="nc">&nbsp;                dialogService.showErrorDialogAndWait(e);</b>
&nbsp;            }
&nbsp;        });
<b class="nc">&nbsp;        VBox vb = new VBox();</b>
<b class="nc">&nbsp;        CheckBox cbTitle = new CheckBox(Localization.lang(&quot;Entry Title (Required to deliver recommendations.)&quot;));</b>
<b class="nc">&nbsp;        cbTitle.setSelected(true);</b>
<b class="nc">&nbsp;        cbTitle.setDisable(true);</b>
<b class="nc">&nbsp;        CheckBox cbVersion = new CheckBox(Localization.lang(&quot;JabRef Version (Required to ensure backwards compatibility with Mr. DLib&#39;s Web Service)&quot;));</b>
<b class="nc">&nbsp;        cbVersion.setSelected(true);</b>
<b class="nc">&nbsp;        cbVersion.setDisable(true);</b>
<b class="nc">&nbsp;        CheckBox cbLanguage = new CheckBox(Localization.lang(&quot;JabRef Language (Provides for better recommendations by giving an indication of user&#39;s preferred language.)&quot;));</b>
<b class="nc">&nbsp;        CheckBox cbOS = new CheckBox(Localization.lang(&quot;Operating System (Provides for better recommendations by giving an indication of user&#39;s system set-up.)&quot;));</b>
<b class="nc">&nbsp;        CheckBox cbTimezone = new CheckBox(Localization.lang(&quot;Timezone (Provides for better recommendations by indicating the time of day the request is being made.)&quot;));</b>
<b class="nc">&nbsp;        vb.getChildren().addAll(cbTitle, cbVersion, cbLanguage, cbOS, cbTimezone);</b>
<b class="nc">&nbsp;        vb.setSpacing(10);</b>
&nbsp;
<b class="nc">&nbsp;        button.setOnAction(event -&gt; {</b>
<b class="nc">&nbsp;            MrDlibPreferences mrDlibPreferences = preferences.getMrDlibPreferences();</b>
<b class="nc">&nbsp;            mrDlibPreferences.setAcceptRecommendations(true);</b>
<b class="nc">&nbsp;            mrDlibPreferences.setSendLanguage(cbLanguage.isSelected());</b>
<b class="nc">&nbsp;            mrDlibPreferences.setSendOs(cbOS.isSelected());</b>
<b class="nc">&nbsp;            mrDlibPreferences.setSendTimezone(cbTimezone.isSelected());</b>
&nbsp;
<b class="nc">&nbsp;            dialogService.showWarningDialogAndWait(Localization.lang(&quot;Restart&quot;), Localization.lang(&quot;Please restart JabRef for preferences to take effect.&quot;));</b>
<b class="nc">&nbsp;            setContent(getRelatedArticlesPane(entry));</b>
&nbsp;        });
&nbsp;
<b class="nc">&nbsp;        hideTab.setOnAction(event -&gt; {</b>
<b class="nc">&nbsp;            preferences.getEntryEditorPreferences().setShouldShowRecommendationsTab(false);</b>
<b class="nc">&nbsp;            dialogService.showWarningDialogAndWait(Localization.lang(&quot;Restart&quot;), Localization.lang(&quot;Please restart JabRef for preferences to take effect.&quot;));</b>
&nbsp;        });
&nbsp;
<b class="nc">&nbsp;        hbox.getChildren().addAll(button, hideTab);</b>
<b class="nc">&nbsp;        vbox.getChildren().addAll(title, line1, line2, mdlLink, line3, vb, hbox);</b>
<b class="nc">&nbsp;        root.setContent(vbox);</b>
&nbsp;
<b class="nc">&nbsp;        return root;</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public boolean shouldShow(BibEntry entry) {
<b class="nc">&nbsp;        EntryEditorPreferences entryEditorPreferences = preferences.getEntryEditorPreferences();</b>
<b class="nc">&nbsp;        return entryEditorPreferences.shouldShowRecommendationsTab();</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    protected void bindToEntry(BibEntry entry) {
<b class="nc">&nbsp;        if (preferences.getMrDlibPreferences().shouldAcceptRecommendations()) {</b>
<b class="nc">&nbsp;            setContent(getRelatedArticlesPane(entry));</b>
&nbsp;        } else {
&nbsp;            // Ask for consent to send data to Mr. DLib on first time to tab
<b class="nc">&nbsp;            setContent(getPrivacyDialog(entry));</b>
&nbsp;        }
&nbsp;    }
&nbsp;}
</code>
</pre>
</div>

<script type="text/javascript">
(function() {
    var msie = false, msie9 = false;
    /*@cc_on
      msie = true;
      @if (@_jscript_version >= 9)
        msie9 = true;
      @end
    @*/

    if (!msie || msie && msie9) {
      hljs.highlightAll()
      hljs.initLineNumbersOnLoad();
    }
})();
</script>

<div class="footer">
    
    <div style="float:right;">generated on 2025-09-29 22:51</div>
</div>
</body>
</html>
