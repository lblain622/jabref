


<!DOCTYPE html>
<html id="htmlId">
<head>
  <meta http-equiv="Content-Type" content="text/html;charset=UTF-8"> 
  <title>Coverage Report > CSLFormatUtils</title>
  <style type="text/css">
    @import "../../css/coverage.css";
    @import "../../css/idea.min.css";
  </style>
  <script type="text/javascript" src="../../js/highlight.min.js"></script>
  <script type="text/javascript" src="../../js/highlightjs-line-numbers.min.js"></script>
</head>

<body>
<div class="content">
<div class="breadCrumbs">
Current scope:     <a href="../../index.html">all classes</a>
    <span class="separator">|</span>
    <a href="../index.html">org.jabref.logic.openoffice.oocsltext</a>
</div>

<h1>Coverage Summary for Class: CSLFormatUtils (org.jabref.logic.openoffice.oocsltext)</h1>

<table class="coverageStats">
<tr>
  <th class="name">Class</th>
<th class="coverageStat 
">
  Class, %
</th>
<th class="coverageStat 
">
  Method, %
</th>
<th class="coverageStat 
">
  Branch, %
</th>
<th class="coverageStat 
">
  Line, %
</th>
</tr>
<tr>
  <td class="name">CSLFormatUtils</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/8)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/26)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/69)
  </span>
</td>
</tr>

</table>

<br/>
<br/>


<pre>
<code class="sourceCode" id="sourceCode">&nbsp;package org.jabref.logic.openoffice.oocsltext;
&nbsp;
&nbsp;import java.util.List;
&nbsp;import java.util.Optional;
&nbsp;import java.util.regex.Matcher;
&nbsp;import java.util.regex.Pattern;
&nbsp;
&nbsp;import org.jabref.logic.citationkeypattern.BracketedPattern;
&nbsp;import org.jabref.logic.citationstyle.CitationStyle;
&nbsp;import org.jabref.logic.citationstyle.CitationStyleOutputFormat;
&nbsp;import org.jabref.model.database.BibDatabaseContext;
&nbsp;import org.jabref.model.entry.AuthorList;
&nbsp;import org.jabref.model.entry.BibEntry;
&nbsp;import org.jabref.model.entry.BibEntryTypesManager;
&nbsp;import org.jabref.model.entry.field.StandardField;
&nbsp;import org.jabref.model.openoffice.ootext.OOText;
&nbsp;import org.jabref.model.openoffice.ootext.OOTextIntoOO;
&nbsp;
&nbsp;import com.sun.star.text.XTextCursor;
&nbsp;import com.sun.star.text.XTextDocument;
&nbsp;import org.apache.commons.text.StringEscapeUtils;
&nbsp;
&nbsp;/**
&nbsp; * Contains utility constants and methods for processing of CSL citations as generated by methods of &lt;a href=&quot;https://github.com/michel-kraemer/citeproc-java&quot;&gt;citeproc-java&lt;/a&gt; ({@link org.jabref.logic.citationstyle.CitationStyleGenerator}).
&nbsp; * &lt;p&gt;These methods are used in {@link CSLCitationOOAdapter} which inserts CSL citation text into an OO document.&lt;/p&gt;
&nbsp; */
&nbsp;public final class CSLFormatUtils {
&nbsp;
&nbsp;    /**
&nbsp;     * The formatting names specified to and understood by LibreOffice internally via code are often different from their displayed names in the LibreOffice application.
&nbsp;     * For example, &quot;Hanging Indent&quot; as visible in LO styles list should be specified as &quot;Hanging indent&quot; (note casing) internally. Similarly, &quot;Body Text, Indented&quot; is specified as &quot;Text body indent&quot;.
&nbsp;     * This is also why we don&#39;t let users manually input the name of any pre-set format.
&nbsp;     * The following two lists below are taken from https://github.com/LibreOffice/core/blob/0891df6b21fd95ec7c9614509d92829c0f17c353/sw/qa/python/check_styles.py#L132
&nbsp;     */
<b class="nc">&nbsp;    public static final List&lt;String&gt; BIBLIOGRAPHY_TITLE_FORMATS = List.of(</b>
&nbsp;            &quot;Bibliography Heading&quot;,
&nbsp;            &quot;Title&quot;,
&nbsp;            &quot;Text body&quot;,
&nbsp;            &quot;Subtitle&quot;,
&nbsp;            &quot;Heading 1&quot;,
&nbsp;            &quot;Heading 2&quot;,
&nbsp;            &quot;Heading 3&quot;,
&nbsp;            &quot;Heading 4&quot;
&nbsp;    );
&nbsp;
<b class="nc">&nbsp;    public static final List&lt;String&gt; BIBLIOGRAPHY_BODY_FORMATS = List.of(</b>
&nbsp;            &quot;Bibliography 1&quot;,
&nbsp;            &quot;Text body&quot;,
&nbsp;            &quot;Text body indent&quot;,
&nbsp;            &quot;First line indent&quot;,
&nbsp;            &quot;Hanging indent&quot;,
&nbsp;            &quot;List&quot;,
&nbsp;            &quot;List Indent&quot;,
&nbsp;            &quot;Marginalia&quot;
&nbsp;    );
&nbsp;
&nbsp;    private static final String DEFAULT_BIBLIOGRAPHY_BODY_FORMAT = &quot;Text body&quot;;
&nbsp;    private static final String DEFAULT_HANGING_INDENT_BIBLIOGRAPHY_BODY_FORMAT = &quot;Hanging indent&quot;;
&nbsp;
<b class="nc">&nbsp;    private static final Pattern YEAR_IN_CITATION_PATTERN = Pattern.compile(&quot;(.)(.*), (\\d{4}.*)&quot;);</b>
&nbsp;
&nbsp;    private CSLFormatUtils() {
&nbsp;        // prevent instantiation
&nbsp;    }
&nbsp;
&nbsp;    public static String getDefaultBodyFormatForStyle(CitationStyle style) {
<b class="nc">&nbsp;        if (style.usesHangingIndent()) {</b>
<b class="nc">&nbsp;            return DEFAULT_HANGING_INDENT_BIBLIOGRAPHY_BODY_FORMAT;</b>
&nbsp;        }
<b class="nc">&nbsp;        return DEFAULT_BIBLIOGRAPHY_BODY_FORMAT;</b>
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * Transforms provided HTML into a format that can be fully parsed and inserted into an OO document.
&nbsp;     * Context: The HTML produced by {@link org.jabref.logic.citationstyle.CitationStyleGenerator#generateBibliography(List, String, CitationStyleOutputFormat, BibDatabaseContext, BibEntryTypesManager) generateBibliography} or {@link org.jabref.logic.citationstyle.CitationStyleGenerator#generateCitation(List, String, CitationStyleOutputFormat, BibDatabaseContext, BibEntryTypesManager) generateCitation} is not directly (completely) parsable by {@link OOTextIntoOO#write(XTextDocument, XTextCursor, OOText) write}.
&nbsp;     * For more details, read the documentation for the {@link OOTextIntoOO} class.
&nbsp;     * &lt;a href=&quot;https://devdocs.jabref.org/code-howtos/openoffice/code-reorganization.html&quot;&gt;Additional Information&lt;/a&gt;.
&nbsp;     *
&nbsp;     * @param html The HTML string to be transformed into OO-write ready HTML.
&nbsp;     * @return The formatted html string.
&nbsp;     */
&nbsp;    public static String transformHTML(String html) {
&nbsp;        // Initial clean up of escaped characters
<b class="nc">&nbsp;        html = StringEscapeUtils.unescapeHtml4(html);</b>
&nbsp;
&nbsp;        // Handle margins (spaces between citation number and text)
<b class="nc">&nbsp;        html = html.replaceAll(&quot;&lt;div class=\&quot;csl-left-margin\&quot;&gt;(.*?)&lt;/div&gt;&lt;div class=\&quot;csl-right-inline\&quot;&gt;(.*?)&lt;/div&gt;&quot;, &quot;$1 $2&quot;);</b>
&nbsp;
&nbsp;        // Remove unsupported tags
<b class="nc">&nbsp;        html = html.replaceAll(&quot;&lt;div[^&gt;]*&gt;&quot;, &quot;&quot;);</b>
<b class="nc">&nbsp;        html = html.replace(&quot;&lt;/div&gt;&quot;, &quot;&quot;);</b>
&nbsp;
&nbsp;        // Remove unsupported links
<b class="nc">&nbsp;        html = html.replaceAll(&quot;&lt;a[^&gt;]*&gt;&quot;, &quot;&quot;);</b>
<b class="nc">&nbsp;        html = html.replace(&quot;&lt;/a&gt;&quot;, &quot;&quot;);</b>
&nbsp;
&nbsp;        // Replace span tags with inline styles for bold
<b class="nc">&nbsp;        html = html.replaceAll(&quot;&lt;span style=\&quot;font-weight: ?bold;?\&quot;&gt;(.*?)&lt;/span&gt;&quot;, &quot;&lt;b&gt;$1&lt;/b&gt;&quot;);</b>
&nbsp;
&nbsp;        // Replace span tags with inline styles for italic
<b class="nc">&nbsp;        html = html.replaceAll(&quot;&lt;span style=\&quot;font-style: ?italic;?\&quot;&gt;(.*?)&lt;/span&gt;&quot;, &quot;&lt;i&gt;$1&lt;/i&gt;&quot;);</b>
&nbsp;
&nbsp;        // Replace span tags with inline styles for underline
<b class="nc">&nbsp;        html = html.replaceAll(&quot;&lt;span style=\&quot;text-decoration: ?underline;?\&quot;&gt;(.*?)&lt;/span&gt;&quot;, &quot;&lt;u&gt;$1&lt;/u&gt;&quot;);</b>
&nbsp;
<b class="nc">&nbsp;        html = html.replaceAll(&quot;&lt;span style=\&quot;font-variant: ?small-caps;?\&quot;&gt;(.*?)&lt;/span&gt;&quot;, &quot;&lt;smallcaps&gt;$1&lt;/smallcaps&gt;&quot;);</b>
&nbsp;
&nbsp;        // Clean up any remaining span tags
<b class="nc">&nbsp;        html = html.replaceAll(&quot;&lt;/?span[^&gt;]*&gt;&quot;, &quot;&quot;);</b>
&nbsp;
&nbsp;        // Convert line breaks to paragraph breaks
<b class="nc">&nbsp;        html = html.replaceAll(&quot;[\n\r]+&quot;, &quot;&lt;p&gt;&lt;/p&gt;&quot;);</b>
&nbsp;
&nbsp;        // Remove leading paragraph tags (preserving any whitespaces after them for indentation)
<b class="nc">&nbsp;        html = html.replaceAll(&quot;^\\s*&lt;p&gt;\\s*&lt;/p&gt;&quot;, &quot;&quot;);</b>
&nbsp;
&nbsp;        // Remove extra trailing paragraph tags when there are multiple (keeping one)
<b class="nc">&nbsp;        html = html.replaceAll(&quot;(?:&lt;p&gt;\\s*&lt;/p&gt;\\s*){2,}$&quot;, &quot;&lt;p&gt;&lt;/p&gt;&quot;);</b>
&nbsp;
&nbsp;        // In bibliography entries, citeproc-java adds 4 leading spaces for numeric styles, and 2 for non-numeric
<b class="nc">&nbsp;        html = html.trim();</b>
&nbsp;
<b class="nc">&nbsp;        return html;</b>
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * Alphanumeric citations are not natively supported by citeproc-java (see {@link org.jabref.logic.citationstyle.CitationStyleGenerator#generateCitation(List, String, CitationStyleOutputFormat, BibDatabaseContext, BibEntryTypesManager) generateCitation}).
&nbsp;     * Thus, we manually format a citation to produce its alphanumeric form.
&nbsp;     *
&nbsp;     * @param entries the list of entries for which the alphanumeric citation is to be generated.
&nbsp;     * @return the alphanumeric citation (for a single entry or a group of entries).
&nbsp;     */
&nbsp;    public static String generateAlphanumericCitation(List&lt;BibEntry&gt; entries, BibDatabaseContext bibDatabaseContext) {
<b class="nc">&nbsp;        StringBuilder citation = new StringBuilder(&quot;[&quot;);</b>
<b class="nc">&nbsp;        for (int i = 0; i &lt; entries.size(); i++) {</b>
<b class="nc">&nbsp;            BibEntry entry = entries.get(i);</b>
<b class="nc">&nbsp;            Optional&lt;String&gt; author = entry.getResolvedFieldOrAlias(StandardField.AUTHOR, bibDatabaseContext.getDatabase());</b>
<b class="nc">&nbsp;            Optional&lt;String&gt; year = entry.getResolvedFieldOrAlias(StandardField.YEAR, bibDatabaseContext.getDatabase());</b>
&nbsp;
<b class="nc">&nbsp;            if (author.isPresent() &amp;&amp; year.isPresent()) {</b>
<b class="nc">&nbsp;                AuthorList authorList = AuthorList.parse(author.get());</b>
<b class="nc">&nbsp;                String alphaKey = BracketedPattern.authorsAlphaLNI(authorList);</b>
&nbsp;
&nbsp;                // Extract last two digits of the year
<b class="nc">&nbsp;                String shortYear = year.get().length() &gt;= 2 ?</b>
<b class="nc">&nbsp;                                   year.get().substring(year.get().length() - 2) :</b>
<b class="nc">&nbsp;                                   year.get();</b>
&nbsp;
<b class="nc">&nbsp;                citation.append(alphaKey).append(shortYear);</b>
&nbsp;            } else {
<b class="nc">&nbsp;                citation.append(entry.getCitationKey().orElse(&quot;&quot;));</b>
&nbsp;            }
&nbsp;
<b class="nc">&nbsp;            if (i &lt; entries.size() - 1) {</b>
<b class="nc">&nbsp;                citation.append(&quot;; &quot;);</b>
&nbsp;            }
&nbsp;        }
<b class="nc">&nbsp;        citation.append(&quot;]&quot;);</b>
<b class="nc">&nbsp;        return citation.toString();</b>
&nbsp;    }
&nbsp;
&nbsp;    public static String generateAlphanumericInTextCitation(BibEntry entry, BibDatabaseContext bibDatabaseContext) {
<b class="nc">&nbsp;        String inTextCitation = generateAlphanumericCitation(List.of(entry), bibDatabaseContext);</b>
&nbsp;
<b class="nc">&nbsp;        String authorName = entry.getResolvedFieldOrAlias(StandardField.AUTHOR, bibDatabaseContext.getDatabase())</b>
<b class="nc">&nbsp;                                 .map(AuthorList::parse)</b>
<b class="nc">&nbsp;                                 .map(list -&gt; BracketedPattern.joinAuthorsOnLastName(list, 1, &quot;&quot;, &quot; et al.&quot;))</b>
<b class="nc">&nbsp;                                 .orElse(&quot;&quot;);</b>
&nbsp;
<b class="nc">&nbsp;        return authorName + &quot; &quot; + inTextCitation;</b>
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * Method to update citation number of a bibliographic entry (to be inserted in the list of references).
&nbsp;     * By default, citeproc-java ({@link org.jabref.logic.citationstyle.CitationStyleGenerator#generateBibliography(List, String, CitationStyleOutputFormat, BibDatabaseContext, BibEntryTypesManager) generateBibliography}) always starts the numbering of a list of references with &quot;1&quot;.
&nbsp;     * If a citation doesn&#39;t correspond to the first cited entry, the number should be changed to the appropriate current citation number.
&nbsp;     * The numbers should be globally unique. If an entry has been cited before, the older citation number corresponding to it should be reused.
&nbsp;     * The number can be enclosed in different formats, such as &quot;1&quot;, &quot;1.&quot;, &quot;1)&quot;, &quot;(1)&quot; or &quot;[1]&quot;.
&nbsp;     * &lt;p&gt;
&nbsp;     * &lt;b&gt;Precondition:&lt;/b&gt; Use ONLY with numeric citation styles.&lt;/p&gt;
&nbsp;     *
&nbsp;     * @param citation      the numeric citation with an unresolved number.
&nbsp;     * @param currentNumber the correct number to update the citation with.
&nbsp;     * @return the bibliographic citation with resolved number.
&nbsp;     */
&nbsp;    public static String updateSingleBibliographyNumber(String citation, int currentNumber) {
<b class="nc">&nbsp;        Pattern pattern = Pattern.compile(&quot;([\\[(])?(\\d+)([])])?(\\.)?\\s*&quot;);</b>
<b class="nc">&nbsp;        Matcher matcher = pattern.matcher(citation);</b>
<b class="nc">&nbsp;        StringBuilder sb = new StringBuilder();</b>
<b class="nc">&nbsp;        boolean numberReplaced = false;</b>
&nbsp;
<b class="nc">&nbsp;        while (matcher.find()) {</b>
<b class="nc">&nbsp;            if (!numberReplaced) {</b>
<b class="nc">&nbsp;                String prefix = matcher.group(1) != null ? matcher.group(1) : &quot;&quot;;</b>
<b class="nc">&nbsp;                String suffix = matcher.group(3) != null ? matcher.group(3) : &quot;&quot;;</b>
<b class="nc">&nbsp;                String dot = matcher.group(4) != null ? &quot;.&quot; : &quot;&quot;;</b>
<b class="nc">&nbsp;                String space = matcher.group().endsWith(&quot; &quot;) ? &quot; &quot; : &quot;&quot;;</b>
&nbsp;
<b class="nc">&nbsp;                String replacement = prefix + currentNumber + suffix + dot + space;</b>
&nbsp;
<b class="nc">&nbsp;                matcher.appendReplacement(sb, Matcher.quoteReplacement(replacement));</b>
<b class="nc">&nbsp;                numberReplaced = true;</b>
&nbsp;            } else {
<b class="nc">&nbsp;                matcher.appendReplacement(sb, matcher.group());</b>
&nbsp;            }
&nbsp;        }
<b class="nc">&nbsp;        matcher.appendTail(sb);</b>
<b class="nc">&nbsp;        return sb.toString();</b>
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * Extracts year from a citation having single or multiple entries, for the purpose of using in in-text citations.
&nbsp;     *
&nbsp;     * @param formattedCitation the citation cleaned up and formatted using {@link CSLFormatUtils#transformHTML transformHTML}.
&nbsp;     */
&nbsp;    public static String changeToInText(String formattedCitation) {
<b class="nc">&nbsp;        Matcher matcher = YEAR_IN_CITATION_PATTERN.matcher(formattedCitation);</b>
<b class="nc">&nbsp;        if (matcher.find()) {</b>
<b class="nc">&nbsp;            return matcher.group(2) + &quot; &quot; + matcher.group(1) + matcher.group(3);</b>
&nbsp;        }
<b class="nc">&nbsp;        return formattedCitation;</b>
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * Generates Author Prefix for an in-text citation
&nbsp;     */
&nbsp;    public static String generateAuthorPrefix(BibEntry currentEntry, BibDatabaseContext bibDatabaseContext) {
<b class="nc">&nbsp;        return currentEntry.getResolvedFieldOrAlias(StandardField.AUTHOR, bibDatabaseContext.getDatabase())</b>
<b class="nc">&nbsp;                           .map(AuthorList::parse)</b>
<b class="nc">&nbsp;                           .map(list -&gt; BracketedPattern.joinAuthorsOnLastName(list, 1, &quot;&quot;, &quot; et al.&quot;) + &quot; &quot;)</b>
<b class="nc">&nbsp;                           .orElse(&quot;&quot;);</b>
&nbsp;    }
&nbsp;}
</code>
</pre>
</div>

<script type="text/javascript">
(function() {
    var msie = false, msie9 = false;
    /*@cc_on
      msie = true;
      @if (@_jscript_version >= 9)
        msie9 = true;
      @end
    @*/

    if (!msie || msie && msie9) {
      hljs.highlightAll()
      hljs.initLineNumbersOnLoad();
    }
})();
</script>

<div class="footer">
    
    <div style="float:right;">generated on 2025-09-29 22:51</div>
</div>
</body>
</html>
