


<!DOCTYPE html>
<html id="htmlId">
<head>
  <meta http-equiv="Content-Type" content="text/html;charset=UTF-8"> 
  <title>Coverage Report > PdfUpdate</title>
  <style type="text/css">
    @import "../../css/coverage.css";
    @import "../../css/idea.min.css";
  </style>
  <script type="text/javascript" src="../../js/highlight.min.js"></script>
  <script type="text/javascript" src="../../js/highlightjs-line-numbers.min.js"></script>
</head>

<body>
<div class="content">
<div class="breadCrumbs">
Current scope:     <a href="../../index.html">all classes</a>
    <span class="separator">|</span>
    <a href="../index.html">org.jabref.cli</a>
</div>

<h1>Coverage Summary for Class: PdfUpdate (org.jabref.cli)</h1>

<table class="coverageStats">
<tr>
  <th class="name">Class</th>
<th class="coverageStat 
">
  Class, %
</th>
<th class="coverageStat 
">
  Method, %
</th>
<th class="coverageStat 
">
  Branch, %
</th>
<th class="coverageStat 
">
  Line, %
</th>
</tr>
<tr>
  <td class="name">PdfUpdate</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/7)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/42)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/70)
  </span>
</td>
</tr>

</table>

<br/>
<br/>


<pre>
<code class="sourceCode" id="sourceCode">&nbsp;package org.jabref.cli;
&nbsp;
&nbsp;import java.io.IOException;
&nbsp;import java.nio.file.Files;
&nbsp;import java.nio.file.Path;
&nbsp;import java.util.List;
&nbsp;import java.util.Optional;
&nbsp;
&nbsp;import javax.xml.parsers.ParserConfigurationException;
&nbsp;import javax.xml.transform.TransformerException;
&nbsp;
&nbsp;import org.jabref.cli.converter.CygWinPathConverter;
&nbsp;import org.jabref.logic.FilePreferences;
&nbsp;import org.jabref.logic.bibtex.FieldPreferences;
&nbsp;import org.jabref.logic.exporter.EmbeddedBibFilePdfExporter;
&nbsp;import org.jabref.logic.exporter.SaveException;
&nbsp;import org.jabref.logic.exporter.XmpPdfExporter;
&nbsp;import org.jabref.logic.importer.ParserResult;
&nbsp;import org.jabref.logic.journals.JournalAbbreviationRepository;
&nbsp;import org.jabref.logic.l10n.Localization;
&nbsp;import org.jabref.logic.util.io.FileUtil;
&nbsp;import org.jabref.logic.xmp.XmpPreferences;
&nbsp;import org.jabref.model.database.BibDatabaseContext;
&nbsp;import org.jabref.model.database.BibDatabaseMode;
&nbsp;import org.jabref.model.entry.BibEntry;
&nbsp;import org.jabref.model.entry.BibEntryTypesManager;
&nbsp;
&nbsp;import com.airhacks.afterburner.injection.Injector;
&nbsp;import org.slf4j.Logger;
&nbsp;import org.slf4j.LoggerFactory;
&nbsp;
&nbsp;import static picocli.CommandLine.Command;
&nbsp;import static picocli.CommandLine.Mixin;
&nbsp;import static picocli.CommandLine.Option;
&nbsp;import static picocli.CommandLine.ParentCommand;
&nbsp;
&nbsp;@Command(name = &quot;update&quot;, description = &quot;Update linked PDFs with XMP and/or embedded BibTeX.&quot;)
<b class="nc">&nbsp;class PdfUpdate implements Runnable {</b>
<b class="nc">&nbsp;    private static final Logger LOGGER = LoggerFactory.getLogger(PdfUpdate.class);</b>
&nbsp;
&nbsp;    @ParentCommand
&nbsp;    protected Pdf pdf;
&nbsp;
<b class="nc">&nbsp;    @Mixin</b>
&nbsp;    private ArgumentProcessor.SharedOptions sharedOptions = new ArgumentProcessor.SharedOptions();
&nbsp;
<b class="nc">&nbsp;    @Option(names = &quot;--format&quot;, description = &quot;Format to update (xmp, bibtex-attachment)&quot;, split = &quot;,&quot;)</b>
<b class="nc">&nbsp;    private List&lt;String&gt; formats = List.of(&quot;xmp&quot;, &quot;bibtex-attachment&quot;); // ToDO: default value?</b>
&nbsp;
<b class="nc">&nbsp;    @Option(names = {&quot;-k&quot;, &quot;--citation-key&quot;}, description = &quot;Citation keys&quot;, required = true)</b>
<b class="nc">&nbsp;    private List&lt;String&gt; citationKeys = List.of(); // ToDo: check dedault value</b>
&nbsp;
&nbsp;    // [impl-&gt;req~jabkit.cli.input-flag~1]
&nbsp;    @Option(names = {&quot;--input&quot;}, converter = CygWinPathConverter.class, description = &quot;Input BibTeX file&quot;, required = true)
&nbsp;    private Path inputFile;
&nbsp;
<b class="nc">&nbsp;    @Option(names = &quot;--input-format&quot;, description = &quot;Input format of the file&quot;, required = true)</b>
&nbsp;    private String inputFormat = &quot;*&quot;;
&nbsp;
&nbsp;    @Option(names = &quot;--update-linked-files&quot;, description = &quot;Update linked files automatically.&quot;)
&nbsp;    private boolean updateLinkedFiles;
&nbsp;
&nbsp;    @Override
&nbsp;    public void run() {
<b class="nc">&nbsp;        if (!formats.contains(&quot;xmp&quot;) &amp;&amp; !formats.contains(&quot;bibtex-attachment&quot;)) {</b>
<b class="nc">&nbsp;            System.out.println(&quot;The format option must contain either &#39;xmp&#39; or &#39;bibtex-attachment&#39;.&quot;);</b>
&nbsp;            return;
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        Optional&lt;ParserResult&gt; parserResult = ArgumentProcessor.importFile(</b>
&nbsp;                inputFile,
&nbsp;                inputFormat,
&nbsp;                pdf.argumentProcessor.cliPreferences,
&nbsp;                sharedOptions.porcelain);
<b class="nc">&nbsp;        if (parserResult.isEmpty()) {</b>
<b class="nc">&nbsp;            System.out.println(Localization.lang(&quot;Unable to open file &#39;%0&#39;.&quot;, inputFile));</b>
&nbsp;            return;
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        if (parserResult.get().isInvalid()) {</b>
<b class="nc">&nbsp;            System.out.println(Localization.lang(&quot;Input file &#39;%0&#39; is invalid and could not be parsed.&quot;, inputFile));</b>
&nbsp;            return;
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        if (!sharedOptions.porcelain) {</b>
<b class="nc">&nbsp;            System.out.println(Localization.lang(&quot;Updating PDF metadata.&quot;));</b>
<b class="nc">&nbsp;            System.out.flush();</b>
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        writeMetadataToPdf(List.of(parserResult.get()),</b>
<b class="nc">&nbsp;                List.of(inputFile),</b>
&nbsp;                citationKeys,
<b class="nc">&nbsp;                pdf.argumentProcessor.cliPreferences.getXmpPreferences(),</b>
<b class="nc">&nbsp;                pdf.argumentProcessor.cliPreferences.getFilePreferences(),</b>
<b class="nc">&nbsp;                pdf.argumentProcessor.cliPreferences.getLibraryPreferences().getDefaultBibDatabaseMode(),</b>
<b class="nc">&nbsp;                pdf.argumentProcessor.cliPreferences.getCustomEntryTypesRepository(),</b>
<b class="nc">&nbsp;                pdf.argumentProcessor.cliPreferences.getFieldPreferences(),</b>
<b class="nc">&nbsp;                Injector.instantiateModelOrService(JournalAbbreviationRepository.class),</b>
<b class="nc">&nbsp;                formats.contains(&quot;xmp&quot;),</b>
<b class="nc">&nbsp;                formats.contains(&quot;bibtex-attachment&quot;));</b>
&nbsp;    }
&nbsp;
&nbsp;    private static void writeMetadataToPdf(List&lt;ParserResult&gt; loaded,
&nbsp;                                           List&lt;Path&gt; files,
&nbsp;                                           List&lt;String&gt; citationKeys,
&nbsp;                                           XmpPreferences xmpPreferences,
&nbsp;                                           FilePreferences filePreferences,
&nbsp;                                           BibDatabaseMode databaseMode,
&nbsp;                                           BibEntryTypesManager entryTypesManager,
&nbsp;                                           FieldPreferences fieldPreferences,
&nbsp;                                           JournalAbbreviationRepository abbreviationRepository,
&nbsp;                                           boolean writeXMP,
&nbsp;                                           boolean embeddBibfile) {
<b class="nc">&nbsp;        ParserResult pr = loaded.getLast();</b>
<b class="nc">&nbsp;        BibDatabaseContext databaseContext = pr.getDatabaseContext();</b>
&nbsp;
<b class="nc">&nbsp;        XmpPdfExporter xmpPdfExporter = new XmpPdfExporter(xmpPreferences);</b>
<b class="nc">&nbsp;        EmbeddedBibFilePdfExporter embeddedBibFilePdfExporter = new EmbeddedBibFilePdfExporter(databaseMode, entryTypesManager, fieldPreferences);</b>
&nbsp;
<b class="nc">&nbsp;        if (citationKeys.contains(&quot;all&quot;)) {</b>
<b class="nc">&nbsp;            for (BibEntry entry : databaseContext.getEntries()) {</b>
<b class="nc">&nbsp;                writeMetadataToPDFsOfEntry(</b>
&nbsp;                        databaseContext,
<b class="nc">&nbsp;                        entry.getCitationKey().orElse(&quot;&lt;no cite key defined&gt;&quot;),</b>
&nbsp;                        entry,
&nbsp;                        filePreferences,
&nbsp;                        xmpPdfExporter,
&nbsp;                        embeddedBibFilePdfExporter,
&nbsp;                        abbreviationRepository,
&nbsp;                        writeXMP,
&nbsp;                        embeddBibfile);
&nbsp;            }
&nbsp;            return;
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        writeMetadataToPdfByCitekey(</b>
&nbsp;                databaseContext,
&nbsp;                citationKeys,
&nbsp;                filePreferences,
&nbsp;                xmpPdfExporter,
&nbsp;                embeddedBibFilePdfExporter,
&nbsp;                abbreviationRepository,
&nbsp;                writeXMP,
&nbsp;                embeddBibfile);
<b class="nc">&nbsp;        writeMetadataToPdfByFileNames(</b>
&nbsp;                databaseContext,
&nbsp;                files,
&nbsp;                filePreferences,
&nbsp;                xmpPdfExporter,
&nbsp;                embeddedBibFilePdfExporter,
&nbsp;                abbreviationRepository,
&nbsp;                writeXMP,
&nbsp;                embeddBibfile);
&nbsp;    }
&nbsp;
&nbsp;    private static void writeMetadataToPDFsOfEntry(BibDatabaseContext databaseContext,
&nbsp;                                                   String citeKey,
&nbsp;                                                   BibEntry entry,
&nbsp;                                                   FilePreferences filePreferences,
&nbsp;                                                   XmpPdfExporter xmpPdfExporter,
&nbsp;                                                   EmbeddedBibFilePdfExporter embeddedBibFilePdfExporter,
&nbsp;                                                   JournalAbbreviationRepository abbreviationRepository,
&nbsp;                                                   boolean writeXMP,
&nbsp;                                                   boolean embedBibfile) {
&nbsp;        try {
<b class="nc">&nbsp;            if (writeXMP) {</b>
<b class="nc">&nbsp;                if (xmpPdfExporter.exportToAllFilesOfEntry(</b>
&nbsp;                        databaseContext,
&nbsp;                        filePreferences,
&nbsp;                        entry,
<b class="nc">&nbsp;                        List.of(entry),</b>
&nbsp;                        abbreviationRepository)) {
<b class="nc">&nbsp;                    System.out.println(Localization.lang(&quot;Successfully written XMP metadata on at least one linked file of %0.&quot;, citeKey));</b>
&nbsp;                } else {
<b class="nc">&nbsp;                    System.out.println(Localization.lang(&quot;Cannot write XMP metadata on any linked files of %0. Make sure there is at least one linked file and the path is correct.&quot;, citeKey));</b>
&nbsp;                }
&nbsp;            }
<b class="nc">&nbsp;            if (embedBibfile) {</b>
<b class="nc">&nbsp;                if (embeddedBibFilePdfExporter.exportToAllFilesOfEntry(</b>
&nbsp;                        databaseContext,
&nbsp;                        filePreferences,
&nbsp;                        entry,
<b class="nc">&nbsp;                        List.of(entry),</b>
&nbsp;                        abbreviationRepository)) {
<b class="nc">&nbsp;                    System.out.println(Localization.lang(&quot;Successfully embedded metadata on at least one linked file of %0.&quot;, citeKey));</b>
&nbsp;                } else {
<b class="nc">&nbsp;                    System.out.println(Localization.lang(&quot;Cannot embed metadata on any linked files of %s. Make sure there is at least one linked file and the path is correct.&quot;, citeKey));</b>
&nbsp;                }
&nbsp;            }
&nbsp;        } catch (IOException
&nbsp;                 | ParserConfigurationException
&nbsp;                 | SaveException
&nbsp;                 | TransformerException e) {
<b class="nc">&nbsp;            LOGGER.error(&quot;Failed writing metadata on a linked file of {}.&quot;, citeKey);</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    private static void writeMetadataToPdfByCitekey(BibDatabaseContext databaseContext,
&nbsp;                                                    List&lt;String&gt; citeKeys,
&nbsp;                                                    FilePreferences filePreferences,
&nbsp;                                                    XmpPdfExporter xmpPdfExporter,
&nbsp;                                                    EmbeddedBibFilePdfExporter embeddedBibFilePdfExporter,
&nbsp;                                                    JournalAbbreviationRepository abbreviationRepository,
&nbsp;                                                    boolean writeXMP,
&nbsp;                                                    boolean embeddBibfile) {
<b class="nc">&nbsp;        for (String citeKey : citeKeys) {</b>
<b class="nc">&nbsp;            List&lt;BibEntry&gt; bibEntryList = databaseContext.getDatabase().getEntriesByCitationKey(citeKey);</b>
<b class="nc">&nbsp;            if (bibEntryList.isEmpty()) {</b>
<b class="nc">&nbsp;                LOGGER.error(&quot;Skipped - Cannot find {} in library.&quot;, citeKey);</b>
&nbsp;                continue;
&nbsp;            }
<b class="nc">&nbsp;            for (BibEntry entry : bibEntryList) {</b>
<b class="nc">&nbsp;                writeMetadataToPDFsOfEntry(</b>
&nbsp;                        databaseContext,
&nbsp;                        citeKey,
&nbsp;                        entry,
&nbsp;                        filePreferences,
&nbsp;                        xmpPdfExporter,
&nbsp;                        embeddedBibFilePdfExporter,
&nbsp;                        abbreviationRepository,
&nbsp;                        writeXMP,
&nbsp;                        embeddBibfile);
&nbsp;            }
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    private static void writeMetadataToPdfByFileNames(BibDatabaseContext databaseContext,
&nbsp;                                                      List&lt;Path&gt; pdfs,
&nbsp;                                                      FilePreferences filePreferences,
&nbsp;                                                      XmpPdfExporter xmpPdfExporter,
&nbsp;                                                      EmbeddedBibFilePdfExporter embeddedBibFilePdfExporter,
&nbsp;                                                      JournalAbbreviationRepository abbreviationRepository,
&nbsp;                                                      boolean writeXMP,
&nbsp;                                                      boolean embeddBibfile) {
<b class="nc">&nbsp;        for (Path filePath : pdfs) {</b>
<b class="nc">&nbsp;            if (!filePath.isAbsolute()) {</b>
<b class="nc">&nbsp;                filePath = FileUtil.find(filePath.toString(), databaseContext.getFileDirectories(filePreferences)).orElse(</b>
<b class="nc">&nbsp;                        FileUtil.find(filePath.toString(), List.of(Path.of(&quot;&quot;).toAbsolutePath())).orElse(filePath));</b>
&nbsp;            }
&nbsp;
<b class="nc">&nbsp;            if (!Files.exists(filePath)) {</b>
<b class="nc">&nbsp;                LOGGER.error(&quot;Skipped - PDF {} does not exist&quot;, filePath);</b>
&nbsp;                return;
&nbsp;            }
&nbsp;
&nbsp;            try {
<b class="nc">&nbsp;                if (writeXMP) {</b>
<b class="nc">&nbsp;                    if (xmpPdfExporter.exportToFileByPath(databaseContext, filePreferences, filePath, abbreviationRepository)) {</b>
<b class="nc">&nbsp;                        System.out.println(Localization.lang(&quot;Successfully written XMP metadata of at least one entry to %0.&quot;, filePath));</b>
&nbsp;                    } else {
<b class="nc">&nbsp;                        System.out.println(Localization.lang(&quot;File %0 is not linked to any entry in library.&quot;, filePath));</b>
&nbsp;                    }
&nbsp;                }
<b class="nc">&nbsp;                if (embeddBibfile) {</b>
<b class="nc">&nbsp;                    if (embeddedBibFilePdfExporter.exportToFileByPath(databaseContext, filePreferences, filePath, abbreviationRepository)) {</b>
<b class="nc">&nbsp;                        System.out.println(Localization.lang(&quot;Successfully embedded XMP metadata of at least one entry to %0.&quot;, filePath));</b>
&nbsp;                    } else {
<b class="nc">&nbsp;                        System.out.println(Localization.lang(&quot;File %0 is not linked to any entry in library.&quot;, filePath));</b>
&nbsp;                    }
&nbsp;                }
&nbsp;            } catch (IOException
&nbsp;                     | ParserConfigurationException
&nbsp;                     | SaveException
&nbsp;                     | TransformerException e) {
<b class="nc">&nbsp;                LOGGER.error(&quot;Error writing entry to {}.&quot;, filePath);</b>
&nbsp;            }
&nbsp;        }
&nbsp;    }
&nbsp;}
</code>
</pre>
</div>

<script type="text/javascript">
(function() {
    var msie = false, msie9 = false;
    /*@cc_on
      msie = true;
      @if (@_jscript_version >= 9)
        msie9 = true;
      @end
    @*/

    if (!msie || msie && msie9) {
      hljs.highlightAll()
      hljs.initLineNumbersOnLoad();
    }
})();
</script>

<div class="footer">
    
    <div style="float:right;">generated on 2025-09-29 22:51</div>
</div>
</body>
</html>
