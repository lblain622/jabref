


<!DOCTYPE html>
<html id="htmlId">
<head>
  <meta http-equiv="Content-Type" content="text/html;charset=UTF-8"> 
  <title>Coverage Report > GoogleScholar</title>
  <style type="text/css">
    @import "../../css/coverage.css";
    @import "../../css/idea.min.css";
  </style>
  <script type="text/javascript" src="../../js/highlight.min.js"></script>
  <script type="text/javascript" src="../../js/highlightjs-line-numbers.min.js"></script>
</head>

<body>
<div class="content">
<div class="breadCrumbs">
Current scope:     <a href="../../index.html">all classes</a>
    <span class="separator">|</span>
    <a href="../index.html">org.jabref.logic.importer.fetcher</a>
</div>

<h1>Coverage Summary for Class: GoogleScholar (org.jabref.logic.importer.fetcher)</h1>

<table class="coverageStats">
<tr>
  <th class="name">Class</th>
<th class="coverageStat 
">
  Class, %
</th>
<th class="coverageStat 
">
  Method, %
</th>
<th class="coverageStat 
">
  Branch, %
</th>
<th class="coverageStat 
">
  Line, %
</th>
</tr>
<tr>
  <td class="name">GoogleScholar</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/12)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/28)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/81)
  </span>
</td>
</tr>

</table>

<br/>
<br/>


<pre>
<code class="sourceCode" id="sourceCode">&nbsp;package org.jabref.logic.importer.fetcher;
&nbsp;
&nbsp;import java.io.IOException;
&nbsp;import java.io.Reader;
&nbsp;import java.net.HttpCookie;
&nbsp;import java.net.MalformedURLException;
&nbsp;import java.net.URISyntaxException;
&nbsp;import java.net.URL;
&nbsp;import java.util.ArrayList;
&nbsp;import java.util.Collection;
&nbsp;import java.util.List;
&nbsp;import java.util.Objects;
&nbsp;import java.util.Optional;
&nbsp;import java.util.regex.Matcher;
&nbsp;import java.util.regex.Pattern;
&nbsp;
&nbsp;import org.jabref.logic.help.HelpFile;
&nbsp;import org.jabref.logic.importer.FetcherException;
&nbsp;import org.jabref.logic.importer.FulltextFetcher;
&nbsp;import org.jabref.logic.importer.ImportFormatPreferences;
&nbsp;import org.jabref.logic.importer.PagedSearchBasedFetcher;
&nbsp;import org.jabref.logic.importer.ParserResult;
&nbsp;import org.jabref.logic.importer.fetcher.transformers.ScholarQueryTransformer;
&nbsp;import org.jabref.logic.importer.fileformat.BibtexParser;
&nbsp;import org.jabref.logic.l10n.Localization;
&nbsp;import org.jabref.logic.net.URLDownload;
&nbsp;import org.jabref.logic.util.URLUtil;
&nbsp;import org.jabref.model.entry.BibEntry;
&nbsp;import org.jabref.model.entry.field.StandardField;
&nbsp;import org.jabref.model.paging.Page;
&nbsp;import org.jabref.model.search.query.BaseQueryNode;
&nbsp;
&nbsp;import org.apache.hc.core5.net.URIBuilder;
&nbsp;import org.jsoup.Jsoup;
&nbsp;import org.jsoup.nodes.Document;
&nbsp;import org.jsoup.select.Elements;
&nbsp;import org.slf4j.Logger;
&nbsp;import org.slf4j.LoggerFactory;
&nbsp;
&nbsp;/**
&nbsp; * FulltextFetcher implementation that attempts to find a PDF URL at GoogleScholar.
&nbsp; * &lt;p&gt;
&nbsp; * Search String infos: https://scholar.google.com/intl/en/scholar/help.html#searching
&nbsp; */
&nbsp;public class GoogleScholar implements FulltextFetcher, PagedSearchBasedFetcher {
<b class="nc">&nbsp;    private static final Logger LOGGER = LoggerFactory.getLogger(GoogleScholar.class);</b>
&nbsp;
<b class="nc">&nbsp;    private static final Pattern LINK_TO_BIB_PATTERN = Pattern.compile(&quot;(https:\\/\\/scholar.googleusercontent.com\\/scholar.bib[^\&quot;]*)&quot;);</b>
&nbsp;
&nbsp;    private static final String BASIC_SEARCH_URL = &quot;https://scholar.google.ch/scholar?&quot;;
&nbsp;
&nbsp;    private static final int NUM_RESULTS = 10;
&nbsp;
&nbsp;    private final ImportFormatPreferences importFormatPreferences;
&nbsp;
<b class="nc">&nbsp;    public GoogleScholar(ImportFormatPreferences importFormatPreferences) {</b>
<b class="nc">&nbsp;        Objects.requireNonNull(importFormatPreferences);</b>
<b class="nc">&nbsp;        this.importFormatPreferences = importFormatPreferences;</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public Optional&lt;URL&gt; findFullText(BibEntry entry) throws IOException, FetcherException {
<b class="nc">&nbsp;        Objects.requireNonNull(entry);</b>
&nbsp;
&nbsp;        // Search in title
<b class="nc">&nbsp;        if (!entry.hasField(StandardField.TITLE)) {</b>
<b class="nc">&nbsp;            return Optional.empty();</b>
&nbsp;        }
&nbsp;
&nbsp;        try {
&nbsp;            // title search
<b class="nc">&nbsp;            URIBuilder uriBuilder = new URIBuilder(BASIC_SEARCH_URL);</b>
<b class="nc">&nbsp;            uriBuilder.addParameter(&quot;as_q&quot;, &quot;&quot;);</b>
&nbsp;            // as_epq as exact phrase
<b class="nc">&nbsp;            uriBuilder.addParameter(&quot;as_epq&quot;, entry.getField(StandardField.TITLE).orElse(&quot;&quot;));</b>
&nbsp;            // as_occt field to search in
<b class="nc">&nbsp;            uriBuilder.addParameter(&quot;as_occt&quot;, &quot;title&quot;);</b>
&nbsp;
<b class="nc">&nbsp;            return search(uriBuilder.toString());</b>
&nbsp;        } catch (URISyntaxException e) {
<b class="nc">&nbsp;            throw new FetcherException(&quot;Building URI failed.&quot;, e);</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public TrustLevel getTrustLevel() {
<b class="nc">&nbsp;        return TrustLevel.META_SEARCH;</b>
&nbsp;    }
&nbsp;
&nbsp;    private Optional&lt;URL&gt; search(String url) throws IOException {
<b class="nc">&nbsp;        Optional&lt;URL&gt; pdfLink = Optional.empty();</b>
&nbsp;
<b class="nc">&nbsp;        Document doc = Jsoup.connect(url).userAgent(URLDownload.USER_AGENT).get();</b>
&nbsp;
<b class="nc">&nbsp;        if (needsCaptcha(doc.body().html())) {</b>
<b class="nc">&nbsp;            LOGGER.warn(&quot;Hit Google traffic limitation. Captcha prevents automatic fetching.&quot;);</b>
<b class="nc">&nbsp;            return Optional.empty();</b>
&nbsp;        }
&nbsp;        // Check results for PDF link
&nbsp;        // TODO: link always on first result or none?
<b class="nc">&nbsp;        for (int i = 0; i &lt; NUM_RESULTS; i++) {</b>
<b class="nc">&nbsp;            Elements link = doc.select(&quot;div[data-rp=%S] div.gs_or_ggsm a&quot;.formatted(i));</b>
&nbsp;
<b class="nc">&nbsp;            if (link.first() != null) {</b>
<b class="nc">&nbsp;                String target = link.first().attr(&quot;href&quot;);</b>
&nbsp;                // link present?
<b class="nc">&nbsp;                if (!target.isEmpty() &amp;&amp; new URLDownload(target).isPdf()) {</b>
&nbsp;                    // TODO: check title inside pdf + length?
&nbsp;                    // TODO: report error function needed?! query -&gt; result
<b class="nc">&nbsp;                    LOGGER.info(&quot;Fulltext PDF found @ Google: {}&quot;, target);</b>
<b class="nc">&nbsp;                    pdfLink = Optional.of(URLUtil.create(target));</b>
&nbsp;                    break;
&nbsp;                }
&nbsp;            }
&nbsp;        }
<b class="nc">&nbsp;        return pdfLink;</b>
&nbsp;    }
&nbsp;
&nbsp;    private boolean needsCaptcha(String body) {
<b class="nc">&nbsp;        return body.contains(&quot;id=\&quot;gs_captcha_ccl\&quot;&quot;);</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public String getName() {
<b class="nc">&nbsp;        return &quot;Google Scholar&quot;;</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public Optional&lt;HelpFile&gt; getHelpPage() {
<b class="nc">&nbsp;        return Optional.of(HelpFile.FETCHER_GOOGLE_SCHOLAR);</b>
&nbsp;    }
&nbsp;
&nbsp;    private void addHitsFromQuery(List&lt;BibEntry&gt; entryList, String queryURL) throws IOException, FetcherException {
<b class="nc">&nbsp;        String content = new URLDownload(queryURL).asString();</b>
&nbsp;
<b class="nc">&nbsp;        if (needsCaptcha(content)) {</b>
&nbsp;            // TODO: Remove &quot;null&quot;
<b class="nc">&nbsp;            throw new FetcherException(queryURL, &quot;Fetching from Google Scholar failed: Captacha hit.&quot; +</b>
<b class="nc">&nbsp;                    Localization.lang(&quot;This might be caused by reaching the traffic limitation of Google Scholar (see &#39;Help&#39; for details).&quot;), null);</b>
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        Matcher matcher = LINK_TO_BIB_PATTERN.matcher(content);</b>
<b class="nc">&nbsp;        while (matcher.find()) {</b>
<b class="nc">&nbsp;            String citationsPageURL = matcher.group().replace(&quot;&amp;amp;&quot;, &quot;&amp;&quot;);</b>
<b class="nc">&nbsp;            BibEntry newEntry = downloadEntry(citationsPageURL);</b>
<b class="nc">&nbsp;            entryList.add(newEntry);</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    private BibEntry downloadEntry(String link) throws IOException, FetcherException {
<b class="nc">&nbsp;        String downloadedContent = new URLDownload(link).asString();</b>
<b class="nc">&nbsp;        BibtexParser parser = new BibtexParser(importFormatPreferences);</b>
<b class="nc">&nbsp;        ParserResult result = parser.parse(Reader.of(downloadedContent));</b>
<b class="nc">&nbsp;        if ((result == null) || (result.getDatabase() == null)) {</b>
<b class="nc">&nbsp;            throw new FetcherException(&quot;Parsing entries from Google Scholar bib file failed.&quot;);</b>
&nbsp;        } else {
<b class="nc">&nbsp;            Collection&lt;BibEntry&gt; entries = result.getDatabase().getEntries();</b>
<b class="nc">&nbsp;            if (entries.size() != 1) {</b>
<b class="nc">&nbsp;                LOGGER.debug(&quot;{} entries found! ({})&quot;, entries.size(), link);</b>
<b class="nc">&nbsp;                throw new FetcherException(&quot;Parsing entries from Google Scholar bib file failed.&quot;);</b>
&nbsp;            } else {
<b class="nc">&nbsp;                BibEntry entry = entries.iterator().next();</b>
<b class="nc">&nbsp;                return entry;</b>
&nbsp;            }
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    private void obtainAndModifyCookie() throws FetcherException {
&nbsp;        try {
<b class="nc">&nbsp;            URLDownload downloader = new URLDownload(&quot;https://scholar.google.com&quot;);</b>
<b class="nc">&nbsp;            List&lt;HttpCookie&gt; cookies = downloader.getCookieFromUrl();</b>
<b class="nc">&nbsp;            for (HttpCookie cookie : cookies) {</b>
&nbsp;                // append &quot;CF=4&quot; which represents &quot;Citation format bibtex&quot;
<b class="nc">&nbsp;                cookie.setValue(cookie.getValue() + &quot;:CF=4&quot;);</b>
&nbsp;            }
&nbsp;        } catch (IOException e) {
<b class="nc">&nbsp;            throw new FetcherException(&quot;Cookie configuration for Google Scholar failed.&quot;, e);</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public Page&lt;BibEntry&gt; performSearchPaged(BaseQueryNode queryNode, int pageNumber) throws FetcherException {
<b class="nc">&nbsp;        ScholarQueryTransformer queryTransformer = new ScholarQueryTransformer();</b>
<b class="nc">&nbsp;        String transformedQuery = queryTransformer.transformSearchQuery(queryNode).orElse(&quot;&quot;);</b>
&nbsp;
<b class="nc">&nbsp;        obtainAndModifyCookie();</b>
&nbsp;
&nbsp;        URIBuilder uriBuilder;
&nbsp;        try {
<b class="nc">&nbsp;            uriBuilder = new URIBuilder(BASIC_SEARCH_URL);</b>
&nbsp;        } catch (URISyntaxException e) {
<b class="nc">&nbsp;            throw new FetcherException(&quot;Building URI failed.&quot;, e);</b>
&nbsp;        }
<b class="nc">&nbsp;        uriBuilder.addParameter(&quot;hl&quot;, &quot;en&quot;);</b>
<b class="nc">&nbsp;        uriBuilder.addParameter(&quot;btnG&quot;, &quot;Search&quot;);</b>
<b class="nc">&nbsp;        uriBuilder.addParameter(&quot;q&quot;, transformedQuery);</b>
<b class="nc">&nbsp;        uriBuilder.addParameter(&quot;start&quot;, String.valueOf(pageNumber * getPageSize()));</b>
<b class="nc">&nbsp;        uriBuilder.addParameter(&quot;num&quot;, String.valueOf(getPageSize()));</b>
<b class="nc">&nbsp;        uriBuilder.addParameter(&quot;as_ylo&quot;, String.valueOf(queryTransformer.getStartYear()));</b>
<b class="nc">&nbsp;        uriBuilder.addParameter(&quot;as_yhi&quot;, String.valueOf(queryTransformer.getEndYear()));</b>
&nbsp;
<b class="nc">&nbsp;        List&lt;BibEntry&gt; foundEntries = new ArrayList&lt;&gt;(10);</b>
&nbsp;
&nbsp;        try {
<b class="nc">&nbsp;            addHitsFromQuery(foundEntries, uriBuilder.toString());</b>
<b class="nc">&nbsp;            if (foundEntries.size() == 10) {</b>
<b class="nc">&nbsp;                uriBuilder.addParameter(&quot;start&quot;, &quot;10&quot;);</b>
<b class="nc">&nbsp;                addHitsFromQuery(foundEntries, uriBuilder.toString());</b>
&nbsp;            }
&nbsp;        } catch (IOException e) {
<b class="nc">&nbsp;            LOGGER.info(&quot;IOException for URL {}&quot;, uriBuilder);</b>
&nbsp;            // if there are too much requests from the same IP adress google is answering with a 503 and redirecting to a captcha challenge
&nbsp;            // The caught IOException looks for example like this:
&nbsp;            // java.io.IOException: Server returned HTTP response code: 503 for URL: https://ipv4.google.com/sorry/index?continue=https://scholar.google.com/scholar%3Fhl%3Den%26btnG%3DSearch%26q%3Dbpmn&amp;hl=en&amp;q=CGMSBI0NBDkYuqy9wAUiGQDxp4NLQCWbIEY1HjpH5zFJhv4ANPGdWj0
<b class="nc">&nbsp;            if (e.getMessage().contains(&quot;Server returned HTTP response code: 503 for URL&quot;)) {</b>
<b class="nc">&nbsp;                throw new FetcherException(&quot;Fetching from Google Scholar failed.&quot;,</b>
<b class="nc">&nbsp;                        Localization.lang(&quot;This might be caused by reaching the traffic limitation of Google Scholar (see &#39;Help&#39; for details).&quot;), e);</b>
&nbsp;            } else {
&nbsp;                URL url;
&nbsp;                try {
<b class="nc">&nbsp;                    url = uriBuilder.build().toURL();</b>
&nbsp;                } catch (URISyntaxException | MalformedURLException ex) {
<b class="nc">&nbsp;                    throw new FetcherException(&quot;Wrong URL syntax&quot;, e);</b>
&nbsp;                }
<b class="nc">&nbsp;                throw new FetcherException(url, &quot;Error while fetching from &quot; + getName(), e);</b>
&nbsp;            }
&nbsp;        }
<b class="nc">&nbsp;        return new Page&lt;&gt;(transformedQuery, pageNumber, foundEntries);</b>
&nbsp;    }
&nbsp;}
</code>
</pre>
</div>

<script type="text/javascript">
(function() {
    var msie = false, msie9 = false;
    /*@cc_on
      msie = true;
      @if (@_jscript_version >= 9)
        msie9 = true;
      @end
    @*/

    if (!msie || msie && msie9) {
      hljs.highlightAll()
      hljs.initLineNumbersOnLoad();
    }
})();
</script>

<div class="footer">
    
    <div style="float:right;">generated on 2025-09-29 22:51</div>
</div>
</body>
</html>
