


<!DOCTYPE html>
<html id="htmlId">
<head>
  <meta http-equiv="Content-Type" content="text/html;charset=UTF-8"> 
  <title>Coverage Report > CrossRef</title>
  <style type="text/css">
    @import "../../css/coverage.css";
    @import "../../css/idea.min.css";
  </style>
  <script type="text/javascript" src="../../js/highlight.min.js"></script>
  <script type="text/javascript" src="../../js/highlightjs-line-numbers.min.js"></script>
</head>

<body>
<div class="content">
<div class="breadCrumbs">
Current scope:     <a href="../../index.html">all classes</a>
    <span class="separator">|</span>
    <a href="../index.html">org.jabref.logic.importer.fetcher</a>
</div>

<h1>Coverage Summary for Class: CrossRef (org.jabref.logic.importer.fetcher)</h1>

<table class="coverageStats">
<tr>
  <th class="name">Class</th>
<th class="coverageStat 
">
  Class, %
</th>
<th class="coverageStat 
">
  Method, %
</th>
<th class="coverageStat 
">
  Branch, %
</th>
<th class="coverageStat 
">
  Line, %
</th>
</tr>
<tr>
  <td class="name">CrossRef</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/18)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/24)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/89)
  </span>
</td>
</tr>

</table>

<br/>
<br/>


<pre>
<code class="sourceCode" id="sourceCode">&nbsp;package org.jabref.logic.importer.fetcher;
&nbsp;
&nbsp;import java.net.MalformedURLException;
&nbsp;import java.net.URISyntaxException;
&nbsp;import java.net.URL;
&nbsp;import java.util.ArrayList;
&nbsp;import java.util.List;
&nbsp;import java.util.Optional;
&nbsp;import java.util.stream.IntStream;
&nbsp;
&nbsp;import org.jabref.logic.cleanup.FieldFormatterCleanup;
&nbsp;import org.jabref.logic.formatter.bibtexfields.ClearFormatter;
&nbsp;import org.jabref.logic.formatter.bibtexfields.RemoveEnclosingBracesFormatter;
&nbsp;import org.jabref.logic.help.HelpFile;
&nbsp;import org.jabref.logic.importer.EntryBasedParserFetcher;
&nbsp;import org.jabref.logic.importer.IdBasedParserFetcher;
&nbsp;import org.jabref.logic.importer.IdParserFetcher;
&nbsp;import org.jabref.logic.importer.ParseException;
&nbsp;import org.jabref.logic.importer.Parser;
&nbsp;import org.jabref.logic.importer.SearchBasedParserFetcher;
&nbsp;import org.jabref.logic.importer.fetcher.transformers.DefaultQueryTransformer;
&nbsp;import org.jabref.logic.importer.util.JsonReader;
&nbsp;import org.jabref.logic.util.strings.StringSimilarity;
&nbsp;import org.jabref.model.entry.Author;
&nbsp;import org.jabref.model.entry.AuthorList;
&nbsp;import org.jabref.model.entry.BibEntry;
&nbsp;import org.jabref.model.entry.field.StandardField;
&nbsp;import org.jabref.model.entry.identifier.DOI;
&nbsp;import org.jabref.model.entry.types.EntryType;
&nbsp;import org.jabref.model.entry.types.StandardEntryType;
&nbsp;import org.jabref.model.search.query.BaseQueryNode;
&nbsp;import org.jabref.model.util.OptionalUtil;
&nbsp;
&nbsp;import kong.unirest.core.json.JSONArray;
&nbsp;import kong.unirest.core.json.JSONException;
&nbsp;import kong.unirest.core.json.JSONObject;
&nbsp;import org.apache.hc.core5.net.URIBuilder;
&nbsp;
&nbsp;/**
&nbsp; * A class for fetching DOIs from CrossRef
&nbsp; * &lt;p&gt;
&nbsp; * See &lt;a href=&quot;https://github.com/CrossRef/rest-api-doc&quot;&gt;their GitHub page&lt;/a&gt; for documentation.
&nbsp; */
<b class="nc">&nbsp;public class CrossRef implements IdParserFetcher&lt;DOI&gt;, EntryBasedParserFetcher, SearchBasedParserFetcher, IdBasedParserFetcher {</b>
&nbsp;
&nbsp;    private static final String API_URL = &quot;https://api.crossref.org/works&quot;;
&nbsp;
<b class="nc">&nbsp;    private static final RemoveEnclosingBracesFormatter REMOVE_BRACES_FORMATTER = new RemoveEnclosingBracesFormatter();</b>
&nbsp;
&nbsp;    @Override
&nbsp;    public String getName() {
<b class="nc">&nbsp;        return &quot;Crossref&quot;;</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public Optional&lt;HelpFile&gt; getHelpPage() {
<b class="nc">&nbsp;        return Optional.of(HelpFile.FETCHER_CROSSREF);</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public URL getURLForEntry(BibEntry entry) throws URISyntaxException, MalformedURLException {
<b class="nc">&nbsp;        URIBuilder uriBuilder = new URIBuilder(API_URL);</b>
<b class="nc">&nbsp;        entry.getFieldLatexFree(StandardField.TITLE).ifPresent(title -&gt; uriBuilder.addParameter(&quot;query.bibliographic&quot;, title));</b>
<b class="nc">&nbsp;        entry.getFieldLatexFree(StandardField.AUTHOR).ifPresent(author -&gt; uriBuilder.addParameter(&quot;query.author&quot;, author));</b>
<b class="nc">&nbsp;        entry.getFieldLatexFree(StandardField.YEAR).ifPresent(year -&gt;</b>
<b class="nc">&nbsp;                uriBuilder.addParameter(&quot;filter&quot;, &quot;from-pub-date:&quot; + year)</b>
&nbsp;        );
<b class="nc">&nbsp;        uriBuilder.addParameter(&quot;rows&quot;, &quot;20&quot;); // = API default</b>
<b class="nc">&nbsp;        uriBuilder.addParameter(&quot;offset&quot;, &quot;0&quot;); // start at beginning</b>
<b class="nc">&nbsp;        return uriBuilder.build().toURL();</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public URL getURLForQuery(BaseQueryNode queryNode) throws URISyntaxException, MalformedURLException {
<b class="nc">&nbsp;        URIBuilder uriBuilder = new URIBuilder(API_URL);</b>
<b class="nc">&nbsp;        uriBuilder.addParameter(&quot;query&quot;, new DefaultQueryTransformer().transformSearchQuery(queryNode).orElse(&quot;&quot;));</b>
<b class="nc">&nbsp;        return uriBuilder.build().toURL();</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public URL getUrlForIdentifier(String identifier) throws URISyntaxException, MalformedURLException {
<b class="nc">&nbsp;        URIBuilder uriBuilder = new URIBuilder(API_URL + &quot;/&quot; + identifier);</b>
<b class="nc">&nbsp;        return uriBuilder.build().toURL();</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public Parser getParser() {
<b class="nc">&nbsp;        return inputStream -&gt; {</b>
<b class="nc">&nbsp;            JSONObject response = JsonReader.toJsonObject(inputStream);</b>
<b class="nc">&nbsp;            if (response.isEmpty()) {</b>
<b class="nc">&nbsp;                return List.of();</b>
&nbsp;            }
&nbsp;
<b class="nc">&nbsp;            response = response.getJSONObject(&quot;message&quot;);</b>
<b class="nc">&nbsp;            if (response.isEmpty()) {</b>
<b class="nc">&nbsp;                return List.of();</b>
&nbsp;            }
&nbsp;
<b class="nc">&nbsp;            if (!response.has(&quot;items&quot;)) {</b>
&nbsp;                // Singleton response
<b class="nc">&nbsp;                BibEntry entry = jsonItemToBibEntry(response);</b>
<b class="nc">&nbsp;                return List.of(entry);</b>
&nbsp;            }
&nbsp;
&nbsp;            // Response contains a list
<b class="nc">&nbsp;            JSONArray items = response.getJSONArray(&quot;items&quot;);</b>
<b class="nc">&nbsp;            List&lt;BibEntry&gt; entries = new ArrayList&lt;&gt;(items.length());</b>
<b class="nc">&nbsp;            for (int i = 0; i &lt; items.length(); i++) {</b>
<b class="nc">&nbsp;                JSONObject item = items.getJSONObject(i);</b>
<b class="nc">&nbsp;                BibEntry entry = jsonItemToBibEntry(item);</b>
<b class="nc">&nbsp;                entries.add(entry);</b>
&nbsp;            }
<b class="nc">&nbsp;            return entries;</b>
&nbsp;        };
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public void doPostCleanup(BibEntry entry) {
&nbsp;        // Sometimes the fetched entry returns the title also in the subtitle field; in this case only keep the title field
<b class="nc">&nbsp;        if (entry.getField(StandardField.TITLE).equals(entry.getField(StandardField.SUBTITLE))) {</b>
<b class="nc">&nbsp;            new FieldFormatterCleanup(StandardField.SUBTITLE, new ClearFormatter()).cleanup(entry);</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    private BibEntry jsonItemToBibEntry(JSONObject item) throws ParseException {
&nbsp;        try {
<b class="nc">&nbsp;            BibEntry entry = new BibEntry();</b>
<b class="nc">&nbsp;            entry.setType(convertType(item.getString(&quot;type&quot;)));</b>
<b class="nc">&nbsp;            entry.setField(StandardField.TITLE,</b>
<b class="nc">&nbsp;                    Optional.ofNullable(item.optJSONArray(&quot;title&quot;))</b>
<b class="nc">&nbsp;                            .map(array -&gt; array.optString(0)).orElse(&quot;&quot;));</b>
<b class="nc">&nbsp;            entry.setField(StandardField.SUBTITLE,</b>
<b class="nc">&nbsp;                    Optional.ofNullable(item.optJSONArray(&quot;subtitle&quot;))</b>
<b class="nc">&nbsp;                            .map(array -&gt; array.optString(0)).orElse(&quot;&quot;));</b>
<b class="nc">&nbsp;            entry.setField(StandardField.AUTHOR, toAuthors(item.optJSONArray(&quot;author&quot;)));</b>
<b class="nc">&nbsp;            entry.setField(StandardField.YEAR,</b>
<b class="nc">&nbsp;                    Optional.ofNullable(item.optJSONObject(&quot;published-print&quot;))</b>
<b class="nc">&nbsp;                            .map(array -&gt; array.optJSONArray(&quot;date-parts&quot;))</b>
<b class="nc">&nbsp;                            .map(array -&gt; array.optJSONArray(0))</b>
<b class="nc">&nbsp;                            .map(array -&gt; array.optInt(0))</b>
<b class="nc">&nbsp;                            .map(year -&gt; Integer.toString(year)).orElse(&quot;&quot;)</b>
&nbsp;            );
<b class="nc">&nbsp;            entry.setField(StandardField.DOI, item.getString(&quot;DOI&quot;));</b>
<b class="nc">&nbsp;            entry.setField(StandardField.JOURNAL, item.optString(&quot;container-title&quot;));</b>
<b class="nc">&nbsp;            entry.setField(StandardField.PUBLISHER, item.optString(&quot;publisher&quot;));</b>
<b class="nc">&nbsp;            entry.setField(StandardField.NUMBER, item.optString(&quot;issue&quot;));</b>
<b class="nc">&nbsp;            entry.setField(StandardField.KEYWORDS, Optional.ofNullable(item.optJSONArray(&quot;subject&quot;)).map(this::getKeywords).orElse(&quot;&quot;));</b>
<b class="nc">&nbsp;            entry.setField(StandardField.PAGES, item.optString(&quot;page&quot;));</b>
<b class="nc">&nbsp;            entry.setField(StandardField.VOLUME, item.optString(&quot;volume&quot;));</b>
<b class="nc">&nbsp;            entry.setField(StandardField.ISSN, Optional.ofNullable(item.optJSONArray(&quot;ISSN&quot;)).map(array -&gt; array.getString(0)).orElse(&quot;&quot;));</b>
<b class="nc">&nbsp;            return entry;</b>
&nbsp;        } catch (JSONException exception) {
<b class="nc">&nbsp;            throw new ParseException(&quot;CrossRef API JSON format has changed&quot;, exception);</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    private String toAuthors(JSONArray authors) {
<b class="nc">&nbsp;        if (authors == null) {</b>
<b class="nc">&nbsp;            return &quot;&quot;;</b>
&nbsp;        }
&nbsp;
&nbsp;        // input: list of {&quot;given&quot;:&quot;A.&quot;,&quot;family&quot;:&quot;Riel&quot;,&quot;affiliation&quot;:[]}
<b class="nc">&nbsp;        return IntStream.range(0, authors.length())</b>
<b class="nc">&nbsp;                        .mapToObj(authors::getJSONObject)</b>
<b class="nc">&nbsp;                        .map(author -&gt; new Author(</b>
<b class="nc">&nbsp;                                author.optString(&quot;given&quot;, &quot;&quot;), &quot;&quot;, &quot;&quot;,</b>
<b class="nc">&nbsp;                                author.optString(&quot;family&quot;, &quot;&quot;), &quot;&quot;))</b>
<b class="nc">&nbsp;                        .collect(AuthorList.collect())</b>
<b class="nc">&nbsp;                        .getAsFirstLastNamesWithAnd();</b>
&nbsp;    }
&nbsp;
&nbsp;    private EntryType convertType(String type) {
<b class="nc">&nbsp;        return &quot;journal-article&quot;.equals(type) ? StandardEntryType.Article : StandardEntryType.Misc;</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public Optional&lt;DOI&gt; extractIdentifier(BibEntry inputEntry, List&lt;BibEntry&gt; fetchedEntries) {
<b class="nc">&nbsp;        final String entryTitle = REMOVE_BRACES_FORMATTER.format(inputEntry.getFieldLatexFree(StandardField.TITLE).orElse(&quot;&quot;));</b>
<b class="nc">&nbsp;        final StringSimilarity stringSimilarity = new StringSimilarity();</b>
&nbsp;
<b class="nc">&nbsp;        for (BibEntry fetchedEntry : fetchedEntries) {</b>
&nbsp;            // currently only title-based comparison
&nbsp;            // title
<b class="nc">&nbsp;            Optional&lt;String&gt; dataTitle = fetchedEntry.getField(StandardField.TITLE);</b>
&nbsp;
<b class="nc">&nbsp;            if (OptionalUtil.isPresentAnd(dataTitle, title -&gt; stringSimilarity.isSimilar(entryTitle, title))) {</b>
<b class="nc">&nbsp;                return fetchedEntry.getDOI();</b>
&nbsp;            }
&nbsp;
&nbsp;            // subtitle
&nbsp;            // additional check, as sometimes subtitle is needed but sometimes only duplicates the title
<b class="nc">&nbsp;            Optional&lt;String&gt; dataSubtitle = fetchedEntry.getField(StandardField.SUBTITLE);</b>
<b class="nc">&nbsp;            Optional&lt;String&gt; dataWithSubTitle = OptionalUtil.combine(dataTitle, dataSubtitle, (title, subtitle) -&gt; title + &quot; &quot; + subtitle);</b>
<b class="nc">&nbsp;            if (OptionalUtil.isPresentAnd(dataWithSubTitle, titleWithSubtitle -&gt; stringSimilarity.isSimilar(entryTitle, titleWithSubtitle))) {</b>
<b class="nc">&nbsp;                return fetchedEntry.getDOI();</b>
&nbsp;            }
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        return Optional.empty();</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public String getIdentifierName() {
<b class="nc">&nbsp;        return &quot;DOI&quot;;</b>
&nbsp;    }
&nbsp;
&nbsp;    private String getKeywords(JSONArray jsonArray) {
<b class="nc">&nbsp;        StringBuilder keywords = new StringBuilder();</b>
&nbsp;
<b class="nc">&nbsp;        for (int i = 0; i &lt; jsonArray.length(); i++) {</b>
<b class="nc">&nbsp;            keywords.append(jsonArray.getString(i));</b>
<b class="nc">&nbsp;            if (i != jsonArray.length() - 1) {</b>
<b class="nc">&nbsp;                keywords.append(&quot;, &quot;);</b>
&nbsp;            }
&nbsp;        }
<b class="nc">&nbsp;        return keywords.toString();</b>
&nbsp;    }
&nbsp;}
</code>
</pre>
</div>

<script type="text/javascript">
(function() {
    var msie = false, msie9 = false;
    /*@cc_on
      msie = true;
      @if (@_jscript_version >= 9)
        msie9 = true;
      @end
    @*/

    if (!msie || msie && msie9) {
      hljs.highlightAll()
      hljs.initLineNumbersOnLoad();
    }
})();
</script>

<div class="footer">
    
    <div style="float:right;">generated on 2025-09-29 22:51</div>
</div>
</body>
</html>
